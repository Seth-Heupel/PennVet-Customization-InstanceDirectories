/*============================================================================*/
/* Project........: PETRL */
/* File...........: InterfaceRaceCardTask .cs */
/* Company........: Thermo Fisher Scientific */
/* Author.........: Gary Walters */
/* Responsible....: Gary Walters */
/* eMail..........: gary.walters@thermofisher.com */
/* Portability....:  */
/* Document Ref...: */
/* Specification..: */
/* Status.........: [] In Work [] Test [ ] Ready for use [x] Released */
/*----------------------------------------------------------------------------*/
/* Created on.....: Oct 21 , 2019 */
/* Created by.....: Gary Walters */
/* Modified on....:  various , see below */
/* Modified by....:  GW*/
/* Version........: 1.0.0.0 */
/* Release date...: 12/11/2021  */
/*----------------------------------------------------------------------------*/
/* Purpose/Comments: */
/* Use with Form PETRL_RACE_CARD  */
/* 
 smp$race_card_folder  - reg key for temp folder for racetrack files 
 */

/*----------------------------------------------------------------------------*/
/* Modifications..: 
 Done  - Add config item Z_RACE_TRACK_JOB_LOGIN for  m_WorkFlowName = "Race Track Bkg Accession"*/
/* 10/12/2020 -  SpinEditRaceNum_NumberChanged - avoid reload on file import ( Causes refresh of form in web client 12.2.1 to freeze)
 * 10/13/2020 -   ParseFile - after CheckRaceEntry  Load check - fix logic( it was backwards for exit)
 *              also ParseFile   only refresh grid if RaceCardRC.Count > 0 ) Web client 12.2.1  performance
 *                  also race2.Count > 0  for refresh of  detail grid 
 * 10/19/2020 -  add m_InitLoad - not needed ?
 *              add SMMasterDetailGridRCSelection.CellEditor  color for gender - needed ?
 *              in BtnSpecimenReport_ClickAndWait - return if testing reasons null
 *              BtnSaveSelected_Click - set Suffix = IM if gender = m
 *              BtnImportRaceCard_ClickAndWait - Try catch around RaceExists and ParseFile -
 *                  had case of unhandled exception not caught elsewhere
 *  10/21/2020 - changes for microchipRacecards ( TB and SB )        
 *  11/14/2020 - in Btn_SaveClick - LaunchWF for Job login 
 *               in BtnAddSelected - check for dup animial ID in current set 
 *                changes for file formats shown below
 *  12/06/2020   various changes for double headers, update of race nums
 *  01/22/2021   prerace lasix - check
 *  03/04/2021   changes     in special and fair click buttons to allow file import if prompted 
 *               fix in BtnImportRaceCard_ClickAndWait  for save of pAccessionType to job -
 *                  structure for phrase was changed  from choose to phrase valid . 
 *                  also changed datatype to text (50) so that setPhrase would work 
 *                  use m_Accession_type , remove m_accession_typeID
 *                  PromptPhraseAccess_Typ_Leave will get current phrase ID , this is sent to Result file
 *   03/18/2021  Set job p_fair and p_race in improt race card and final save , new fields added to job
 *   03/19/2021  changes to fair and special code , add ResetReadOnlyGrid  for special and manual cases 
 *   03/23/2021  = add manual save buttons , change access_TYPE Phrase Race Track Samples to Race Day Samples
 *   04/11/2021  - major change to add PromptEntityBrowsePRace adn btnFindRace - to find race from prompt 
 *               -  Web client did not respons to PromptEntityBrowse same as thick client, need button btnFindRace to trigger
 *               - alos required changes in RaceExists, so all variations load ok 
 *               - change in LaunchWF  to record errors from WF login in Logger
 *   04/13/2021  -  change for IM to allow h c or r ,  don;t use m
 *   04/22/2021  - add m_FileLength to set expected file length for TB or SB race card
 *                  change the logic and parse file and RaceExists / create race - so an irregular file lenght will not abort the load 
 *                  testing revealed abort coudl cause the job sample point to be lost / not set 
 *   04/23/2021   - add check to SpinEditRaceNum_NumberChanged - prevent load of race # that does not exist ( Web client error )
 *                - add race card Notes to export file in FInal Save , also add error check for blank sample point
 *                - form changes, column for Horse , make Horse/Descriptino ,  change Age to Age/Yr ( age from TB, Yr from SB )
 *                - phrase test reason add CW - Claimed Winner 
 *                - BtnSpecimenReport_ClickAndWait - allow different report for specials, avoid gender check for specials
 *                       use new action PerformPvSpecialSpecimenWitnessRp, set report in the action 
 *                - btnSave Selected - //04/23/2021  add CW for C reason
 *                - add action PvDetBartReportAttach todo attach BtnDetBarnReport_ClickAndWait
 *   04/28/2021  - add suffixes for SPecials - in btnAddselected and BtnSaveSelected_Click  TODO - if ("1"=="1") remove later if working OK
 *                  BtnDetBarnReport_ClickAndWait  - give warning if specimen report not viewed / attached
 *   // 04/30/2021 - Final save  try general wf as background action on race - commit 
 *                  uses new action on P_RACE - PETRL_RACE_GENERAL_WF  in Race Lifecycle to add to wdt
 *                  add checks that animal ID is numeric.  allow for now, alos warn in save
 *                  change file name, add datetime created to make unique
 *                  comment out warning messages about errors in files, this locks up web client
 *   05/17/2021        add CW2 . CSP   to claimed test reasons
 *   //06/13/21  - - change so only confiscation 9  and misc 14 use special receipt report
 *   06/13/21  - move all _Click code to _ClickAndWait - except where form closes - btnExit and btnSave
 *   06/13/2021 - check for random empty sample point 
 *   07/01/2021   - changes in ParseFile and CheckParseFile to allow double microchip in TB cards
 *                 -  note double microchip in SB / harness card will cause error row to be entered
 *   07/17/2021 - changes in Actions on P_RACE_CARD LC, to send attach action as WDT task; to avoid key not found error
 *                  note attempts to sleep or refresh grids did not resolve KNF error.
 *   07/31/2021   check sampleing point, race date
 *   08/03/2021 - add sort to race card on animal id 
 *   08/06/2021 - check / set Job_name for added specimens
 *    *   08/11/2021 & 08/13/2021 - 
 *      in BtnAddSelectedManual_ClickAndWait , add prompt for specimen selection , use specimen count ( added to form ) to decide to add more speciments
 *           the + add button is disabled in the form .  also at end of this method , loop thru all active selections and check that specimen types ,etc set correctly
 *           also add that check to BtnAddSelected_ClickandWait
 *       exclude voided race cards from specimen report check 
 *       
 *    08/21/2021  -  check for attachments does not seem correct , does not reflect attachment was made
 *    10/07/2021 - add change for Oct 2021 TB file , with either 13 or 14 columns in header
 *    10/21/2021 - updates to Manual card add and save , should do Claimed and suffix setting same as not manual
 *    11/13/2021 -   new Deb request - Check for updated testing reasons - case when changed from Previous C
 *                  also add code to count # specimens  ( note RT cannot add specimens, code should add B and U if needed)
   12/10/2021   add Age column to form PETRLRaceCard - in form set Read Only = true for the import case
	in code - frm.SMMasterDetailGridRaceCard.Columns["Age"].ReadOnly = false for manual entry;
                    new Deb Request so that manual entry can input age
   12/11/2021 - in AddSelected for SPecimen query - , make criteria based on race)id and race_card_id instead 
                    of animalid , since animalid can be changed for various reasons
  * */



/*============================================================================*/
/*    file formats from Andy Bender andbender@pa.gov
 *    Standardbred Import file format - ho header 11 columns

"01","11/14/19","9P8510","STORM BORN          ","B  ","9P851","No chip on file","     ","Derek D Miller,Canonsburg,PA  ","KOZAR, NICHOLAS               ","16","M"
"01","11/14/19","0R7907","RAVENSACEOFDIAMOND  ","BR ","0R790","No chip on file","     ","Susan A Sickle,Clarksville,PA;","WHITE, STEPHEN                ","17","M"
"01","11/14/19","9LM430","IM IN LUV           ","B  ","9LM43","No chip on file","L    ","Growth Opportunities LLC,North","STRATTON, PETER               ","13","M"
"01","11/14/19","1P9739","WIND SUN N FIRE     ","B  ","1P973","No chip on file","L    ","Mikaela R Delgiudice,Scandia,M","MAGEE, RICHARD                ","16","G"
"01","11/14/19","0MN344","DEPRIVED            ","B  ","0MN34","No chip on file","L    ","M Amrick,St Mrys,PA;L Dipaolo,","MARASHIAN, MARCUS             ","14","M"
"01","11/14/19","0NA250","BAD BITTY           ","B  ","0NA25","No chip on file","     ","Micheal R Wallace,Washington,P","WALLACE, MICHEAL              ","15","M"


NOTE:
The Standardbred import file DOES NOT HAVE a header row as the first line in the file
The microchip info is in the middle of the line: column position 7
The file contains two Tattoo references (Column 3 and column 6).  The column six reference is the value imported into the Racing Application.
Column Order:
0 race_no
1 race_date
2 NOT USED
3 horse_name
4 color
5 horse_no
6 microchip
7 meds
8 ownerName
9 trainerName
10 age
11 gender

Thoroughbred Import file format - header line 

"Race Number","Race Date","Horse's Name","Tattoo Number","Color","Gender","Age","Medication","Owner","Trainer","Microchip"
"1","01/15/2020","Shackle Me Good","R07367","Ch","m","6","L","Take A Shot  LLC","Graci, Kimberly A",""
"1","01/15/2020","Roraima Dos","R11687","B","m","6","L","Fanelli, John","Bobadilla, Jose F.","981020031316433"
"1","01/15/2020","Nano Link","S12485","B","m","5","L","Schickedanz, Bruno","Johnston, Robert J.W.",""
"1","01/15/2020","Wolfblade","S10492","Ch","m","5","L","Flying Monkeys Stable","Martin, Sandee D.",""
"1","01/15/2020","Allison K","T16633","Dk B/ Br","f","4","L","AJ Will Win Stables, LLC","Kulp, Brandon L.","981020015738556"
"1","01/15/2020","Jerilyn Rocks","R15829","Ch","m","6","L","Short Straw Stable","Stites, Flint W.",""

NOTE:
The Thoroughbred import file HAS a header row as the first line in the file
The microchip info is at the end of the line: column position 11
0 Race Num 
1 race date
2 horse
3 tatto
4 Color
5 gender
6 age
7 meds
8 owner
9 trainer
10 microchip
 *    
 *    
 *    Original format
 *    Race	 Date	 Registration	 Horse Name	        color? 	 tatoo	 Pre-Race Lasix	Owner	                        Trainer	                age in years	 gender
      1	    8/26/2017	3E2823	    TREVOR WIN FOR US   B  	    300282	 L    	        Allard Racing Inc,Saint-Esprit	ALLARD, RENE              7	                G


OCt 2021 new TB file - note period between microchips is supposed to be fixed 
"Race Number","Race Date","Horse's Name","Tattoo Number","Color","Gender","Age","Medication","Owner","Trainer","Microchip"."Microchip2","TRPB Tattoo","TRPB Certified Digital Tattoo",
"1","09/28/2021","T Rex","","Ch","g","3","null","Rogers, Tyler","Rogers, Ronald W.","981020025199399","","","DT-18007524"
"1","09/28/2021","Ettaplace","U15707","Ch","f","4","L","Truman Prevatt and Aldana Gonzalez Racing, LLC","Gonzalez, Aldana","981020023276735","","",""
"1","09/28/2021","Runaway Star","U19962","Dk B/ Br","g","4","L","Lawrence Stable, Inc.","Lawrence, II, James L.","981020023491238","","",""
"1","09/28/2021","Magicstick","","Dk B/ Br","g","3","null","Leland J. Hayes","Hayes, Leland","981020025186188","","","DT-18008799"
"1","09/28/2021","Donaldson","","Dk B/ Br","g","3","L","Cheeks, Katy","Cheeks, Katy","981020027277815","","","DT-18020475"
"1","09/28/2021","Mac Ninety","","Dk B/ Br","g","3","L","Warriors Reward, LLC and Premier Stable","Girten, Tim","981020027283990","","","DT-18020690"
   
*/
using System;
using System.Collections.Generic;
using System.Collections;
using System.Globalization;
using System.Text;
using System.Text.RegularExpressions;
using System.IO;
using System.Windows.Forms;
using System.IO.Compression;
using System.Diagnostics;
using Microsoft.Win32;
using Thermo.SampleManager.Server;
using Thermo.SampleManager.Common.Data;
using Thermo.SampleManager.Common.Utilities;
using Thermo.SampleManager.Library.EntityDefinition;
using Thermo.SampleManager.Library.FormDefinition;
using Thermo.Framework.Core;
using Thermo.SampleManager.ObjectModel;
using Thermo.SampleManager.Library;
using Thermo.SampleManager.Tasks;
using Thermo.SampleManager.Library.ClientControls;
using Thermo.SampleManager.Library.ClientControls.Browse;
using Thermo.SampleManager.Core;

using Thermo.SampleManager.Server.Workflow.Attributes;
using Thermo.SampleManager.Server.Workflow.Definition;
using Thermo.SampleManager.Server.Workflow.Nodes;
using Thermo.SampleManager.Common.Workflow;
using Thermo.SampleManager.Server.Workflow;


//using static Thermo.Framework.Core.Message;

namespace Customization.Tasks
{
    [SampleManagerTask("PETRLRaceCardTask")]
    public class PETRLRaceCardTask : DefaultFormTask
    {
        private const string V = "";
        #region Variables
        private FormPETRLRaceCard frm;
        IDetailGrid mSpecimenGrid;
        private DateTime m_CurrentDate = System.DateTime.UtcNow.Date;
        // private DateTime m_FromDate = new DateTime(2014, 9, 1);
        private DateTime m_RaceDate = System.DateTime.UtcNow.Date;
        //  private string m_SamplePoint = "";
        private SamplePoint m_SamplePoint = new SamplePoint();
        private string m_SamplePointName = "";

        private int m_RaceNum = 0;
        private int m_NumberOfRaces = 0;
        private int m_RaceDateNum = 1;
        private int m_FileLength = 0;  //  04/22/2021
        private string m_DirName = "";
        private string m_DirNameArchive = "";
        private string m_Accession_type = "";  // this is phrase ID
                                               //   private string m_Accession_typeID = "";
                                               //  private PhraseBase m_Accession_phrase;
        private string m_Fair = "";
        private string m_RaceID = "";
        private bool m_RaceFound = false;
        private sbyte m_RaceBrowse = 0;

        private string m_JobName = "";
        // private string m_PostTime = "";
        //  private string m_JobSyntax = "RACETRKJOB";  // increment ACCESSION
        private PRaceCardBase m_RaceCard = new PRaceCardBase();
        private PRaceBase m_Race = new PRaceBase();

        private string m_WorkFlowName = "Race Track Bkg Accession";
        private string m_WorkFlowNameNRT = "Race Track Non Race Day Accession";
        private string m_JobWorkFlowName = "RaceTrackJob";
        private IDetailGrid SpecimenDetailGrid;  //added SCH 4-26-22 for Specimen row color change
                                                 // private int m_InitLoad = 0; // counter for Import file

        // private List<Object> m_AnimalIDs;
        /// </summary>
        #endregion

        #region FormMethods

        protected override void SetupTask()
        {
            base.SetupTask();


        }

        protected override void MainFormLoaded()
        {


            base.MainFormLoaded();
            frm = (FormPETRLRaceCard)MainForm;

            bool logenable = Logger.IsInfoEnabled;
            Logger.InfoFormat(frm.ToString() + " loaded , log enable = " + logenable.ToString(), "InterfaceRaceCardTask");
            IQuery qrySP = EntityManager.CreateQuery(TableNames.SamplePoint);
            bool haveOne = false;
            foreach (SamplePoint sp in Context.SelectedItems)
            {
                if (haveOne)
                    qrySP.AddOr();
                else
                    haveOne = true;
                qrySP.AddEquals(SamplePointPropertyNames.Identity, sp.Identity);

                m_SamplePoint = sp;
                m_SamplePointName = sp.Name.ToString();
            }

            // form events
            // frm.SMPromptSP.Value = m_SamplePointName;


            IQuery qryR = EntityManager.CreateQuery(TableNames.PRace);

            qryR.AddEquals("SAMPLING_POINT", m_SamplePoint.Identity);
            qryR.AddOrder("RACE_DATE", false);

            IEntityCollection recs = EntityManager.Select(TableNames.PRace, qryR);



            frm.EntityBrowsePRace.Republish(recs);

            //  frm.PromptEntityBrowsePRace.value = "";

            frm.PromptEntityBrowsePRace.EntityChanged += PromptEntityBrowsePRace_EntityChanged;
            frm.btnFindRace.Click += BtnFindRace_Click;

            //frm.PromptEntityBrowsePRace.ButtonClicked += PromptEntityBrowsePRace_ButtonClicked;

            //frm.PromptEntityBrowsePRace.Leave += PromptEntityBrowsePRace_Leave;



            m_RaceNum = 1;

            frm.SpinEditRaceNum.Number = m_RaceNum;

            frm.dateRaceDate.Date = m_RaceDate;

            /* frm.PromptPhraseAccess_Typ.Value = "Race Day Samples";*/  // set so form brows prompt displays this value
            m_Accession_type = "1";  // 1 = Race Track Samples

            // set phrase on browse  04/10/2021
            IQuery qryA = EntityManager.CreateQuery(TableNames.Phrase);
            qryA.AddEquals("PHRASE_TYPE", "ACCESS_TYP");
            qryA.AddAnd();
            qryA.AddEquals("PHRASE_ID", m_Accession_type);
            IEntityCollection a = EntityManager.Select(TableNames.Phrase, qryA);
            if (a.Count == 1)
            {
                frm.PromptPhraseAccess_Typ.Phrase = a[0];
            }



            //  frm.PromptPhraseFair.Value = "None";  04/13/2021
            frm.SpinEditRaceNum.NumberChanged += SpinEditRaceNum_NumberChanged;   // 

            frm.SpinEditRaceDateNo.NumberChanged += SpinEditRaceDateNo_NumberChanged;

            frm.cbxFindDH.CheckedChanged += CbxFindDH_CheckedChanged;

            //   frm.SpinEditRaceNum.Leave += SpinEditRaceNum_Leave;  // not needed

            frm.dateRaceDate.DateTimeChanged += DateRaceDate_DateTimeChanged;  // problems in web client, use SpinEditRaceNumChanged

            //frm.SMMasterDetailGridRCSelection.GridData.ItemPropertyChanged += GridData_ItemPropertyChanged;  //  Problems in Web CLient 
            // TODO - see if animal id needs to be chcked another way 



            frm.SMMasterDetailGridRCSelection.CellEditor += SMMasterDetailGridRCSelection_CellEditor;

            frm.SMMasterDetailGridRaceCard.RowAdded += SMMasterDetailGridRaceCard_RowAdded;


            //Seth added 4-12-22
            frm.SMMasterDetailGridRaceCard.CellEditor += SMMasterDetailGridRaceCard_CellEditor;
            //frm.SMMasterDetailGridRaceCard.FocusedRowChanged += SMMasterDetailGridRaceCard_FocusedRowChanged;

            //SCH added 4-26-22 for SPecimen row color change

            SpecimenDetailGrid = frm.SMMasterDetailGridRCSelection.FindDetailGrid("DetailGridSelection");
            SpecimenDetailGrid.CellEditor += SpecimenDetailGrid_CellEditor;

            //SCH added 6-1-22 for refresh after row is changed
            SpecimenDetailGrid.FocusedRowChanged += SpecimenDetailGrid_FocusedRowChanged;          //SCH 6-1-22 for color change refresh
            SpecimenDetailGrid.FocusedColumnChanged += SpecimenDetailGrid_FocusedColumnChanged;      //SCH 6-1-22 for color change refresh
            










            //  frm.SMMasterDetailGridRCSelection.RowAdded += SMMasterDetailGridRCSelection_RowAdded;
            //     frm.SMMasterDetailGridRCSelection.DetailGrids[0].RowAdded += PETRLRaceCardTask_RowAdded;   // this did not work , see code 

            frm.SMMasterDetailGridRCSelection.FocusedRowChanged += SMMasterDetailGridRCSelection_FocusedRowChanged;  //SCH 6-1-22 forcolor change refresh


            //  frm.txtPostTime.TextChanged += TxtPostTime_TextChanged;

            //   frm.SMMasterDetailGridRCSelection.CellEnabled += SMMasterDetailGridRCSelection_CellEnabled;
            frm.SMMasterDetailGridRCSelection.FocusedColumnChanged += SMMasterDetailGridRCSelection_FocusedColumnChanged;  //reactivated 6-1-22 for color change refresh




            frm.btnSave.Enabled = false;  //  disable until d barn report
                                          //button events



            frm.btnImportRaceCard.ClickAndWait += BtnImportRaceCard_ClickAndWait;  // Import

            frm.btnImportRaceCard.Click += BtnImportRaceCard_Click;

            frm.btnExit.Click += BtnExit_Click;


            frm.btnAddSelected.ClickAndWait += BtnAddSelected_ClickAndWait;

            frm.btnSave.Click += BtnSave_Click;  // final save
            frm.btnSave.ClickAndWait += BtnSave_ClickAndWait;

            //  frm.btnSaveSelected.Click += BtnSaveSelected_Click;   // Save Selected
            frm.btnSaveSelected.ClickAndWait += BtnSaveSelected_ClickAndWait;

            frm.btnAddFair.Click += BtnAddFair_Click;
            frm.btnAddFair.ClickAndWait += BtnAddFair_ClickAndWait;   // Add Fair

            //  frm.btnAddSpecial.Click += BtnAddSpecial_Click;    // AddSPecial
            frm.btnAddSpecial.ClickAndWait += BtnAddSpecial_ClickAndWait;

            //  frm.btnSaveManual.Click += BtnSaveManual_Click;    

            frm.btnSaveManual.ClickAndWait += BtnSaveManual_ClickAndWait;   // SaveManual

            //frm.cbxManualEntry.CheckedChanged += CbxManualEntry_CheckedChanged;

            //frm.btnEditJob.Click += BtnEditJob_Click;

            //frm.btnEditJob.ClickAndWait += BtnEditJob_ClickAndWait;

            frm.btnDetBarnReport.Click += BtnDetBarnReport_Click;   // Report - DetBarn
            frm.btnDetBarnReport.ClickAndWait += BtnDetBarnReport_ClickAndWait;
            // frm.btnSpecimenReport.Click += BtnSpecimenReport_Click;   

            frm.btnSpecimenReport.ClickAndWait += BtnSpecimenReport_ClickAndWait;   // Report - Specimen

            frm.PromptPhraseAccess_Typ.Leave += PromptPhraseAccess_Typ_Leave;
            frm.PromptPhraseFair.Leave += PromptPhraseFair_Leave;

            frm.btnAddSelectedManual.ClickAndWait += BtnAddSelectedManual_ClickAndWait;
            frm.btnSaveSelectedManual.ClickAndWait += BtnSaveSelectedManual_ClickAndWait;

            mSpecimenGrid = frm.SMMasterDetailGridRaceCard.FindDetailGrid("DetailGridSpecimens");

            m_DirName = System.IO.Path.GetTempPath();
            m_DirNameArchive = System.IO.Path.GetTempPath();
            try
            {

                m_DirName = Library.Environment.GetGlobalString("Z_RACE_TRACK_FILE");

                m_DirNameArchive = Library.Environment.GetGlobalString("Z_RACE_TRACK_FILE_ARCHIVE");
                // Library.Utils.FlashMessage(m_DirName, "Dir name for race track file");
            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage(m_DirName, "Using temp path , config items Z_RACE_TRACK_FILE or Z_RACE_TRACK_FILE_ARCHIVE not defined" + ex.ToString());

            }
            try
            {

                m_WorkFlowName = Library.Environment.GetGlobalString("Z_RACE_TRACK_JOB_LOGIN");


            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage(m_WorkFlowName, "Using Job login Race Track Bkg Accession , config items Z_RACE_TRACK_JOB_LOGIN not defined" + ex.ToString());

            }

            try
            {

                m_WorkFlowNameNRT = Library.Environment.GetGlobalString("Z_NRT_RACE_TRACK_JOB_LOGIN");


            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage(m_WorkFlowNameNRT, "Using Job login Non Race Track Bkg Accession , config items Z_NRT_RACE_TRACK_JOB_LOGIN not defined" + ex.ToString());

            }

            // m_InitLoad = 0;

            //Logger.Error("Launch Interface");

            //Logger logger = Logger.GetInstance(GetType());
            //logger.Error("Launch Interface 2");




        }

        private void SpecimenDetailGrid_FocusedColumnChanged(object sender, FocusedColumnChangedEventArgs e)
        {
            frm.SMMasterDetailGridRCSelection.Refresh();
            frm.SMMasterDetailGridRCSelection.GridData.Refresh();
            //frm.SMMasterDetailGridRCSelection.GridData.Reselect();
        

        }

        private void SpecimenDetailGrid_FocusedRowChanged(object sender, FocusedRowChangedEventArgs e)
        {
            frm.SMMasterDetailGridRCSelection.Refresh();
            frm.SMMasterDetailGridRCSelection.GridData.Refresh();



        }

        //private void SMMasterDetailGridRaceCard_FocusedRowChanged(object sender, FocusedRowChangedEventArgs e)
        //{
        //    frm.SMMasterDetailGridRaceCard.Refresh();
        //}


        private void SpecimenDetailGrid_CellEditor(object sender, CellEditorEventArgs e)
        {
            if ((e.Entity.GetString("CollectionTime") != "") && (e.Entity.GetString("TimeMerid") != "") && (e.Entity.GetString("CollectorName") != "") && (e.Entity.GetBoolean("AddSpecimen") == true) && (e.Entity.GetString("SpecimenType") == "U"))

            {
                e.BackColor = System.Drawing.Color.Yellow;
                e.ForeColor = System.Drawing.Color.Black;


            }
            else if ((e.Entity.GetString("CollectionTime") != "") && (e.Entity.GetString("TimeMerid") != "") && (e.Entity.GetString("CollectorName") != "") && (e.Entity.GetBoolean("AddSpecimen") == true) && (e.Entity.GetString("SpecimenType") == "B"))
            {
                e.BackColor = System.Drawing.Color.MediumVioletRed;
                e.ForeColor = System.Drawing.Color.WhiteSmoke;
            }
            else if ((e.Entity.GetString("CollectionTime") != "") && (e.Entity.GetString("TimeMerid") != "") && (e.Entity.GetString("CollectorName") != "") && (e.Entity.GetBoolean("AddSpecimen") == true) && (e.Entity.GetString("SpecimenType") != "B") && (e.Entity.GetString("SpecimenType") != "U"))
            {
                e.BackColor = System.Drawing.Color.Aquamarine;
                e.ForeColor = System.Drawing.Color.Black;
            }
            else
            {
                e.BackColor = System.Drawing.Color.White;
                e.ForeColor = System.Drawing.Color.Black;
            }
        }





        //Seth 4-12-22
        private void SMMasterDetailGridRaceCard_CellEditor(object sender, CellEditorEventArgs e)
        {
            if (e.Entity.GetBoolean("Selected") == true)
            {
                e.BackColor = System.Drawing.Color.DarkBlue;
                e.ForeColor = System.Drawing.Color.White;
            }
            if (e.Entity.GetBoolean("Selected") == false)
            {
                e.BackColor = System.Drawing.Color.White;
                e.ForeColor = System.Drawing.Color.Black;
            }


        }

        //End 











        //private void PromptEntityBrowsePRace_Leave(object sender, EventArgs e)
        //{
        //    if (e != null)
        //    {
        //       // string race_id = e.ToString();
        //        // m_RaceID
        //    }
        //    string race_id = frm.PromptEntityBrowsePRace.Property;
        //    race_id = frm.PromptEntityBrowsePRace.Value.ToString();
        //}

        //private void PromptEntityBrowsePRace_ButtonClicked(object sender, EventArgs e)
        //{
        //    if (e != null)
        //    {
        //       // string race_id = e.ToString();
        //        // m_RaceID
        //    }
        //    string race_id = frm.PromptEntityBrowsePRace.Property;
        //    race_id = frm.PromptEntityBrowsePRace.Value.ToString();
        //}

        private void PromptEntityBrowsePRace_EntityChanged(object sender, EntityChangedEventArgs e)
        {
            m_RaceBrowse++;




            if (m_RaceBrowse > 1)
            {
                string race_id = frm.PromptEntityBrowsePRace.Value.ToString();
                m_RaceID = race_id;

                frm.btnFindRace.Caption = "Find Race " + m_RaceID;
                frm.btnFindRace.Enabled = true;

            }



            //if (m_RaceBrowse > 2)
            //{
            //    string id = m_RaceID;

            //    Library.Utils.FlashMessage("Loading Race " + m_RaceID, m_RaceID);

            //    string race_id = frm.PromptEntityBrowsePRace.Value.ToString();
            //    m_RaceID = race_id;

            //    frm.txtRaceID.Value = m_RaceID;
            //    m_RaceFound = true;
            //    RaceExists(false);
            //    frm.PromptEntityBrowsePRace.Enabled = false;

            //    Library.Utils.FlashMessage("Complete Loading Race " + m_RaceID, m_RaceID);
            //}


        }

        private void PromptPhraseFair_Leave(object sender, EventArgs e)
        {
            m_Fair = frm.PromptPhraseFair.Value.ToString();
        }

        //private void CbxManualEntry_CheckedChanged(object sender, CheckEventArgs e)
        //{
        //    if ( frm.cbxManualEntry.Checked)
        //    {
        //        ResetReadOnlyGrid();
        //    }

        //}

        private void PromptPhraseAccess_Typ_Leave(object sender, EventArgs e)
        {
            // set accession_type   // need phrase id
            m_Accession_type = frm.PromptPhraseAccess_Typ.Value.ToString();  // phrase id of selected phrase




        }

        private void SMMasterDetailGridRCSelection_CellEditor(object sender, CellEditorEventArgs e)
        {
            int spectot = 0;
            int speccomp = 0;
            int speccomps = 0;

             spectot = e.Entity.GetEntityCollection("PSpecimens").ActiveCount;
             speccomp = e.Entity.GetEntityCollection("SpecimensWithCompleteCollectionData").ActiveCount;
             speccomps = e.Entity.GetEntityCollection("SpecimensNonVoided").ActiveCount;

            if (e.ColumnName == "Gender")
            {
                e.ForeColor = System.Drawing.Color.Red;

            }
            //if (e.Entity.GetEntityCollection("PSpecimens").ActiveCount.Equals(e.Entity.GetEntityCollection("SpecimensWithCompleteCollectionData").ActiveCount))
            //{
            //    e.BackColor = System.Drawing.Color.FromArgb(33, 179, 252);
            //    e.ForeColor = System.Drawing.Color.White;

            //}

            //Seth 4 - 12 - 22 row color change //8/31/22 update to add more fields
            if ((e.Entity.GetString("Witness") != "") && (e.Entity.GetString("TimeMerid") != "") && (e.Entity.GetString("TestingReasons") != "") && (e.Entity.GetBoolean("Void") != true) && e.Entity.GetEntityCollection("SpecimensWithCompleteCollectionData").ActiveCount.Equals(e.Entity.GetEntityCollection("SpecimensNonVoided").ActiveCount))
            //if ((e.Entity.GetString("Witness") != "") && (e.Entity.GetString("TimeMerid") != "") && (e.Entity.GetString("TestingReasons") != "") && (e.Entity.GetBoolean("Void") != true) && e.Entity.GetEntityCollection("PSpecimens").ActiveCount.Equals(e.Entity.GetEntityCollection("SpecimensWithCompleteCollectionData").ActiveCount))
            {
                e.BackColor = System.Drawing.Color.LawnGreen;
                if (e.ColumnName == "Gender")
                {
                    e.ForeColor = System.Drawing.Color.Red;

                }
                else
                {
                    e.ForeColor = System.Drawing.Color.Black;
                }



            }

            else if ((e.Entity.GetString("Witness") == "") && (e.Entity.GetString("TimeMerid") != "") && (e.Entity.GetString("TestingReasons") != "") && (e.Entity.GetBoolean("Void") != true) && e.Entity.GetEntityCollection("SpecimensWithCompleteCollectionData").ActiveCount.Equals(e.Entity.GetEntityCollection("SpecimensNonVoided").ActiveCount))
            {
                e.BackColor = System.Drawing.Color.White;

                if (e.ColumnName == "Gender")
                {
                    e.ForeColor = System.Drawing.Color.Red;

                }
                else
                {
                    e.ForeColor = System.Drawing.Color.Black;
                }
            }
            else if (e.Entity.GetBoolean("Void") == true)
            {
                e.BackColor = System.Drawing.Color.Red;
                if (e.ColumnName == "Gender")
                {
                    e.ForeColor = System.Drawing.Color.Yellow;

                }
                else
                {
                    e.ForeColor = System.Drawing.Color.White;
                }


            }
            else
            {
                e.BackColor = System.Drawing.Color.White;
                if (e.ColumnName == "Gender")
                {
                    e.ForeColor = System.Drawing.Color.Red;

                }
                else
                {
                    e.ForeColor = System.Drawing.Color.Black;
                }


            }







            //end row color change   

        }

        private void SMMasterDetailGridRCSelection_FocusedRowChanged(object sender, FocusedRowChangedEventArgs e)
        {
            m_RaceCard = (PRaceCardExtended)e.Entity;

            frm.SMMasterDetailGridRCSelection.Refresh();
            frm.SelectedCollection.Data.Reselect();

  
          

        }

        private void SMMasterDetailGridRCSelection_FocusedColumnChanged(object sender, FocusedColumnChangedEventArgs e)
        {
            if ((e.ColumnName == "Notes") && frm.cbxNotes.Checked)
            {
                Library.Utils.FlashMessage(e.Entity.ToString(), "Notes enabled");
            }

            frm.SMMasterDetailGridRCSelection.Refresh();
        }

        private void SMMasterDetailGridRCSelection_CellEnabled(object sender, CellEnabledEventArgs e)
        {
            if ((e.ColumnName == "Notes") && frm.cbxNotes.Checked)
            {
                Library.Utils.FlashMessage(e.Entity.ToString(), "Notes enabled");
            }
        }
        //private void TxtPostTime_TextChanged(object sender, TextChangedEventArgs e)
        //{
        //    m_PostTime = frm.txtPostTime.Text;
        //}
        /*
        private void SMMasterDetailGridRCSelection_CellEditor(object sender, CellEditorEventArgs e)
        {
            if ( e.HasFocus && (e.ColumnName == "Notes") && frm.cbxNotes.Checked)
            {
                PRaceCardBase p = (PRaceCardBase)e.Entity;
               // Sample s = (Sample)e.Entity;
                string txt = p.Notes.ToString();

                string pasteText = Library.Utils.PromptForMultilineText("Sample Information", "Notes", false, txt);
                if (pasteText != null)

                { p.Notes = pasteText; }

            }
        }
        */
        //private void SMMasterDetailGridRCSelection_RowAdded(object sender, RowAddedEventArgs e)
        //{
        //    e.Entity.SetField("SELECTED", true);
        //    bool add = true;
        //    string ent = e.Entity.Identity;
        //}



        //private void PETRLRaceCardTask_RowAdded(object sender, RowAddedEventArgs e)
        //{

        //    // for some unknonw reason , the prompt returnbelow  does not work right on a row  added with + ( green ) button
        //    // this code commented out , but leave so I know not to try this again

        //    bool add = true;
        //    string ent = e.Entity.Identity;
        //    // get race card from specimen row added
        //    PSpecimenBase ps = new PSpecimenBase();
        //     ps = (PSpecimenBase)e.Entity;
        //    PRaceCardBase rc = new PRaceCardBase();
        //    rc = ps.SpecId;

        //    string aid = rc.AnimalId;
        //    string pid = rc.Identity;


        //    IQuery qryPSB = EntityManager.CreateQuery(TableNames.PSpecimen);

        //    qryPSB.AddEquals("ANIMAL_ID", rc.AnimalId);  //  will these have ID ?
        //                                                 //  qryPSB.AddAnd();
        //                                                 //  qryPSB.AddEquals("SPECIMEN_TYPE", "B");


        //    IEntityCollection specs = EntityManager.Select(TableNames.PSpecimen, qryPSB);

        //    // 08/11/2021 - need phrase to add specimen type , show only not selected ones
        //    string[] used = rc.SpecimenTypes2.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);

        //    IQuery qSpecTypes = EntityManager.CreateQuery(TableNames.Phrase);
        //    qSpecTypes.AddEquals("PHRASE", "SPECIMEN_S");
        //    foreach (string s in used)
        //    {
        //        qSpecTypes.AddAnd();
        //        qSpecTypes.AddNotEquals("PHRASE_ID", s);
        //    }


        //    IEntityCollection pSpecTypes = EntityManager.Select(TableNames.Phrase, qSpecTypes);


        //    // IEntity phrase p = new IEntity();
        //    IEntity p = EntityManager.CreateEntity(Phrase.EntityName);
        //    Library.Utils.PromptForEntity("Select", "Specimen type", pSpecTypes, out p);
        //    // for some unknonw reason , the prompt return does not work right on a row  added with + ( green ) button
        //    IEntity entitySB;
        //    entitySB = EntityManager.CreateEntity(PSpecimenBase.EntityName);
        //    entitySB.SetField("RACE_ID", (PackedDecimal)rc.RaceId.ToString());
        //    entitySB.SetField("RACE_CARD_ID", (PackedDecimal)rc.Identity.ToString());
        //    //  entitySB.SetField("IDENTITY", rc.Identity);
        //    entitySB.SetField("SPECIMEN_TYPE", p.Name);
        //    entitySB.SetField("ADD_SPECIMEN", true);
        //    entitySB.SetField("JOB_NAME", m_JobName);
        //    entitySB.SetField("CONTAINER", "NONE");
        //    entitySB.SetField("SAMPLING_POINT", rc.SamplingPoint);
        //    entitySB.SetField("RACE_DATE", rc.RaceDate);
        //    //  entitySB.SetField("SUFFIX", rc.Suffixes);
        //    entitySB.SetField("ANIMAL_ID", rc.AnimalId);


        //    EntityManager.Transaction.Add(entitySB);
        //    EntityManager.Commit();


        //    EntityManager.Transaction.Add(rc);
        //    EntityManager.Commit();

        //    frm.SMMasterDetailGridRaceCard.RefreshRow(rc);



        //    frm.SMMasterDetailGridRaceCard.Refresh();

        //    // populate selected grid - all races for race id
        //    IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

        //    qryRCS.AddEquals("RACE_ID", m_RaceID);
        //    qryRCS.AddAnd();
        //    qryRCS.AddEquals("SELECTED", true);

        //    IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);

        //    frm.SelectedCollection.Publish(RaceCardRCS);
        //    frm.SMMasterDetailGridRCSelection.Refresh();




        //}




        /// <summary>
        /// should only apply to fair or special
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void SMMasterDetailGridRaceCard_RowAdded(object sender, RowAddedEventArgs e)
        {

            e.Entity.SetField("SELECTED", true);


            if (m_RaceID == "")
            {
                bool exists = RaceExists(true);
            }
            int cnt = frm.SMMasterDetailGridRaceCard.GridData.ActiveItems.Count;
            int index = 0;

            string access_type = "";
            access_type = frm.PromptPhraseAccess_Typ.Value.ToString();


            if (access_type == "Race Day Samples")
            {
                Library.Utils.FlashMessage("Why adding row to accession type Race Day Samples ?", "Not supported, check with LIMS admin");

                return;
            }

            if (access_type == "1")   //  in case user has selected tace track 
            {
                Library.Utils.FlashMessage("Why adding row to accession type Race Day Samples?", "Not supported, check with LIMS admin");

                return;
            }

            foreach (PRaceCardBase RC in frm.SMMasterDetailGridRaceCard.GridData.ActiveItems)
            {
                if (RC.Identity == "")
                {
                    string RCID = RC.Identity;
                }
                index++;
                if (cnt == index)
                {
                    PackedDecimal id = new PackedDecimal(Library.Increment.GetIncrement("RACE_CARD", "ID"));
                    RC.Identity = id;

                    IEntity entity;
                    entity = EntityManager.CreateEntity(PRaceCardBase.EntityName);

                    entity.SetField("IDENTITY", id);
                    entity.SetField("SAMPLING_POINT", m_SamplePoint);
                    entity.SetField("RACE_NO", m_RaceNum);
                    entity.SetField("RACE_ID", m_RaceID);
                    entity.SetField("RACE_DATE", m_RaceDate);
                    entity.SetField("SELECTED", true);
                    entity.SetField("JOB_NAME", m_JobName);  // ToDo - should this always be set ?  

                    EntityManager.Transaction.Add(entity);
                    EntityManager.Commit();


                    frm.SMMasterDetailGridRaceCard.RefreshRow(entity);
                    // 03/22/2021 - add first specimen ?  -  03/23/2021 - NO - do not have all info for add yet 



                    //IQuery qryRC = EntityManager.CreateQuery(TableNames.PRaceCard);

                    //qryRC.AddEquals("IDENTITY", id);  //  will these have ID ?
                    //                                  //  qryPSB.AddAnd();
                    //                                  //  qryPSB.AddEquals("SPECIMEN_TYPE", "B");
                    //IEntityCollection recs = EntityManager.Select(TableNames.PRaceCard, qryRC);
                    ////if (specs.Count == 0)  // only add first one
                    ////{

                    //foreach (PRaceCardBase rc in recs)
                    //{
                    //    IEntity entitySB;
                    //    entitySB = EntityManager.CreateEntity(PSpecimenBase.EntityName);
                    //    entitySB.SetField("RACE_ID", (PackedDecimal)rc.RaceId.ToString());
                    //    entitySB.SetField("RACE_CARD_ID", (PackedDecimal)rc.Identity.ToString());
                    //    //  entitySB.SetField("IDENTITY", rc.Identity);
                    //    //   entitySB.SetField("SPECIMEN_TYPE", "B");
                    //    entitySB.SetField("ADD_SPECIMEN", true);
                    //    entitySB.SetField("JOB_NAME", m_JobName);
                    //    entitySB.SetField("CONTAINER", "NONE");
                    //    entitySB.SetField("SAMPLING_POINT", rc.SamplingPoint);
                    //    entitySB.SetField("RACE_DATE", rc.RaceDate);
                    //    //  entitySB.SetField("SUFFIX", rc.Suffixes);
                    //    entitySB.SetField("ANIMAL_ID", rc.AnimalId);


                    //    EntityManager.Transaction.Add(entitySB);
                    //    EntityManager.Commit();
                    //}
                }

            }



            IQuery qryRC = EntityManager.CreateQuery(TableNames.PRaceCard);
            qryRC.AddEquals("SAMPLING_POINT", m_SamplePoint);
            qryRC.AddAnd();
            qryRC.AddEquals("RACE_ID", m_RaceID);
            qryRC.AddAnd();
            qryRC.AddEquals("RACE_NO", m_RaceNum);

            IEntityCollection RaceCardRC = EntityManager.Select(TableNames.PRaceCard, qryRC);

            if (RaceCardRC.Count > 0)
            {
                frm.RaceCardCollection.Publish(RaceCardRC);
                frm.SMMasterDetailGridRaceCard.Refresh();
            }
            //  frm.txtNumberRaces.Value = numRaces.ToString();


        }

        /*
        private void GridData_ItemPropertyChanged(object sender, EntityCollectionEventArgs e)
        {
            string input = e.PropertyName;
            if (input =="AnimalId")
            {
                PRaceCardBase rc = (PRaceCardBase)e.Entity;

                foreach (PSpecimenBase ps in rc.PSpecimens)
                {
                    ps.AnimalId = rc.AnimalId;
                }

            }
        }


        */






        #endregion

        #region ButtonEvents

        private void BtnFindRace_Click(object sender, EventArgs e)
        {
            if (m_RaceID != "")
            {
                string id = m_RaceID;

                //   Library.Utils.FlashMessage("Loading Race " + m_RaceID, m_RaceID);

                string race_id = frm.PromptEntityBrowsePRace.Value.ToString();
                m_RaceID = race_id;

                frm.txtRaceID.Value = m_RaceID;
                m_RaceFound = true;
                RaceExists(false);
                //frm.PromptEntityBrowsePRace.Enabled = false;

                // Library.Utils.FlashMessage("Complete Loading Race " + m_RaceID, m_RaceID);
                //frm.btnFindRace.Enabled = false;
            }
        }

        private void BtnSpecimenReport_ClickAndWait(object sender, EventArgs e)
        {


            try
            {

                // find selected row in selection grid , check if saved
                //  frm.SMMasterDetailGridRCSelection.
                if (m_RaceCard != null)
                {
                    // IQuery QRace = EntityManager.CreateQuery(TableNames.PRaceCard);

                    //  QRace.AddEquals("IDENTITY", m_RaceCard.Identity);

                    //  IEntityCollection recs = EntityManager.Select(TableNames.PRaceCard, QRace);
                    //   if (recs.Count > 0)
                    //   {

                    // foreach (PRaceCardBase rc in recs)
                    // {

                    PRaceCardBase rc = m_RaceCard;
                    //rc.PerformPvSpecimenWitnessReport();

                    if (rc.SpecimenTypes == "")
                    {
                        Library.Utils.FlashMessage(rc.HorseName + " : No Specimen Types Selected ; select speciments or set to void, Click Save Selections", "No Specimens");
                        return;
                    }
                    if (rc.AnimalId == "")
                    {
                        Library.Utils.FlashMessage(rc.HorseName + " :No Commission # assigned , Assign and Click Save Selections ", "assign Commission No");
                        return;
                    }

                    if (rc.TestingReasons.ToString() == "")
                    {
                        Library.Utils.FlashMessage(rc.HorseName + " :No Testing Reason assigned, assin and Click Save Selections ", "assign Testing Reason");
                        return;
                    }
                    //04/23/2021 - dont check vet for specials 
                    if (m_Accession_type == "1" || m_Accession_type == "Race Day Samples" || m_Accession_type == "2")
                    {
                        if (!rc.VetGender)
                        {

                            Library.Utils.FlashMessage(rc.HorseName + " : Gender not confirmed by Vet, confirm and Click Save Selections ", "Check Box V-GENDER not checked ");
                            return;
                        }
                    }

                    //04/23/2021  - allow special specimen report , try attachment in action
                    //06/13/21  - - change so only confiscatino 9  and misc 14 use special receipt report
                    //if (m_Accession_type == "1" || m_Accession_type == "Race Day Samples" || m_Accession_type == "2")
                    //{
                    //    m_RaceCard.PerformPvSpecimenWitnessReport();

                    //     EntityManager.Transaction.Add(rc);  // update job to store attachment
                    //     EntityManager.Commit();
                    //}
                    //else
                    //{
                    //    m_RaceCard.PerformPvSpecialSpecimenWitnessRp();
                    //    EntityManager.Transaction.Add(rc);  // update job to store attachment
                    //    EntityManager.Commit();
                    //}

                    //07/17/2021 
                    if (m_Accession_type == "9" || m_Accession_type == "14")
                    {
                        m_RaceCard.PerformPvSpecialSpecimenWitnessRp();

                        EntityManager.Transaction.Add(rc);  // update rc to store attachment 
                        EntityManager.Commit();

                    }
                    else
                    {
                        m_RaceCard.PerformPvSpecimenWitnessReport();


                        EntityManager.Transaction.Add(rc);  // update rc to store attachment - get key error with or without transaction if attach is done after preview 
                        EntityManager.Commit();

                    }

                    // 10.23.2021 - add for attachment refressh - doesnt seem to work 


                    //frm.SMMasterDetailGridRCSelection.RefreshRow(rc);

                    //IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

                    //qryRCS.AddEquals("RACE_ID", m_RaceID);
                    //qryRCS.AddAnd();
                    //qryRCS.AddEquals("SELECTED", true);

                    //IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);

                    //frm.SelectedCollection.Publish(RaceCardRCS);

                    //frm.SMMasterDetailGridRCSelection.Refresh();

                    //frm.SMMasterDetailGridRCSelection.RefreshRow(rc);


                }
                else
                {
                    Library.Utils.FlashMessage("Race card for horse not found", "Check settings ");
                }

            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage(ex.Message, "Error from Specimen Report - attach to race card");
            }

            //  bool ok = true;

            //7/13/21  - Key not found error , try to refresh grid 
            //IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

            //qryRCS.AddEquals("RACE_ID", m_RaceID);
            //qryRCS.AddAnd();
            //qryRCS.AddEquals("SELECTED", true);

            //IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);

            //frm.SelectedCollection.Publish(RaceCardRCS);

            //frm.SMMasterDetailGridRCSelection.Refresh();
            //System.Threading.Thread.Sleep(500);   // 07/13/2021

            //07/16/2021 - try refresh top grid too
            //IQuery QRace2 = EntityManager.CreateQuery(TableNames.PRace);
            //QRace2.AddEquals("IDENTITY", m_RaceID);
            //IEntityCollection race2 = EntityManager.Select(TableNames.PRace, QRace2);
            //if (race2.Count > 0)   // 10/12/2020
            //{
            //    frm.RaceDetailCollection.Publish(race2);
            //    frm.SMMasterDetailGridRaceDetails.Refresh();
            //}

            //System.Threading.Thread.Sleep(500);   

        }




        private void BtnDetBarnReport_Click(object sender, EventArgs e)
        {


        }


        private void BtnDetBarnReport_ClickAndWait(object sender, EventArgs e)
        {

            if (m_Race == null)
            {
                Library.Utils.FlashMessage("Race  not found", "Check settings ");
                return;
            }

            //11/14/2020 add check for  for duplicate Animal ID - TODO - should dups not allow to continue ? 

            //            select* from p_race_Card where race_id = 135 and selected = 'T'

            //select distinct ANIMAL_ID from P_RACE_CARD where race_id = 135 and ANIMAL_ID != ''

            //11/14/2020 - check for dup in current set - query PRACECARD
            IQuery qryPSR = EntityManager.CreateQuery(TableNames.PRaceCard);

            qryPSR.AddEquals("RACE_ID", m_RaceID);
            qryPSR.AddAnd();
            qryPSR.AddEquals("SELECTED", true);
            List<Object> animals = EntityManager.SelectDistinct(qryPSR, "ANIMAL_ID");

            IEntityCollection selected = EntityManager.Select(TableNames.PRaceCard, qryPSR);
            if (animals.Count != selected.Count)
            {
                Library.Utils.FlashMessage("Appears you have a duplicate Commission Barcode ID in the race set - check for duplicates IDs when you print Det Barn Report ", "Check for Duplicate Barcode IDs");
            }
            //04/28/2021 
            // 08/21/2021  -  check for attachments does not seem correct , does not reflect attachment was made
            //foreach (PRaceCardBase prc in selected)
            //{
            //    if (!prc.Void)  // 08/13/2021
            //    {

            //        if (prc.HasAttachments == false)
            //        {
            //            Library.Utils.FlashMessage("No Specimen Report stored for Comm ID: " + prc.AnimalId, "Print Specimen Report for : " + prc.HorseName);
            //            // return;   // make this a warning for now
            //        }
            //    }

            //}



            Library.Utils.FlashMessage("Review specimen counts in Detention Barn Report  ", "Summary of Race ");
            /*
            bool cont = Library.Utils.FlashMessageYesNo("Edits all done for this race? Preview D Barn Report? ", "Preview D Barn Report?");
            if ( cont)
            {
              //  frm.btnSave.Enabled = true;
            }
            else
            {
                return;
            }
            */
            bool cont = Library.Utils.FlashMessageYesNo("Edits all done for this race? Preview Det Barn Report? If Preview is OK , Print report ( Use pdf button) and answer yes to next prompt", "Preview D Barn Report?");
            if (cont)
            {
                // frm.btnSave.Enabled = true;
            }
            else
            {
                return;
            }

            //07/31/2021

            foreach (PRaceCardBase prc in frm.SMMasterDetailGridRCSelection.GridData.ActiveItems)
            {
                foreach (PSpecimenBase ps in prc.PSpecimens)
                {
                    bool update = false;
                    if (ps.SamplingPoint.IsNull())  //07/31/2021  0 check sampleing point
                    {
                        update = true;

                        ps.SamplingPoint = m_SamplePoint;
                        ps.Container = "NONE";

                    }
                    if (ps.RaceDate.IsNull)
                    {
                        update = true;

                        ps.RaceDate = prc.RaceDate;
                        ps.Container = "NONE";
                    }
                    if (update)
                    {
                        EntityManager.Transaction.Add(ps);
                        EntityManager.Commit();
                    }

                }


            }


            m_Race.PerformPvDetDetBarnReport();  // this action previews, no attach

            cont = Library.Utils.FlashMessageYesNo(" Det Barn Report is OK?  Click No if you need to make edits, Yes to proceed with save , and click 'Final Save' ", "Proceed with Race Save?");
            if (cont)
            {
                frm.btnSave.Enabled = true;
            }
            else
            {
                return;
            }
            //04/23/2021 - add action to do attach
            m_Race.PerformPvDetBarnReportAttach();  // no preview - attach
            EntityManager.Transaction.Add(m_Race);
            EntityManager.Commit();


            // do this if action does not attach / does not have attach node
            //try
            //{
            //    ReportTemplate m_ReportTemplate = null;
            //    m_ReportTemplate = (ReportTemplate)EntityManager.SelectLatestVersion("REPORT_TEMPLATE", "PV_DET_BARN");

            //    string fname;
            //    IEntity genPhrase = EntityManager.Select(TableNames.Phrase, new Identity("ATT_CAT", "GENERAL"));

            //    IEntity att = m_Race.AddFileAttachment("D_Barn_Report_C", null, genPhrase, ".pdf", out fname);
            //    Library.Reporting.PrintReportToServerFile(m_ReportTemplate, m_Race, new ReportOptions(ReportOutput.PrintPdf), Thermo.SampleManager.Common.PrintFileType.Pdf, fname);

            //    EntityManager.Transaction.Add(m_Race);  // update to store attachment
            //    EntityManager.Commit();

            //}
            //catch (Exception ex)
            //{
            //    Library.Utils.FlashMessage(ex.Message, "Error from Save Print - attach to race ");
            //    //  ok = false;
            //}


        }

        //private void BtnEditJob_Click(object sender, EventArgs e)
        //{

        //}



        //private void BtnEditJob_ClickAndWait(object sender, EventArgs e)
        //{

        //    var job = (JobHeader)EntityManager.CreateEntity(JobHeaderBase.EntityName);

        //    job.PSamplingPoint = m_SamplePoint;
        //    job.PRaceDate = m_RaceDate;

        //    LaunchWF(m_WorkFlowName);
        //}





        private void BtnSaveManual_ClickAndWait(object sender, EventArgs e)
        {
            //  need to see if race or special exists, create if no4 
            //     bool exists = RaceExists(true);    03/20/2021  create race in add buttons for special and fair, not here
            //  should confirm have a race num ?
            if (m_RaceID == "")
            {
                Library.Utils.FlashMessage("Race not created ", "Error");
                return;
            }

            bool exists = true;
            string access_type = "";
            access_type = frm.PromptPhraseAccess_Typ.Value.ToString();

            string race = "";
            string date = "";
            string registration = "";
            string horseName = "";
            string color = "";
            string tatoo = "";
            string lasix = "";
            string owner = "";
            string trainer = "";
            string age = "";
            string gender = "";
            // string identity = "";
            PackedDecimal identity = new PackedDecimal(0);


            if (exists)   /// shoudl always be true
            {
                foreach (PRaceCardBase rc in frm.SMMasterDetailGridRaceCard.GridData.NewItems)  /// TODO - check  Modified items below
                {

                    race = rc.RaceId.ToString();

                    date = rc.RaceDate.ToString();
                    registration = rc.Registration.ToString();
                    horseName = rc.HorseName.ToString();
                    color = rc.Color.ToString();
                    tatoo = rc.Tatoo.ToString();
                    lasix = rc.PreRaceLasix.ToString();
                    owner = rc.Owner.ToString();
                    trainer = rc.Trainer.ToString();
                    age = rc.Age.ToString();
                    gender = rc.Gender.ToString();
                    identity = rc.Identity;

                    // this is existing record - retreive and update
                    // rc.SamplingPoint.Identity = m_SamplePoint.ToString();   // 03/22/2021

                    rc.RaceId.Identity = m_RaceID;
                    rc.HorseName = horseName;
                    rc.Owner = owner;

                    IQuery QRace = EntityManager.CreateQuery(TableNames.PRaceCard);

                    QRace.AddEquals("IDENTITY", identity);

                    IEntityCollection recs = EntityManager.Select(TableNames.PRaceCard, QRace);

                    foreach (PRaceCardBase prc in recs)
                    {
                        prc.Identity = rc.Identity;
                        //  prc.SamplingPoint.Identity = m_SamplePoint.ToString();  03/22/2021
                        prc.SamplingPoint = m_SamplePoint;
                        prc.Registration = registration;
                        prc.AnimalId = rc.AnimalId;
                        prc.Microchip = rc.Microchip;
                        prc.PreRaceLasix = rc.PreRaceLasix;
                        prc.Tatoo = rc.Tatoo;
                        prc.HorseName = horseName;
                        prc.RaceId.Identity = m_RaceID;
                        prc.RaceDate = m_RaceDate;
                        prc.RaceNo = m_RaceNum;
                        prc.Owner = rc.Owner;
                        prc.Trainer = rc.Trainer;
                        //    prc.Selected = true;
                        prc.JobName = m_JobName;
                        EntityManager.Transaction.Add(prc);
                        EntityManager.Commit();
                        frm.SMMasterDetailGridRaceCard.RefreshRow(prc);

                    }

                    // for manual cannot add specimens , default specimen types not defined

                }

            }
            //else
            //{

            //    foreach (PRaceCardBase rc in frm.SMMasterDetailGridRaceCard.GridData.ActiveItems)
            //    {



            //        //Race	 Date	 Registration	 Horse Name	 color? 	 tatoo	 Pre-Race Lasix	Owner	 Trainer	 age in years	 gender

            //        // TO do - need way to check for previous load ?


            //        //
            //    }
            //}

            foreach (PRaceCardBase rc in frm.SMMasterDetailGridRaceCard.GridData.ModifiedItems)
            {
                race = rc.RaceId.ToString();

                date = rc.RaceDate.ToString();
                registration = rc.Registration.ToString();
                horseName = rc.HorseName.ToString();
                color = rc.Color.ToString();
                tatoo = rc.Tatoo.ToString();
                lasix = rc.PreRaceLasix.ToString();
                owner = rc.Owner.ToString();
                trainer = rc.Trainer.ToString();
                age = rc.Age.ToString();
                gender = rc.Gender.ToString();
                identity = rc.Identity;

                // this is existing record - retreive and update
                //rc.SamplingPoint.Identity = m_SamplePoint.ToString();
                rc.RaceId.Identity = m_RaceID;
                rc.HorseName = horseName;
                rc.Owner = owner;

                IQuery QRace = EntityManager.CreateQuery(TableNames.PRaceCard);

                QRace.AddEquals("IDENTITY", identity);

                IEntityCollection recs = EntityManager.Select(TableNames.PRaceCard, QRace);

                foreach (PRaceCardBase prc in recs)
                {
                    prc.Identity = rc.Identity;
                    // prc.SamplingPoint.Identity = m_SamplePoint.ToString();
                    prc.Registration = registration;
                    prc.Microchip = rc.Microchip;
                    prc.PreRaceLasix = rc.PreRaceLasix;
                    prc.Tatoo = rc.Tatoo;
                    prc.HorseName = horseName;
                    prc.RaceId.Identity = m_RaceID;
                    prc.RaceDate = m_RaceDate;
                    prc.RaceNo = m_RaceNum;
                    prc.Owner = rc.Owner;
                    prc.Trainer = rc.Trainer;
                    //  prc.Selected = true;
                    prc.PostTime = rc.PostTime;  // 0202.2021
                    prc.PostTime = rc.PostTime;
                    prc.TimeMerid = rc.TimeMerid;
                    //06/13/2021 - check for random empty sample point 
                    if (prc.SamplingPoint.IsNull())
                    {
                        prc.SamplingPoint = m_SamplePoint;
                    }
                    EntityManager.Transaction.Add(prc);
                    EntityManager.Commit();
                    frm.SMMasterDetailGridRaceCard.RefreshRow(prc);
                }

                frm.SMMasterDetailGridRaceCard.Refresh();
                // check  specimens now ?  may need other specimens


            }


            //load selection grid , all races for race date

            IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

            qryRCS.AddEquals("RACE_ID", m_RaceID);
            qryRCS.AddAnd();


            qryRCS.AddEquals("SELECTED", true);

            IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);
                      


            //frm.SelectedCollection.Publish(RaceCardRCS);
            //frm.SMMasterDetailGridRCSelection.Refresh();

            frm.SelectedCollection.Data.Clear();
            frm.SelectedCollection.Data.RemoveAll();
            frm.SMMasterDetailGridRCSelection.GridData.Clear();

  

            frm.SelectedCollection.Data.Refresh();
            frm.SMMasterDetailGridRCSelection.Refresh();
            System.Threading.Thread.Sleep(1000);


            foreach (PRaceCardExtended horse in RaceCardRCS)
            {
                foreach (PSpecimenBase spec in horse.SpecimensWithCompleteCollectionData)
                {
                    spec.RefreshDetailContent();

                }
                horse.RefreshDetailContent();
                horse.SpecimensWithCompleteCollectionData.Refresh();
                horse.SpecimensNonVoided.Refresh();
            }

            IQuery qryRC = EntityManager.CreateQuery(TableNames.PRaceCard);
            qryRC.AddEquals("SAMPLING_POINT", m_SamplePoint);
            qryRC.AddAnd();
            qryRC.AddEquals("RACE_ID", m_RaceID);
            qryRC.AddAnd();
            qryRC.AddEquals("RACE_NO", m_RaceNum);

            IEntityCollection RaceCardRC = EntityManager.Select(TableNames.PRaceCard, qryRC);

            frm.SMMasterDetailGridRaceCard.GridData = RaceCardRC;
            frm.SMMasterDetailGridRCSelection.GridData = RaceCardRCS;
            frm.SMMasterDetailGridRCSelection.GridData.Reselect();
            frm.SMMasterDetailGridRCSelection.GridData.Refresh();


        }



        private void BtnAddSpecial_ClickAndWait(object sender, EventArgs e)   // first
        {
            // slightly different process for special and fair 
            // check accession type is set 

            string access_type = "";
            access_type = frm.PromptPhraseAccess_Typ.Value.ToString();
            if (access_type == "None")
            {
                Library.Utils.FlashMessage("Set Accession Type before adding special ", "<- Set Accession type");
                return;
            }

            if (access_type == "Race Day Samples")
            {
                Library.Utils.FlashMessage("Set Accession Type before adding special ", "<- Set Accession type");
                return;
            }

            if (access_type == "1")   //  in case user has selected tace track 
            {
                Library.Utils.FlashMessage("Set Accession Type before adding special ", "<- Set Accession type");
                return;
            }


            bool import = Library.Utils.FlashMessageYesNo("Do you have Race card for import ?", "Race Card?");
            if (import)
            {

                bool OK = Library.Utils.FlashMessageYesNo("Create Special for Type:  " + frm.PromptPhraseAccess_Typ.RawText + ", Import Race Card ", "Create Special?", MessageIcon.Question);
                if (!OK)
                { return; }
                frm.btnSaveManual.Visible = false;
                frm.btnSaveManual.Enabled = false;

                frm.btnImportRaceCard.Enabled = true;
            }
            else  // manual entry 
            {

                bool OK = Library.Utils.FlashMessageYesNo("Create Special for Type: " + frm.PromptPhraseAccess_Typ.RawText + ", Add horses and specimens manually ", "Create Special ?", MessageIcon.Question);
                if (!OK)
                { return; }

                frm.btnImportRaceCard.Enabled = false;
                frm.btnSaveManual.Visible = true;
                frm.btnSaveManual.Enabled = true;
                frm.btnSaveSelectedManual.Visible = true;
                frm.btnSaveSelectedManual.Enabled = true;
                frm.btnAddSelectedManual.Visible = true;
                frm.btnAddSelectedManual.Enabled = true;
                // turn off import save btns
                frm.btnAddSelected.Enabled = false;
                frm.btnAddSelected.Visible = false;
                frm.btnSaveSelected.Visible = false;
                frm.btnSaveSelected.Enabled = false;

                frm.cbxManualEntry.Checked = true;
                frm.cbxManualEntry.Visible = true;
                //  need to modify grid read only fields 
                ResetReadOnlyGrid();
                frm.dateRaceDate.Enabled = false;   // 04/02/2021 - set read only
                frm.SMMasterDetailGridRaceCard.Columns["Age"].ReadOnly = false;  //12/10/2021
                                                                                 //  frm.SMMasterDetailGridRaceCard.Columns["Age"].IsGrayBackground
            }


            // if no card, create race now - this shoudl reset the date enabled
            if (!import)
            {

                bool exists = RaceExists(true);
                //if (!exists)
                //{
                //    Library.Utils.FlashMessage("Race Not created", "error");
                //}
                //  update job fields , same as in import; per DT , specials should get same projects as race day samples
                // TODO - check about setting job.p_purpose


                if (m_JobName != "")
                {
                    IQuery qJ = EntityManager.CreateQuery("JOB_HEADER");
                    qJ.AddEquals("JOB_NAME", m_JobName);
                    IEntityCollection recs = EntityManager.Select(TableNames.JobHeader, qJ);

                    foreach (JobHeader j in recs)
                    {
                        j.PAccessionNumber = j.JobName;
                        j.PSamplingPoint = m_SamplePoint;
                        j.PRaceDate = m_RaceDate;
                        //  j.PAccessionType.PhraseId = m_Accession_typeID;
                        // j.PAccessionType.PhraseId = PhraseAccessTyp.PhraseId1;
                        // j.PAccessionType = (PhraseBase)frm.PromptPhraseAccess_Typ.Phrase;

                        j.SetPAccessionType(m_Accession_type);
                        if (frm.cbxAddFair.Checked)
                        { j.SetPFair(m_Fair); }
                        // j.PFair = m_Fair;
                        j.PRaceId = m_Race;

                        if (m_SamplePoint.RacetrackType.PhraseId == PhraseRtType.PhraseIdH)
                        {

                            IQuery qp = EntityManager.CreateQuery("PROJECT_INFO");
                            qp.AddEquals("PROJECT_ID", "SBHORSE");
                            IEntityCollection ps = EntityManager.Select("PROJECT_INFO", qp);
                            if (ps.Count == 1)
                            {
                                j.PProject = (ProjectInfo)ps[0];
                            }

                        }
                        if (m_SamplePoint.RacetrackType.PhraseId == PhraseRtType.PhraseIdT)
                        {
                            IQuery qp = EntityManager.CreateQuery("PROJECT_INFO");
                            qp.AddEquals("PROJECT_ID", "TBHORSE");
                            IEntityCollection ps = EntityManager.Select("PROJECT_INFO", qp);
                            if (ps.Count == 1)
                            {
                                j.PProject = (ProjectInfo)ps[0];
                            }
                        }


                        EntityManager.Transaction.Add(j);
                        EntityManager.Commit();

                        foreach (Sample s in j.Samples)  // QC sample
                        {
                            s.SamplingPoint = m_SamplePoint;
                            EntityManager.Transaction.Add(s);
                            EntityManager.Commit();
                        }
                    }
                }


            }


            // slightly different process for special and fair 
            // check accession type is set 

            // string access_type = "";
            access_type = frm.PromptPhraseAccess_Typ.Value.ToString();
            if (access_type == "None")
            {
                // Library.Utils.FlashMessage("Set Accession Type before adding special ", "<- Set Accession type");
                return;
            }

            if (access_type == "Race Day Samples")
            {
                //  Library.Utils.FlashMessage("Set Accession Type before adding special ", "<- Set Accession type");
                return;
            }

            if (access_type == "1")   //  in case user has selected tace track 
            {
                // Library.Utils.FlashMessage("Set Accession Type before adding special ", "<- Set Accession type");
                return;
            }

            frm.cbxAddFair.Enabled = false;
            frm.cbxAddFair.Visible = false;
            frm.cbxAddFair.Checked = false;
            frm.cbxAddSpecial.Enabled = true;
            frm.cbxAddSpecial.Visible = true;
            frm.cbxAddSpecial.Checked = true;
            //  frm.btnSaveManual.Visible = true;
            //  frm.btnSaveManual.Enabled = true;

            //  frm.btnImportRaceCard.Enabled = false;
            frm.btnAddSelected.Enabled = true;  // 03/20/2021  horses added 

        }

        private void BtnAddFair_Click(object sender, EventArgs e)
        {
            //  frm.cbxAddFair.Enabled = true;
            //  frm.cbxAddFair.Visible = true;
            //  frm.cbxAddFair.Checked = true;
            //  frm.PromptPhraseFair.Visible = true;
            //  frm.PromptPhraseFair.Enabled = true;
            //  frm.cbxAddSpecial.Enabled = false;
            //  frm.cbxAddSpecial.Visible = false;
            //  frm.cbxAddSpecial.Checked = false;
            // // frm.btnSaveManual.Visible = true;
            // // frm.btnSaveManual.Enabled = true;


            ////  frm.btnImportRaceCard.Enabled = false;
        }



        private void BtnAddFair_ClickAndWait(object sender, EventArgs e) //first
        {

            bool import = Library.Utils.FlashMessageYesNo("Do you have Race card for import ?", "Race Card?");
            if (import)
            {
                frm.btnSaveManual.Visible = false;
                frm.btnSaveManual.Enabled = false;

                frm.btnImportRaceCard.Enabled = true;
                Library.Utils.FlashMessage("Check / Set accession type = Fair, SetFair Name, Import race card  ", "Set Fair name and import");
            }
            else
            {
                frm.btnImportRaceCard.Enabled = false;
                frm.btnSaveManual.Visible = true;
                frm.btnSaveManual.Enabled = true;
                frm.btnSaveSelectedManual.Visible = true;
                frm.btnSaveSelectedManual.Enabled = true;
                frm.btnAddSelectedManual.Visible = true;
                frm.btnAddSelectedManual.Enabled = true;
                // turn off import save btns
                frm.btnAddSelected.Enabled = false;
                frm.btnAddSelected.Visible = false;
                frm.btnSaveSelected.Visible = false;
                frm.btnSaveSelected.Enabled = false;

                frm.cbxManualEntry.Checked = true;
                frm.cbxManualEntry.Visible = true;
                Library.Utils.FlashMessage("Check / set accession type = Fair, SetFair Name, input horse data and save   ", "Input data and save ");
                //  need to modify grid read only fields 
                ResetReadOnlyGrid();

            }

            frm.PromptPhraseAccess_Typ.Value = "2";



            //  frm.PromptPhraseAccess_Typ.Value = "Fair";
            m_Accession_type = frm.PromptPhraseAccess_Typ.Value.ToString();
            // m_Accession_type = "2";
            string m_Accession_typeID = GetPhraseID("ACCESS_TYP", m_Accession_type);
            //  frm.PromptPhraseAccess_Typ.Browse.Republish(m_Accession_type, true);

            frm.PromptPhraseAccess_Typ.TextContent = "Fair";

            // if no card, create race now 
            if (!import)
            {

                bool exists = RaceExists(true);
                //if ( !exists )
                //{
                //    Library.Utils.FlashMessage("Race Not create", "error");
                //}
            }

            frm.cbxAddFair.Enabled = true;
            frm.cbxAddFair.Visible = true;
            frm.cbxAddFair.Checked = true;
            frm.PromptPhraseFair.Visible = true;
            frm.PromptPhraseFair.Enabled = true;
            frm.cbxAddSpecial.Enabled = false;
            frm.cbxAddSpecial.Visible = false;
            frm.cbxAddSpecial.Checked = false;
            // frm.btnSaveManual.Visible = true;
            // frm.btnSaveManual.Enabled = true;


            //  frm.btnImportRaceCard.Enabled = false;

        }



        /// <summary>
        /// FInal Save, generate file to folder on server , exit form in BtnSave_Click
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void BtnSave_ClickAndWait(object sender, EventArgs e)
        {
            // 04/23/2021   add erro check for blank sample point
            if (m_SamplePoint.Name == "")
            {
                Library.Utils.FlashMessage("Error - race track / sample point is not defined , cannot save.   contact support", "Race # " + m_RaceID + " Error");
                return;
            }

            // TODO reality check - 
            /*
            a.	Confirm number of claimed
            b.	Check required fields ( Coll date, collector ) 
            c.	Present a count of horses and specimens
            d.	This could be a prompt box  if OK , then Final Save is enabled ( currently Final save is always on)
            e.	Do specimens need to be assigned to container and shipped, before Save is allowed? next TOD
            f.  check if detention barn report saved, and if all horse have speciment reports

             */

            // check if containers have been set   - NONE
            // TODO - revisit after testing - should save be allowed before final save / job send

            IQuery qryPS = EntityManager.CreateQuery(TableNames.PSpecimen);

            qryPS.AddEquals("SAMPLING_POINT", m_SamplePoint);

            qryPS.AddAnd();
            qryPS.AddEquals("CONTAINER", "NONE");
            qryPS.AddAnd();
            qryPS.AddEquals("RACE_DATE", m_RaceDate);


            IEntityCollection PSpecs = EntityManager.Select(TableNames.PSpecimen, qryPS);

            //11.14.2020 comment out , run General workflow fromn code
            //if (PSpecs.Count > 0)
            //{
            //    bool save = Library.Utils.FlashMessageYesNo("TEST PHASE - After Race Save-  Run General Workflow - RaceTrackJob - before Container Shipment - Then USE Container Shipment Form to assign containers, any not sent set to void", "All Edits done , Continue with race Save?");
            //    //return;
            //    if (save)
            //    {
            //        // continue
            //    }
            //    else
            //    {
            //        return;
            //    }
            //}



            /*
            P_RACE_DATE|JOB_SAMPLING_POINT|JOB_OWNER|JOB_SPECIMEN_TYPES|JOB_NUMBER_SAMPLES|SAMP_SPECIMENT_TYPES|P_SPECIMEN_ID|P_COMMISSION_NO|P_GENDER|P_AGE|P_SUFFIX|P_LASIX|P_FUROSEMIDE|M_MICROCHIP|P_VOLUME
8/22/2019|hp|cash, john|BU|8|BU|1|ZZ|M|10|F,M|T|T|YY|10



            */
            // get accession_type and fair name  // need phrase id

            if (frm.PromptPhraseAccess_Typ.Value.ToString() == "Race Day Samples" || frm.PromptPhraseAccess_Typ.Value.ToString() == "None")  // initial load
            { m_Accession_type = "1"; }
            else
            { m_Accession_type = frm.PromptPhraseAccess_Typ.Value.ToString(); }

            //  m_Accession_typeID = GetPhraseID("ACCESS_TYP", m_Accession_type);


            //    m_Fair = frm.PromptPhraseFair.Value.ToString();

            //04/30/2021  add now  to file name - to make unique 
            string fileOut = TranslateFileIllegals(m_SamplePoint + "_" + m_RaceDate.ToShortDateString() + "_" + System.DateTime.Now.ToShortDateString() + "_" + System.DateTime.Now.ToLongTimeString());
            fileOut = m_DirName + "\\" + fileOut + ".txt";
            string FileOutArchive = m_DirNameArchive + fileOut;

            StreamWriter sw = new StreamWriter(fileOut, false);

            string owner = "";  // need to define RT owner


            int samples = 0;
            //03/31/2021 - just do in switch  ,  for specials, send the OT to parent level
            //bool BU = false;
            //bool BUT = false;
            //bool B = false;
            //bool U = false;
            //bool T = false;
            //bool O = false;

            // loop thru selected horses to get sample types and number of samples
            string specimen_types = "";
            string container = "";
            // this logic shoudl set the specimen_types for the job
            // 03.30.2021  for specials , any not BUT call O
            foreach (PRaceCardBase rc in frm.SMMasterDetailGridRCSelection.GridData.ActiveItems)
            {

                if (rc.Selected && !rc.Void)   // 11/14/2020 add void check 
                {
                    samples++;
                    switch (rc.SpecimenTypes.ToString())
                    {
                        case "Blood,Urine":
                            {
                                //   BU = true;
                                specimen_types = "BU";
                            }
                            break;
                        case "Blood,Urine,Tissue":
                            {
                                //    BUT = true;
                                specimen_types = "BUT";
                            }
                            break;
                        case "Blood":
                            {
                                //   B = true;
                                specimen_types = "B";
                            }
                            break;
                        case "Urine":
                            {
                                //   U = true;
                                specimen_types = "U";
                            }
                            break;
                        case "Tissue":
                            {
                                //   T = true;
                                specimen_types = "T";
                            }
                            break;
                        default:
                            // O = true;
                            specimen_types = "OT";
                            break;
                    }




                }





            }
            //if (BUT)
            //{
            //    specimen_types = "BUT";
            //}
            //else if (BU)
            //{
            //    specimen_types = "BU";
            //}
            //else if (B)
            //{
            //    specimen_types = "B";
            //}
            //else if (U)
            //{
            //    specimen_types = "U";
            //}
            //else if (T)
            //{
            //    specimen_types = "T";
            //}
            //else if (O)
            //{
            //    specimen_types = "O";
            //}




            // 04/23/2021  add notes
            string header = "ACCESSION_TYPE | JOB_NAME | P_RACE_DATE | JOB_SAMPLING_POINT | JOB_OWNER | JOB_SPECIMEN_TYPES | JOB_NUMBER_SAMPLES | SPECIMEN_TYPE  | SAMP_SPECIMEN_TYPES | P_SPECIMEN_ID | P_COMMISSION_NO | P_GENDER | P_AGE | P_SUFFIX | P_LASIX | P_FUROSEMIDE | M_MICROCHIP | P_VOLUME | CONTAINER | NOTES";

            sw.Write(header);
            sw.Write(System.Environment.NewLine);

            // race date . use Default SM 
            // m_RaceDate.ToString("dd-MMM-yyyy")

            string line = m_Accession_type + "|" + m_JobName + "|" + m_RaceDate.ToString("dd-MMM-yyyy") + "|" + m_SamplePoint.Identity + "|" + owner + "|" + specimen_types + "|" + samples.ToString() + "|";
            string sampleLine = "";

            int sampleCount = 0;



            //08/03/2021

            try
            {
                IEntityCollection rcSort = EntityManager.CreateEntityCollection(TableNames.PRaceCard);

                foreach (PRaceCardBase rc in frm.SMMasterDetailGridRCSelection.GridData.ActiveItems)
                {
                    rcSort.Add(rc);
                }
                //rcSort.AddSortField("ANIMAL_ID", true);
                rcSort.AddSortField(PRaceCardPropertyNames.AnimalId, true);
                rcSort.Sort();

                // foreach (PRaceCardBase rc in frm.SMMasterDetailGridRCSelection.GridData.ActiveItems)  /08/03/2021
                foreach (PRaceCardBase rc in rcSort)
                {
                    string sampleSpecimenTypes = "";
                    // sampleCount++;

                    if (rc.Selected && !rc.Void)
                    {
                        sampleCount++;
                        foreach (PSpecimenBase ps in rc.PSpecimens)
                        {
                            if (ps.AddSpecimen)
                            {
                                // 03.30.2021 -  the SpecimentTypes method  translated strings to single letters, but added new field rc.SpecimenTypes2 with has singles
                                // if works, can remove SpecimenTypes method
                                // sampleSpecimenTypes = SpecimenTypes(rc.SpecimenTypes.ToString());
                                sampleSpecimenTypes = rc.SpecimenTypes2.Replace(",", "");   // 08/11/2021 - repalce commas added for manual add
                                // TODO - check , don't think the container can ever be assigned at the final save, container happens later 
                                if (ps.Container == "")
                                {
                                    container = "TBD";
                                }
                                else
                                {
                                    container = ps.Container;
                                }
                                sampleLine = line;
                                sampleLine += ps.SpecimenType + "|" + sampleSpecimenTypes + "|" + sampleCount.ToString() + "|" + rc.AnimalId + "|" + rc.Gender + "|" + rc.Age.ToString() + "|" + rc.Suffixes + "|" + rc.PreRaceLasix.ToString() + "|" + "?" + "|" + rc.Microchip + "|" + "-1" + "|" + container + "|" + rc.Notes;
                                sw.Write(sampleLine);
                                sw.Write(System.Environment.NewLine);
                            }


                        }

                    }

                }
                sw.Close();

                // update the race as submitted,  update m_Race , shoudl be current race
                //  problems in web client with this grid - 
                //foreach (PRaceBase r in frm.SMMasterDetailGridRaceDetails.GridData.ActiveItems)
                //{
                //    r.RaceSubmitted = true;
                //    r.SubmittedBy = (Personnel)Library.Environment.CurrentUser;
                //    EntityManager.Transaction.Add(r);
                //    EntityManager.Commit();
                //    m_Race = r;  // add 03.18.2021  for write to job


                //}

                m_Race.RaceSubmitted = true;
                m_Race.SubmittedBy = (Personnel)Library.Environment.CurrentUser;
                EntityManager.Transaction.Add(m_Race);
                EntityManager.Commit();


                //  launch general workflow after pause
                System.Threading.Thread.Sleep(2000);
                // 04/30/2021 - try as background action
                // LaunchWF(m_JobWorkFlowName);



                m_Race.PerformPetrlRaceGeneralWf();
                EntityManager.Transaction.Add(m_Race);
                EntityManager.Commit();

                Library.Utils.FlashMessage("Race Saved and form will close.  Re-open to start a new race or load prior race", "Race Saved");
                //frm.Close();
              
            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage("Problem with sort or save of race. confirm all animal ids are numeric.  If error continues report to support. Error message: " + ex.Message, "Error from save");
            }
        }




        /// <summary>
        /// CLose the form after ClickAndWait
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void BtnSave_Click(object sender, EventArgs e)
        {
            
            frm.Close();
        }
       

        /// <summary>
        /// input comma separated phrase list
        /// </summary>
        /// <param name="specimenTypes"></param>
        /// <returns>specimen phraseID combined</returns>
        private string SpecimenTypes(string specimenTypes)
        {

            bool BU = false;
            bool BUT = false;
            bool B = false;
            bool U = false;
            bool T = false;
            bool O = false;
            string type = "";
            switch (specimenTypes.ToString())
            {
                case "Blood,Urine":
                    {
                        BU = true;
                    }
                    break;
                case "Blood,Urine,Tissue":
                    {
                        BUT = true;
                    }
                    break;
                case "Blood":
                    {
                        B = true;
                    }
                    break;
                case "Urine":
                    {
                        U = true;
                    }
                    break;
                case "Tissue":
                    {
                        T = true;
                    }
                    break;
                default:
                    O = true;
                    break;
            }
            if (BUT)
            {
                type = "BUT";
            }
            else if (BU)
            {
                type = "BU";
            }
            else if (B)
            {
                type = "B";
            }
            else if (U)
            {
                type = "U";
            }
            else if (T)
            {
                type = "T";
            }
            else if (O)
            {
                type = "O";
            }

            return type;

        }


        private void BtnSaveSelectedManual_ClickAndWait(object sender, EventArgs e)
        {
            try
            {
                foreach (PRaceCardBase rc in frm.SMMasterDetailGridRCSelection.GridData.ModifiedItems)   // 11/14/2020 change from  activeItems to modified
                {
                    if (!rc.Void)  // 6/30/2020  - exclude voided horses
                    {

                        string spec_types = "";
                        string spec_types2 = "";  // 03.03.2021
                        bool have_one = false;

                        // 04/30/2021 - check if numeric - TODO - maybe should not allow ?

                        try
                        {
                            int check = System.Convert.ToInt32(rc.AnimalId);
                        }
                        catch
                        {
                            Library.Utils.FlashMessage("Animal ID is not numeric , Animal ID: " + rc.AnimalId, "Check Horse: " + rc.HorseName);
                        }

                        //10/21/2021


                        bool have_suffix = false;

                        string suffix = rc.Suffixes;

                        if (suffix != "")
                        {
                            have_suffix = true;

                        }
                        // set suffixes

                        // for IM   From Deb email of 2/17/20:
                        //  Suffix = IM - Intact Male if gender = "H"(horse) or "C"(colt) , or "R"(ridgeling).But we need to add "m"(male) - done

                        if (rc.PreRaceLasix.ToString().Contains("L"))
                        {
                            if (!rc.Suffixes.Contains("F"))
                            {
                                if (have_suffix)
                                { suffix += ","; }

                                suffix += "F";
                                have_suffix = true;

                            }
                        }
                        if (rc.Gender == "H" || rc.Gender == "h")
                        {
                            if (!rc.Suffixes.Contains("IM"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "IM";
                                have_suffix = true;
                            }
                        }
                        else if (rc.Gender == "C" || rc.Gender == "c")
                        {
                            if (!rc.Suffixes.Contains("IM"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "IM";
                                have_suffix = true;
                            }
                        }
                        else if (rc.Gender == "R" || rc.Gender == "r")
                        {
                            if (!rc.Suffixes.Contains("IM"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "IM";
                                have_suffix = true;
                            }
                        }

                        if (rc.TestingReasons.ToString() == "C")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }

                        if (rc.TestingReasons.ToString() == "CW")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }

                        if (rc.TestingReasons.ToString() == "C2")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }

                        if (rc.TestingReasons.ToString() == "CSP")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }
                        // 11/13/2021 - Check for updated testing reasons - case when changed from Previous C
                        if (!rc.TestingReasons.ToString().Contains("C"))
                        {
                            if (rc.Suffixes.Contains("C"))
                            {

                                suffix = suffix.Replace('C', ' ');
                                suffix = suffix.TrimEnd(' ');
                                suffix = suffix.TrimEnd(',');
                                suffix = suffix.TrimStart(',');

                                rc.Claimed = false;
                                //have_suffix = true;
                            }
                        }
                        // end 11/13/2021
                        rc.Suffixes = suffix;

                        EntityManager.Transaction.Add(rc);
                        EntityManager.Commit();

                        //end 10/21/2021



                        foreach (PSpecimenBase ps in rc.PSpecimens)
                        {
                            ps.AnimalId = rc.AnimalId;  // ToDO - check if this is correct
                            ps.Claimed = rc.Claimed;   // ToDO - check if this is correct
                            ps.Suffix = rc.Suffixes;    // ToDO - check if this is correct
                            ps.JobName = rc.JobName;

                            if (ps.SamplingPoint.IsNull())  //07/31/2021  0 check sampleing point
                            {
                                ps.SamplingPoint = m_SamplePoint;
                                ps.RaceDate = m_RaceDate;
                                ps.Container = "NONE";
                            }

                            //08/06/2021
                            if (ps.JobName == "")  // 08/06/2021 
                            { ps.JobName = m_JobName; }

                            // if (ps.SpecimenType.ToString() != "" && ps.AddSpecimen)  // 08/01/2021

                            if (ps.AddSpecimen)
                            {
                                if (have_one)
                                {
                                    spec_types += ",";
                                    spec_types2 += ",";
                                }
                                spec_types += ps.SpecimenType.PhraseText;
                                spec_types2 += ps.SpecimenType.PhraseId;  //
                                have_one = true;

                                //  ps.AnimalId = rc.AnimalId;  // ToDO - check if this is correct
                                //  ps.Claimed = rc.Claimed;   // ToDO - check if this is correct
                                //  ps.Suffix = rc.Suffixes;    // ToDO - check if this is correct
                            }



                            EntityManager.Transaction.Add(ps);
                            EntityManager.Commit();



                        }

                        //08/01/2020
                        if (rc.SpecimenTypes != spec_types)
                        {

                            rc.SpecimenTypes = spec_types;
                            rc.SpecimenTypes2 = spec_types2;
                            EntityManager.Transaction.Add(rc);
                            EntityManager.Commit();
                        }

                        frm.SMMasterDetailGridRCSelection.RefreshRow(rc);
                    }
                    else  //  update for voided selection , so void is stored , also at specimen level 
                    {
                        EntityManager.Transaction.Add(rc);
                        EntityManager.Commit();
                        foreach (PSpecimenBase ps in rc.PSpecimens)  //11/20/2020  must set specimen void and add_specimen 
                        {
                            ps.Void = true;
                            ps.AddSpecimen = false;
                            EntityManager.Transaction.Add(ps);
                            EntityManager.Commit();
                        }


                    }

                    //11/14/2020 - check for dup in current set - query PRACECARD
                    IQuery qryPSR = EntityManager.CreateQuery(TableNames.PRaceCard);
                    qryPSR.AddEquals("ANIMAL_ID", rc.AnimalId);
                    qryPSR.AddAnd();
                    qryPSR.AddEquals("RACE_ID", m_RaceID);
                    qryPSR.AddAnd();
                    qryPSR.AddEquals("SELECTED", true);
                    //List<Object> specsR = EntityManager.SelectDistinct(qryPSR, "IDENTITY");

                    IEntityCollection specsR = EntityManager.Select(TableNames.PRaceCard, qryPSR);
                    if (specsR.Count > 1)
                    {
                        foreach (PRaceCardBase rcR in specsR)
                        {

                            Library.Utils.FlashMessage(rcR.HorseName + " Barcode Commission ID: " + rcR.AnimalId + "  used more than once in current race ", "Enter unique Barcode ID");
                            break;
                        }
                    }


                }

                //8/1/2021  - avoid reset of row ?
                /*
                IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

                qryRCS.AddEquals("RACE_ID", m_RaceID);
                qryRCS.AddAnd();
                qryRCS.AddEquals("SELECTED", true);

                IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);

                frm.SelectedCollection.Publish(RaceCardRCS);

                frm.SMMasterDetailGridRCSelection.Refresh();


                */

                frm.SelectedCollection.Data.Clear();
                frm.SelectedCollection.Data.RemoveAll();
                //frm.SMMasterDetailGridRCSelection.GridData.Clear();

                IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

                qryRCS.AddEquals("RACE_ID", m_RaceID);
                qryRCS.AddAnd();
                qryRCS.AddEquals("SELECTED", true);

                IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);


                System.Threading.Thread.Sleep(1000);


                foreach (PRaceCardExtended horse in RaceCardRCS)
                {
                    foreach (PSpecimenBase spec in horse.SpecimensWithCompleteCollectionData)
                    {
                        spec.RefreshDetailContent();

                    }
                    horse.RefreshDetailContent();
                    horse.SpecimensWithCompleteCollectionData.Refresh();
                    horse.SpecimensNonVoided.Refresh();
                }

                IQuery qryRC = EntityManager.CreateQuery(TableNames.PRaceCard);
                qryRC.AddEquals("SAMPLING_POINT", m_SamplePoint);
                qryRC.AddAnd();
                qryRC.AddEquals("RACE_ID", m_RaceID);
                qryRC.AddAnd();
                qryRC.AddEquals("RACE_NO", m_RaceNum);

                IEntityCollection RaceCardRC = EntityManager.Select(TableNames.PRaceCard, qryRC);

                frm.SMMasterDetailGridRaceCard.GridData = RaceCardRC;
                frm.SMMasterDetailGridRCSelection.GridData = RaceCardRCS;
                frm.SelectedCollection.Data.Refresh();
                frm.SMMasterDetailGridRCSelection.Refresh();
                frm.SMMasterDetailGridRCSelection.GridData.Reselect();
                frm.SMMasterDetailGridRCSelection.GridData.Refresh();
                //frm.SMMasterDetailGridRaceCard.GridData.Refresh();

            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage("Contact Support RaceID:  " + m_RaceID + " Error: " + ex.Message, "Error from BtnSaveSelectedManualClickAndWait ");
                Library.Utils.FlashMessage("Try ME - Save Selections again , if still error , exit race and relaod  ", "Try save again");
            }

            //07/31/2021

            try
            {
                foreach (PRaceCardBase prc in frm.SMMasterDetailGridRCSelection.GridData.ActiveItems)
                {
                    // 08/13/2021  - add check for specimen types on race card
                    string spec_types = "";
                    string spec_types2 = "";  // 03.03.2021
                    bool have_one = false;

                    foreach (PSpecimenBase ps in prc.PSpecimens)
                    {
                        bool update = false;

                        if (ps.AddSpecimen)
                        {
                            if (have_one)
                            {
                                spec_types += ",";
                                spec_types2 += ",";
                            }
                            spec_types += ps.SpecimenType.PhraseText;
                            spec_types2 += ps.SpecimenType.PhraseId;  //
                            have_one = true;

                            //  ps.AnimalId = rc.AnimalId;  // ToDO - check if this is correct
                            //  ps.Claimed = rc.Claimed;   // ToDO - check if this is correct
                            //  ps.Suffix = rc.Suffixes;    // ToDO - check if this is correct
                        }


                        if (ps.SamplingPoint.IsNull())  //07/31/2021  0 check sampleing point
                        {
                            update = true;

                            ps.SamplingPoint = m_SamplePoint;

                        }
                        if (ps.RaceDate.IsNull)
                        {
                            update = true;

                            ps.RaceDate = prc.RaceDate;
                        }
                        if (update)
                        {
                            EntityManager.Transaction.Add(ps);
                            EntityManager.Commit();
                        }

                    }

                    if (prc.SpecimenTypes != spec_types)
                    {

                        prc.SpecimenTypes = spec_types;
                        prc.SpecimenTypes2 = spec_types2;
                        EntityManager.Transaction.Add(prc);
                        EntityManager.Commit();
                        frm.SMMasterDetailGridRCSelection.RefreshRow(prc);


                    }




                }

                frm.SelectedCollection.Data.Clear();
                frm.SelectedCollection.Data.RemoveAll();
                //frm.SMMasterDetailGridRCSelection.GridData.Clear();

                IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

                qryRCS.AddEquals("RACE_ID", m_RaceID);
                qryRCS.AddAnd();
                qryRCS.AddEquals("SELECTED", true);

                IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);


                System.Threading.Thread.Sleep(1000);


                foreach (PRaceCardExtended horse in RaceCardRCS)
                {
                    foreach (PSpecimenBase spec in horse.SpecimensWithCompleteCollectionData)
                    {
                        spec.RefreshDetailContent();

                    }
                    horse.RefreshDetailContent();
                    horse.SpecimensWithCompleteCollectionData.Refresh();
                    horse.SpecimensNonVoided.Refresh();
                }



                frm.SMMasterDetailGridRCSelection.GridData = RaceCardRCS;
                frm.SelectedCollection.Data.Refresh();
                frm.SMMasterDetailGridRCSelection.Refresh();
                frm.SMMasterDetailGridRCSelection.GridData.Reselect();
                frm.SMMasterDetailGridRCSelection.GridData.Refresh();
            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage("Contact Support RaceID:  " + m_RaceID + " Error: " + ex.Message, "Error from BtnSaveSelectedManualClickAndWait ");

            }



        }


        void BtnSaveSelected_ClickAndWait(object sender, EventArgs e)
        {
            // bool exists = RaceExists(true);  //  commented out 2/27/20, race should exist - maybe error if not

            // 03/22/2021 - need alternate save for specials / manual 
            // 04/28/2021 - alternate only for manuals



            try
            {
                foreach (PRaceCardExtended rc in frm.SMMasterDetailGridRCSelection.GridData.ModifiedItems)   // 11/14/2020 change from  activeItems to modified
                {
                    if (!rc.Void)  // 6/30/2020  - exclude voided horses
                    {
                        string spec_types = "";
                        string spec_types2 = "";  // 03.30.2021 - for single letter types
                        bool have_one = false;

                        bool have_suffix = false;

                        string suffix = rc.Suffixes;
                        //  int sCount = 0;   //11/13/2021

                        // 04/30/2021 - check if numeric - TODO - maybe should not allow ?

                        try
                        {
                            int check = System.Convert.ToInt32(rc.AnimalId);
                        }
                        catch
                        {
                            Library.Utils.FlashMessage("Animal ID is not numeric , Animal ID: " + rc.AnimalId, "Check Horse: " + rc.HorseName);
                        }


                        if (suffix != "")
                        {
                            have_suffix = true;

                        }
                        // set suffixes

                        // for IM   From Deb email of 2/17/20:
                        //  Suffix = IM - Intact Male if gender = "H"(horse) or "C"(colt) , or "R"(ridgeling).But we need to add "m"(male) - done

                        if (rc.PreRaceLasix.ToString().Contains("L"))
                        {
                            if (!rc.Suffixes.Contains("F"))
                            {
                                if (have_suffix)
                                { suffix += ","; }

                                suffix += "F";
                                have_suffix = true;

                            }
                        }
                        if (rc.Gender == "H" || rc.Gender == "h")
                        {
                            if (!rc.Suffixes.Contains("IM"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "IM";
                                have_suffix = true;
                            }
                        }
                        else if (rc.Gender == "C" || rc.Gender == "c")
                        {
                            if (!rc.Suffixes.Contains("IM"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "IM";
                                have_suffix = true;
                            }
                        }
                        else if (rc.Gender == "R" || rc.Gender == "r")
                        {
                            if (!rc.Suffixes.Contains("IM"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "IM";
                                have_suffix = true;
                            }
                        }
                        //else if (rc.Gender == "m")   // 04/13/2021
                        //{
                        //    if (!rc.Suffixes.Contains("IM"))
                        //    {
                        //        if (have_suffix)
                        //        { suffix += ","; }
                        //        suffix += "IM";
                        //        have_suffix = true;
                        //    }
                        //}
                        if (rc.TestingReasons.ToString() == "C")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }
                        //04/23/2021  add CW
                        if (rc.TestingReasons.ToString() == "CW")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }
                        //05/17/2021  add CW2
                        if (rc.TestingReasons.ToString() == "C2")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }
                        //05/17/2021  add CSP
                        if (rc.TestingReasons.ToString() == "CSP")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }

                        // 11/13/2021 - Check for updated testing reasons - case when changed from Previous C
                        if (!rc.TestingReasons.ToString().Contains("C"))
                        {
                            if (rc.Suffixes.Contains("C"))
                            {

                                suffix = suffix.Replace('C', ' ');
                                suffix = suffix.TrimEnd(' ');
                                suffix = suffix.TrimEnd(',');
                                suffix = suffix.TrimStart(',');

                                rc.Claimed = false;
                                //have_suffix = true;
                            }
                        }
                        // end 11/13/2021

                        rc.Suffixes = suffix;

                        foreach (PSpecimenBase ps in rc.PSpecimens)
                        {
                            //  sCount++;
                            if (suffix.Contains("F"))   // 1/22/2021
                            {
                                ps.PreLasix = true;
                            }

                            ps.AnimalId = rc.AnimalId;  // ToDO - check if this is correct
                            ps.Claimed = rc.Claimed;   // ToDO - check if this is correct
                            ps.Suffix = rc.Suffixes;    // ToDO - check if this is correct
                            if (ps.SamplingPoint.IsNull())  //07/31/2021  0 check sampleing point
                            {
                                ps.SamplingPoint = m_SamplePoint;
                                ps.RaceDate = m_RaceDate;
                                ps.Container = "NONE";
                            }
                            if (ps.JobName == "")  // 08/06/2021 
                            { ps.JobName = m_JobName; }

                            if (ps.SpecimenType.ToString() != "" && ps.AddSpecimen)
                            {
                                if (have_one)
                                {
                                    spec_types += ",";

                                }
                                spec_types += ps.SpecimenType.PhraseText;
                                spec_types2 += ps.SpecimenType.PhraseId;
                                have_one = true;

                                //  ps.AnimalId = rc.AnimalId;  // ToDO - check if this is correct
                                //  ps.Claimed = rc.Claimed;   // ToDO - check if this is correct
                                //  ps.Suffix = rc.Suffixes;    // ToDO - check if this is correct
                            }

                            /*
                            if (ps.Suffix.ToString() != "" && ps.AddSpecimen)
                            {
                                if (have_suffix)
                                {
                                  //  suffix += ",";
                                }
                                if(!rc.Suffixes.Contains(ps.Suffix))
                                {
                                    suffix += ps.Suffix;
                                    have_suffix = true;
                                }

                            }
                            */


                            EntityManager.Transaction.Add(ps);
                            EntityManager.Commit();
                        }

                        //if (rc.NumSpecimens != sCount)   //11/13/2021
                        //{
                        //    rc.NumSpecimens = sCount;
                        //}

                        // rc.SpecimenTypes = spec_types;
                        rc.SpecimenTypes = spec_types;
                        rc.SpecimenTypes2 = spec_types2;
                        // rc.Suffixes = suffix;
                        //rc.PostTime = m_PostTime;  //  11/20/2020  now from selection grid

                        //06/13/2021 - check for random empty sample point 
                        if (rc.SamplingPoint.IsNull())
                        {
                            rc.SamplingPoint = m_SamplePoint;
                        }
                        EntityManager.Transaction.Add(rc);
                        EntityManager.Commit();

                        frm.SMMasterDetailGridRCSelection.RefreshRow(rc);

                        if (rc.SpecimenTypes == "")
                        {
                            Library.Utils.FlashMessage(rc.HorseName + " No Specimen types set ", "add specimen types and re-save");
                        }
                        if (rc.AnimalId == "")
                        {
                            Library.Utils.FlashMessage(rc.HorseName + " No Commission no set ", "add Commission no  and re-save");
                        }
                    }
                    else  // 11/14/2020 - add update for voided selection , so void is stored , also at specimen level 
                    {


                        EntityManager.Transaction.Add(rc);
                        EntityManager.Commit();

                        foreach (PSpecimenBase ps in rc.PSpecimens)  //11/20/2020  must set specimen void and add_specimen 
                        {
                            ps.Void = true;
                            ps.AddSpecimen = false;
                            EntityManager.Transaction.Add(ps);
                            EntityManager.Commit();
                       

                        }


                    }

                    //11/14/2020 - check for dup in current set - query PRACECARD
                    IQuery qryPSR = EntityManager.CreateQuery(TableNames.PRaceCard);
                    qryPSR.AddEquals("ANIMAL_ID", rc.AnimalId);
                    qryPSR.AddAnd();
                    qryPSR.AddEquals("RACE_ID", m_RaceID);
                    qryPSR.AddAnd();
                    qryPSR.AddEquals("SELECTED", true);
                    //List<Object> specsR = EntityManager.SelectDistinct(qryPSR, "IDENTITY");

                    IEntityCollection specsR = EntityManager.Select(TableNames.PRaceCard, qryPSR);
                    if (specsR.Count > 1)
                    {
                        foreach (PRaceCardBase rcR in specsR)
                        {

                            Library.Utils.FlashMessage(rcR.HorseName + " Barcode Commission ID: " + rcR.AnimalId + "  used more than once in current race ", "Enter unique Barcode ID");
                            break;
                        }
                    }

                }
                foreach (PRaceCardExtended rc in frm.SMMasterDetailGridRCSelection.GridData.UnchangedItems)   // 11/14/2020 change from  activeItems to modified
                {

                    foreach (PSpecimenBase ps in rc.PSpecimens)
                    {

                        ps.AnimalId = rc.AnimalId;  // ToDO - check if this is correct
                        ps.Claimed = rc.Claimed;   // ToDO - check if this is correct
                        ps.Suffix = rc.Suffixes;    // ToDO - check if this is correct
                        if (ps.SamplingPoint.IsNull())  //07/31/2021  0 check sampleing point
                        {
                            ps.SamplingPoint = m_SamplePoint;
                            ps.RaceDate = m_RaceDate;
                            ps.Container = "NONE";
                        }
                        if (ps.JobName == "")  // 08/06/2021 
                        { ps.JobName = m_JobName; }



                    }

                    if (rc.SamplingPoint.IsNull())
                    {
                        rc.SamplingPoint = m_SamplePoint;
                    }
                    EntityManager.Transaction.Add(rc);
                    EntityManager.Commit();

                    frm.SMMasterDetailGridRCSelection.RefreshRow(rc);

                    if (rc.SpecimenTypes == "")
                    {
                        Library.Utils.FlashMessage(rc.HorseName + " No Specimen types set ", "add specimen types and re-save");
                    }
                    if (rc.AnimalId == "")
                    {
                        Library.Utils.FlashMessage(rc.HorseName + " No Commission no set ", "add Commission no  and re-save");
                    }




                    //11/14/2020 - check for dup in current set - query PRACECARD
                    IQuery qryPSR = EntityManager.CreateQuery(TableNames.PRaceCard);
                    qryPSR.AddEquals("ANIMAL_ID", rc.AnimalId);
                    qryPSR.AddAnd();
                    qryPSR.AddEquals("RACE_ID", m_RaceID);
                    qryPSR.AddAnd();
                    qryPSR.AddEquals("SELECTED", true);
                    //List<Object> specsR = EntityManager.SelectDistinct(qryPSR, "IDENTITY");

                    IEntityCollection specsR = EntityManager.Select(TableNames.PRaceCard, qryPSR);
                    if (specsR.Count > 1)
                    {
                        foreach (PRaceCardBase rcR in specsR)
                        {

                            Library.Utils.FlashMessage(rcR.HorseName + " Barcode Commission ID: " + rcR.AnimalId + "  used more than once in current race ", "Enter unique Barcode ID");
                            break;
                        }

                    }

                }

                frm.SelectedCollection.Data.Clear();
                frm.SelectedCollection.Data.RemoveAll();
                //frm.SMMasterDetailGridRCSelection.GridData.Clear();

                IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

                qryRCS.AddEquals("RACE_ID", m_RaceID);
                qryRCS.AddAnd();
                qryRCS.AddEquals("SELECTED", true);

                IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);


                System.Threading.Thread.Sleep(1000);


                foreach (PRaceCardExtended horse in RaceCardRCS)
                {
                    foreach (PSpecimenBase spec in horse.SpecimensWithCompleteCollectionData)
                    {
                        spec.RefreshDetailContent();

                    }
                    horse.RefreshDetailContent();
                    horse.SpecimensWithCompleteCollectionData.Refresh();
                    horse.SpecimensNonVoided.Refresh();
                }

                IQuery qryRC = EntityManager.CreateQuery(TableNames.PRaceCard);
                qryRC.AddEquals("SAMPLING_POINT", m_SamplePoint);
                qryRC.AddAnd();
                qryRC.AddEquals("RACE_ID", m_RaceID);
                qryRC.AddAnd();
                qryRC.AddEquals("RACE_NO", m_RaceNum);

                IEntityCollection RaceCardRC = EntityManager.Select(TableNames.PRaceCard, qryRC);

                frm.SMMasterDetailGridRaceCard.GridData = RaceCardRC;

                frm.SMMasterDetailGridRCSelection.GridData = RaceCardRCS;
                frm.SelectedCollection.Data.Refresh();
                frm.SMMasterDetailGridRCSelection.Refresh();
                frm.SMMasterDetailGridRCSelection.GridData.Reselect();
                frm.SMMasterDetailGridRCSelection.GridData.Refresh();
                frm.SMMasterDetailGridRaceCard.GridData = RaceCardRC;
                //frm.SMMasterDetailGridRaceCard.Refresh();


            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage("Contact Support RaceID:  " + m_RaceID + " Error: " + ex.Message, "Error from btnSaveSelectedClickAndWait ");
            }




            ////07/31/2021

            //foreach (PRaceCardBase prc in frm.SMMasterDetailGridRCSelection.GridData.ActiveItems)
            //{
            //    foreach (PSpecimenBase ps in prc.PSpecimens)
            //    {
            //        bool update = false;
            //        if (ps.SamplingPoint.IsNull())  //07/31/2021  0 check sampleing point
            //        {
            //            update = true;

            //            ps.SamplingPoint = m_SamplePoint;
            //            ps.Container = "NONE";

            //        }
            //        if (ps.RaceDate.IsNull)
            //        {
            //            update = true;

            //            ps.RaceDate = prc.RaceDate;
            //            ps.Container = "NONE";
            //        }
            //        if (update)
            //        {
            //            EntityManager.Transaction.Add(ps);
            //            EntityManager.Commit();
            //        }

            //    }


            //}

            //07/31/2021

            try
            {
                foreach (PRaceCardBase prc in frm.SMMasterDetailGridRCSelection.GridData.ActiveItems)
                {
                    // 08/13/2021  - add check for specimen types on race card
                    string spec_types = "";
                    string spec_types2 = "";  // 03.03.2021
                    bool have_one = false;

                    foreach (PSpecimenBase ps in prc.PSpecimens)
                    {
                        bool update = false;

                        if (ps.AddSpecimen)
                        {
                            if (have_one)
                            {
                                spec_types += ",";
                                spec_types2 += ",";
                            }
                            spec_types += ps.SpecimenType.PhraseText;
                            spec_types2 += ps.SpecimenType.PhraseId;  //
                            have_one = true;

                            //  ps.AnimalId = rc.AnimalId;  // ToDO - check if this is correct
                            //  ps.Claimed = rc.Claimed;   // ToDO - check if this is correct
                            //  ps.Suffix = rc.Suffixes;    // ToDO - check if this is correct
                        }


                        if (ps.SamplingPoint.IsNull())  //07/31/2021  0 check sampleing point
                        {
                            update = true;

                            ps.SamplingPoint = m_SamplePoint;

                        }
                        if (ps.RaceDate.IsNull)
                        {
                            update = true;

                            ps.RaceDate = prc.RaceDate;
                        }
                        if (update)
                        {
                            EntityManager.Transaction.Add(ps);
                            EntityManager.Commit();
                        }
                        if (ps.AddSpecimen != true)
                        {

                        }

                    } // end foreach specimen

                    if (prc.SpecimenTypes != spec_types)
                    {

                        prc.SpecimenTypes = spec_types;
                        prc.SpecimenTypes2 = spec_types2;
                        EntityManager.Transaction.Add(prc);
                        EntityManager.Commit();
                        frm.SMMasterDetailGridRCSelection.RefreshRow(prc);

                    }




                } //end for each race card

                frm.SelectedCollection.Data.Clear();
                frm.SelectedCollection.Data.RemoveAll();
                //frm.SMMasterDetailGridRCSelection.GridData.Clear();

                IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

                qryRCS.AddEquals("RACE_ID", m_RaceID);
                qryRCS.AddAnd();
                qryRCS.AddEquals("SELECTED", true);

                IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);


                System.Threading.Thread.Sleep(1000);


                foreach (PRaceCardExtended horse in RaceCardRCS)
                {
                    foreach (PSpecimenBase spec in horse.SpecimensWithCompleteCollectionData)
                    {
                        spec.RefreshDetailContent();

                    }
                    horse.RefreshDetailContent();
                    horse.SpecimensWithCompleteCollectionData.Refresh();
                    horse.SpecimensNonVoided.Refresh();
                }



                frm.SMMasterDetailGridRCSelection.GridData = RaceCardRCS;
                frm.SelectedCollection.Data.Refresh();
                frm.SMMasterDetailGridRCSelection.Refresh();
                frm.SMMasterDetailGridRCSelection.GridData.Reselect();
                frm.SMMasterDetailGridRCSelection.GridData.Refresh();
            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage("Contact Support RaceID:  " + m_RaceID + " Error: " + ex.Message, "Error from btnSaveSelectedClickAndWait ");
            }





        }


        private void BtnAddSelectedManual_ClickAndWait(object sender, EventArgs e)
        {

            try
            {
                foreach (PRaceCardBase rc in frm.SMMasterDetailGridRaceCard.GridData.ActiveItems)  //   Active items for special / manual; the form changes don't make it modified 
                {

                    if (rc.Selected)
                    {
                        // rc.Selected = true;
                        // rc.JobName = m_JobName;

                        //// rc.Suffixes = suffix;

                        // EntityManager.Transaction.Add(rc);
                        // EntityManager.Commit();

                        // 


                        // 7/7/20 - add checks for animal Id / barcode comm id
                        if (rc.AnimalId == "")
                        {
                            Library.Utils.FlashMessage("no Barcode Commission ID for selected horse:  " + rc.HorseName, "Enter Barcode ID");
                            return;
                        }
                        // check if used in previous race
                        IQuery qryPS = EntityManager.CreateQuery(TableNames.PSpecimen);

                        qryPS.AddEquals("ANIMAL_ID", rc.AnimalId);
                        qryPS.AddAnd();
                        qryPS.AddNotEquals("RACE_ID", m_RaceID);

                        IEntityCollection specs0 = EntityManager.Select(TableNames.PSpecimen, qryPS);
                        if (specs0.Count > 0)
                        {
                            Library.Utils.FlashMessage(rc.HorseName + " Barcode Commission ID: " + rc.AnimalId + " already used in previous race ", "Enter unique Barcode ID");
                            return;
                        }

                        // 04/30/2021 - check if numeric - TODO - maybe should not allow ?

                        try
                        {
                            int check = System.Convert.ToInt32(rc.AnimalId);
                        }
                        catch
                        {
                            Library.Utils.FlashMessage("Animal ID is not numeric , Animal ID: " + rc.AnimalId, "Check Horse: " + rc.HorseName);
                        }

                        //10/21/2021  - for manual , add in the claimed and suffix settings , apparently needed for manual also

                        bool have_suffix = false;
                        string suffix = rc.Suffixes;

                        if (suffix != "")
                        {
                            have_suffix = true;

                        }



                        rc.Selected = true;
                        rc.JobName = m_JobName;

                        if (rc.PreRaceLasix.ToString().Contains("L"))
                        {
                            if (!rc.Suffixes.Contains("F"))
                            {
                                if (have_suffix)
                                { suffix += ","; }

                                suffix += "F";
                                have_suffix = true;
                            }
                        }
                        if (rc.Gender == "H")
                        {
                            if (!rc.Suffixes.Contains("IM"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "IM";
                                have_suffix = true;
                            }
                        }
                        else if (rc.Gender == "C")
                        {
                            if (!rc.Suffixes.Contains("IM"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "IM";
                                have_suffix = true;
                            }
                        }
                        else if (rc.Gender == "R")
                        {
                            if (!rc.Suffixes.Contains("IM"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "IM";
                                have_suffix = true;
                            }
                        }

                        //claimed

                        if (rc.TestingReasons.ToString() == "C")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }

                        if (rc.TestingReasons.ToString() == "CW")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }

                        if (rc.TestingReasons.ToString() == "C2")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }

                        if (rc.TestingReasons.ToString() == "CSP")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }
                        // 11/13/2021 - Check for updated testing reasons - case when changed from Previous C
                        if (!rc.TestingReasons.ToString().Contains("C"))
                        {
                            if (rc.Suffixes.Contains("C"))
                            {

                                suffix = suffix.Replace('C', ' ');
                                suffix = suffix.TrimEnd(' ');
                                suffix = suffix.TrimEnd(',');
                                suffix = suffix.TrimStart(',');
                                rc.Claimed = false;
                                //have_suffix = true;
                            }
                        }
                        // end 11/13/2021

                        rc.Suffixes = suffix;


                        //end 10/21/2021


                        //specimen table - user sets specimen type , just add first specimen



                        IQuery qryPSB = EntityManager.CreateQuery(TableNames.PSpecimen);

                        // qryPSB.AddEquals("ANIMAL_ID", rc.AnimalId);  //12/11/2021
                        qryPSB.AddEquals("RACE_ID", rc.RaceId);
                        qryPSB.AddAnd();
                        qryPSB.AddEquals("RACE_CARD_ID", rc.Identity);

                        int sCount = rc.NumSpecimens;



                        IEntityCollection specs = EntityManager.Select(TableNames.PSpecimen, qryPSB);
                        // if (specs.Count == 0)  // only add first one with initial add
                        if (specs.Count < sCount)  // 08/11/2021 - follow setting from  race card
                        {
                            // 08/11/2021 - need phrase to add specimen type , show only not selected ones
                            string[] used = rc.SpecimenTypes2.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);

                            IQuery qSpecTypes = EntityManager.CreateQuery(TableNames.Phrase);
                            qSpecTypes.AddEquals("PHRASE", "SPECIMEN_S");
                            foreach (string s in used)
                            {
                                qSpecTypes.AddAnd();
                                qSpecTypes.AddNotEquals("PHRASE_ID", s);
                            }


                            IEntityCollection pSpecTypes = EntityManager.Select(TableNames.Phrase, qSpecTypes);


                            // IEntity phrase p = new IEntity();
                            IEntity p = EntityManager.CreateEntity(Phrase.EntityName);
                            Library.Utils.PromptForEntity("Select", "Specimen type", pSpecTypes, out p);

                            if (p == null)
                            {
                                Library.Utils.FlashMessage("Must Select specimen type to add specimen", "Select Specimen Type at Prompt");
                                return;
                            }

                            IEntity entitySB;
                            entitySB = EntityManager.CreateEntity(PSpecimenBase.EntityName);
                            entitySB.SetField("RACE_ID", (PackedDecimal)rc.RaceId.ToString());
                            entitySB.SetField("RACE_CARD_ID", (PackedDecimal)rc.Identity.ToString());
                            //  entitySB.SetField("IDENTITY", rc.Identity);
                            entitySB.SetField("SPECIMEN_TYPE", p.Name);
                            entitySB.SetField("ADD_SPECIMEN", true);
                            entitySB.SetField("JOB_NAME", m_JobName);
                            entitySB.SetField("CONTAINER", "NONE");
                            entitySB.SetField("SAMPLING_POINT", rc.SamplingPoint);
                            entitySB.SetField("RACE_DATE", rc.RaceDate);
                            entitySB.SetField("SUFFIX", rc.Suffixes);  // 10/21/2021 - add suffixes for manual
                            entitySB.SetField("ANIMAL_ID", rc.AnimalId);

                            //10/21/2021
                            entitySB.SetField("CLAIMED", rc.Claimed);
                            entitySB.SetField("SUFFIX", rc.Suffixes);

                            EntityManager.Transaction.Add(entitySB);
                            EntityManager.Commit();
                        }



                        EntityManager.Transaction.Add(rc);    // 08/11/2021
                        EntityManager.Commit();

                        frm.SMMasterDetailGridRaceCard.RefreshRow(rc);
                    }

                }
                frm.SMMasterDetailGridRaceCard.Refresh();

                // populate selected grid - all races for race id
                IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

                qryRCS.AddEquals("RACE_ID", m_RaceID);
                qryRCS.AddAnd();
                qryRCS.AddEquals("SELECTED", true);

                IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);

                frm.SelectedCollection.Publish(RaceCardRCS);
                frm.SMMasterDetailGridRCSelection.Refresh();



                //07/31/2021

                foreach (PRaceCardBase prc in frm.SMMasterDetailGridRCSelection.GridData.ActiveItems)
                {
                    frm.SMMasterDetailGridRCSelection.RefreshRow(prc);  // 08/11/2021
                    foreach (PSpecimenBase ps in prc.PSpecimens)
                    {
                        bool update = false;
                        if (ps.SamplingPoint.IsNull())  //07/31/2021  0 check sampleing point
                        {
                            update = true;

                            ps.SamplingPoint = m_SamplePoint;
                            ps.Container = "NONE";

                        }
                        if (ps.RaceDate.IsNull)
                        {
                            update = true;

                            ps.RaceDate = prc.RaceDate;
                            ps.Container = "NONE";
                        }
                        if (update)
                        {
                            EntityManager.Transaction.Add(ps);
                            EntityManager.Commit();
                        }

                    }


                }

                frm.SelectedCollection.Data.Clear();
                frm.SelectedCollection.Data.RemoveAll();
                //frm.SMMasterDetailGridRCSelection.GridData.Clear();


                System.Threading.Thread.Sleep(1000);


                foreach (PRaceCardExtended horse in RaceCardRCS)
                {
                    foreach (PSpecimenBase spec in horse.SpecimensWithCompleteCollectionData)
                    {
                        spec.RefreshDetailContent();

                    }
                    horse.RefreshDetailContent();
                    horse.SpecimensWithCompleteCollectionData.Refresh();
                    horse.SpecimensNonVoided.Refresh();

                }

                IQuery qryRC = EntityManager.CreateQuery(TableNames.PRaceCard);
                qryRC.AddEquals("SAMPLING_POINT", m_SamplePoint);
                qryRC.AddAnd();
                qryRC.AddEquals("RACE_ID", m_RaceID);
                qryRC.AddAnd();
                qryRC.AddEquals("RACE_NO", m_RaceNum);

                IEntityCollection RaceCardRC = EntityManager.Select(TableNames.PRaceCard, qryRC);



                frm.SMMasterDetailGridRCSelection.GridData = RaceCardRCS;
                frm.SelectedCollection.Data.Refresh();
                frm.SMMasterDetailGridRCSelection.Refresh();
                frm.SMMasterDetailGridRCSelection.GridData.Reselect();
                frm.SMMasterDetailGridRCSelection.GridData.Refresh();
                frm.SMMasterDetailGridRaceCard.GridData = RaceCardRC;
                frm.SMMasterDetailGridRaceCard.GridData.Reselect();

            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage("Contact Support RaceID:  " + m_RaceID + " Error: " + ex.Message, "Error from btnAddSelected ");
            }
        }

        /// <summary>
        /// for Race card entry, toggle selected, add B and U specimens
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void BtnAddSelected_ClickAndWait(object sender, EventArgs e)
        {
            // 03/22/2021  - allow for add selected from manual / special 
            if (m_Accession_type == "1" || m_Accession_type == "Race Day Samples" || m_Accession_type == "2")
            {



                //  List<object> selection = new List<object>();
                try
                {

                    foreach (PRaceCardBase rc in frm.SMMasterDetailGridRaceCard.GridData.ModifiedItems)  // 11/14/2020 change from activeitems to modified
                    {


                        if (rc.Selected)
                        {

                            // 7/7/20 - add checks for animal Id / barcode comm id
                            if (rc.AnimalId == "")
                            {
                                Library.Utils.FlashMessage("no Barcode Commission ID for selected horse:  " + rc.HorseName, "Enter Barcode ID");
                                return;
                            }
                            // check if used in previous race
                            IQuery qryPS = EntityManager.CreateQuery(TableNames.PSpecimen);

                            qryPS.AddEquals("ANIMAL_ID", rc.AnimalId);
                            qryPS.AddAnd();
                            qryPS.AddNotEquals("RACE_ID", m_RaceID);

                            IEntityCollection specs = EntityManager.Select(TableNames.PSpecimen, qryPS);
                            if (specs.Count > 0)
                            {
                                Library.Utils.FlashMessage(rc.HorseName + " Barcode Commission ID: " + rc.AnimalId + " already used in previous race ", "Enter unique Barcode ID");
                                return;
                            }


                            //11/14/2020 - check for dup in current set 
                            // doesnt work for previous correct saves
                            foreach (PRaceCardBase rcc in frm.SMMasterDetailGridRCSelection.GridData.UnchangedItems)
                            {
                                if (rc.AnimalId == rcc.AnimalId)
                                {
                                    Library.Utils.FlashMessage(rc.HorseName + " Barcode Commission ID: " + rc.AnimalId + " already used in current race ", "Enter unique Barcode ID");
                                    return;
                                }
                            }

                            // 04/30/2021 - check if numeric - TODO - maybe should not allow ?

                            try
                            {
                                int check = System.Convert.ToInt32(rc.AnimalId);
                            }
                            catch
                            {
                                Library.Utils.FlashMessage("Animal ID is not numeric , Animal ID: " + rc.AnimalId, "Check Horse: " + rc.HorseName);
                            }

                            bool have_suffix = false;
                            string suffix = rc.Suffixes;

                            if (suffix != "")
                            {
                                have_suffix = true;

                            }



                            rc.Selected = true;
                            rc.JobName = m_JobName;

                            if (rc.PreRaceLasix.ToString().Contains("L"))
                            {
                                if (!rc.Suffixes.Contains("F"))
                                {
                                    if (have_suffix)
                                    { suffix += ","; }

                                    suffix += "F";
                                    have_suffix = true;
                                }
                            }
                            if (rc.Gender == "H")
                            {
                                if (!rc.Suffixes.Contains("IM"))
                                {
                                    if (have_suffix)
                                    { suffix += ","; }
                                    suffix += "IM";
                                    have_suffix = true;
                                }
                            }
                            else if (rc.Gender == "C")
                            {
                                if (!rc.Suffixes.Contains("IM"))
                                {
                                    if (have_suffix)
                                    { suffix += ","; }
                                    suffix += "IM";
                                    have_suffix = true;
                                }
                            }
                            else if (rc.Gender == "R")
                            {
                                if (!rc.Suffixes.Contains("IM"))
                                {
                                    if (have_suffix)
                                    { suffix += ","; }
                                    suffix += "IM";
                                    have_suffix = true;
                                }
                            }



                            if (rc.TestingReasons.ToString() == "C")
                            {
                                if (!rc.Suffixes.Contains("C"))
                                {
                                    if (have_suffix)
                                    { suffix += ","; }
                                    suffix += "C";
                                    rc.Claimed = true;
                                    have_suffix = true;

                                }
                            }

                            //04/23/2021  add CW
                            if (rc.TestingReasons.ToString() == "CW")
                            {
                                if (!rc.Suffixes.Contains("C"))
                                {
                                    if (have_suffix)
                                    { suffix += ","; }
                                    suffix += "C";
                                    rc.Claimed = true;
                                    have_suffix = true;
                                }
                            }
                            rc.Suffixes = suffix;
                            // rc.PostTime = m_PostTime; //  11/20/2020 usint post time from grid
                            //06/13/2021 - check for random empty sample point 
                            if (rc.SamplingPoint.IsNull())
                            {
                                rc.SamplingPoint = m_SamplePoint;
                            }

                            //EntityManager.Transaction.Add(rc);   // 11/13/2021 - move below to get numspecimens
                            //EntityManager.Commit();


                            // 
                            // int sCount = 0;  //11/13/2021
                            //specimen table - blood

                            IQuery qryPSB = EntityManager.CreateQuery(TableNames.PSpecimen);

                            //qryPSB.AddEquals("ANIMAL_ID", rc.AnimalId);  // 12/11/2021   
                            qryPSB.AddEquals("RACE_ID", rc.RaceId);
                            qryPSB.AddAnd();
                            qryPSB.AddEquals("RACE_CARD_ID", rc.Identity);
                            qryPSB.AddAnd();
                            qryPSB.AddEquals("SPECIMEN_TYPE", "B");
                            IEntityCollection bloods = EntityManager.Select(TableNames.PSpecimen, qryPSB);
                            if (bloods.Count == 0)
                            {
                                IEntity entitySB;
                                entitySB = EntityManager.CreateEntity(PSpecimenBase.EntityName);
                                entitySB.SetField("RACE_ID", (PackedDecimal)rc.RaceId.ToString());
                                entitySB.SetField("RACE_CARD_ID", (PackedDecimal)rc.Identity.ToString());
                                //  entitySB.SetField("IDENTITY", rc.Identity);
                                entitySB.SetField("SPECIMEN_TYPE", "B");
                                entitySB.SetField("ADD_SPECIMEN", true);
                                entitySB.SetField("JOB_NAME", m_JobName);
                                entitySB.SetField("CONTAINER", "NONE");
                                entitySB.SetField("SAMPLING_POINT", rc.SamplingPoint);
                                entitySB.SetField("RACE_DATE", rc.RaceDate);
                                entitySB.SetField("SUFFIX", rc.Suffixes);
                                entitySB.SetField("ANIMAL_ID", rc.AnimalId);


                                EntityManager.Transaction.Add(entitySB);
                                EntityManager.Commit();
                                //  sCount++;
                            }
                            else
                            {
                                // sCount = bloods.Count;
                            }
                            //  may be a 2nd save on same session
                            //  else
                            //  {
                            //      Library.Utils.FlashMessage(" - This Animal ID - barcode has already been used, it will not assign correctly", "Check barcode " + rc.AnimalId);
                            //  }




                            IQuery qryPSU = EntityManager.CreateQuery(TableNames.PSpecimen);

                            // qryPSU.AddEquals("ANIMAL_ID", rc.AnimalId);  // 12/11/2021  
                            qryPSU.AddEquals("RACE_ID", rc.RaceId);
                            qryPSU.AddAnd();
                            qryPSU.AddEquals("RACE_CARD_ID", rc.Identity);
                            qryPSU.AddAnd();
                            qryPSU.AddEquals("SPECIMEN_TYPE", "U");
                            IEntityCollection urines = EntityManager.Select(TableNames.PSpecimen, qryPSU);

                            if (urines.Count == 0)
                            {

                                //specimen table - urine
                                IEntity entitySU;
                                entitySU = EntityManager.CreateEntity(PSpecimenBase.EntityName);

                                entitySU.SetField("RACE_ID", (PackedDecimal)rc.RaceId.ToString());
                                entitySU.SetField("RACE_CARD_ID", (PackedDecimal)rc.Identity.ToString());
                                // entitySU.SetField("IDENTITY", rc.Identity);
                                entitySU.SetField("SPECIMEN_TYPE", "U");
                                entitySU.SetField("ADD_SPECIMEN", true);
                                entitySU.SetField("JOB_NAME", m_JobName);
                                entitySU.SetField("CONTAINER", "NONE");
                                entitySU.SetField("SAMPLING_POINT", rc.SamplingPoint);
                                entitySU.SetField("RACE_DATE", rc.RaceDate);
                                entitySU.SetField("SUFFIX", rc.Suffixes);
                                entitySU.SetField("ANIMAL_ID", rc.AnimalId);

                                EntityManager.Transaction.Add(entitySU);
                                EntityManager.Commit();
                                // sCount++;
                            }
                            else
                            {
                                //  sCount = sCount + urines.Count;
                            }

                            // rc.NumSpecimens = sCount;
                            EntityManager.Transaction.Add(rc);
                            EntityManager.Commit();

                            //11/14/2020 - check for dup in current set - query PRACECARD
                            IQuery qryPSR = EntityManager.CreateQuery(TableNames.PRaceCard);
                            qryPSR.AddEquals("ANIMAL_ID", rc.AnimalId);
                            qryPSR.AddAnd();
                            qryPSR.AddEquals("RACE_ID", m_RaceID);
                            qryPSR.AddAnd();
                            qryPSR.AddEquals("SELECTED", true);
                            //List<Object> specsR = EntityManager.SelectDistinct(qryPSR, "IDENTITY");

                            IEntityCollection specsR = EntityManager.Select(TableNames.PRaceCard, qryPSR);
                            if (specsR.Count > 1)
                            {
                                foreach (PRaceCardBase rcR in specsR)
                                {

                                    Library.Utils.FlashMessage(rcR.HorseName + " Barcode Commission ID: " + rcR.AnimalId + "  used more than once in current race ", "Enter unique Barcode ID");
                                    break;
                                }
                            }

                        }
                        //else // update entry number and post time in case changed   // 11/20/2020  moving post time to selected horses
                        //{
                        //    if (rc.PropertyHasChanged("ENTRY_NUM") || rc.PropertyHasChanged("POST_TIME"))
                        //    {
                        //        // rc.PostTime = m_PostTime;
                        //        EntityManager.Transaction.Add(rc);
                        //        EntityManager.Commit();
                        //    }
                        //}

                        // check race card , if barcode is assigned to a  selected row
                        //TODO - this needs work, maybe check as soon as added
                        /*
                        IQuery qryPRC = EntityManager.CreateQuery(TableNames.PRaceCard);

                        qryPRC.AddEquals("ANIMAL_ID", rc.AnimalId);
                        qryPRC.AddAnd();
                        qryPRC.AddEquals("RACE_ID", m_RaceID);
                         qryPRC.AddAnd();
                          qryPRC.AddEquals("SELECTED", true);

                        IEntityCollection rc2 = EntityManager.Select(TableNames.PRaceCard, qryPRC);
                        if (rc2.Count > 1)
                        {
                            Library.Utils.FlashMessage(rc.HorseName + " Barcode Commission ID: " + rc.AnimalId + " already used in current race ", "Check barcode entries - Enter unique Barcode ID");

                        }

                        */




                    }



                    m_RaceNum = frm.SpinEditRaceNum.Number;

                    frm.SMMasterDetailGridRaceCard.Refresh();

                    // populate selected grid - all races for date - change to matching race ID Jan 5 2020

                    IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

                    qryRCS.AddEquals("RACE_ID", m_RaceID);
                    qryRCS.AddAnd();
                    qryRCS.AddEquals("SELECTED", true);

                    IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);

                    frm.SelectedCollection.Data.Clear();
                    frm.SelectedCollection.Data.RemoveAll();
                    //frm.SMMasterDetailGridRCSelection.GridData.Clear();



                    System.Threading.Thread.Sleep(1000);


                    foreach (PRaceCardExtended horse in RaceCardRCS)
                    {
                        foreach (PSpecimenBase spec in horse.SpecimensWithCompleteCollectionData)
                        {
                            spec.RefreshDetailContent();

                        }
                        horse.RefreshDetailContent();
                        horse.SpecimensWithCompleteCollectionData.Refresh();
                        horse.SpecimensNonVoided.Refresh();
                    }



                    frm.SMMasterDetailGridRCSelection.GridData = RaceCardRCS;
                    frm.SelectedCollection.Data.Refresh();
                    frm.SMMasterDetailGridRCSelection.Refresh();
                    frm.SMMasterDetailGridRCSelection.GridData.Reselect();
                    frm.SMMasterDetailGridRCSelection.GridData.Refresh();  // 8/31/22 commented out due to index issue



                    //  11/14/2020 - specimen detail not refreshing after duplicate correction
                    //11/20/2020  - try not doing this
                    //IQuery qryS = EntityManager.CreateQuery(TableNames.PSpecimen);
                    //qryS.AddEquals("RACE_ID", m_RaceID);
                    //IEntityCollection RaceCardSpec = EntityManager.Select(TableNames.PSpecimen, qryS);
                    //frm.SpecimenCollection.Publish(RaceCardSpec);


                    // RaceExists(false);  // grid not refreshing 

                }
                catch (Exception ex)
                {
                    Library.Utils.FlashMessage("Contact Support RaceID:  " + m_RaceID + " Error: " + ex.Message, "Error from btnAddSelected ");
                }
            }
            else  // special
            {
                try
                {
                    foreach (PRaceCardBase rc in frm.SMMasterDetailGridRaceCard.GridData.ModifiedItems)  //   Active items for special / manual; the form changes don't make it modified 
                    {

                        if (rc.Selected)
                        {

                            //04/28/2021 
                            //  add suffixes for specials 



                            // 7/7/20 - add checks for animal Id / barcode comm id
                            if (rc.AnimalId == "")
                            {
                                Library.Utils.FlashMessage("no Barcode Commission ID for selected horse:  " + rc.HorseName, "Enter Barcode ID");
                                return;
                            }
                            // check if used in previous race
                            IQuery qryPS = EntityManager.CreateQuery(TableNames.PSpecimen);

                            qryPS.AddEquals("ANIMAL_ID", rc.AnimalId);
                            qryPS.AddAnd();
                            qryPS.AddNotEquals("RACE_ID", m_RaceID);

                            IEntityCollection specs0 = EntityManager.Select(TableNames.PSpecimen, qryPS);
                            if (specs0.Count > 0)
                            {
                                Library.Utils.FlashMessage(rc.HorseName + " Barcode Commission ID: " + rc.AnimalId + " already used in previous race ", "Enter unique Barcode ID");
                                return;
                            }


                            //11/14/2020 - check for dup in current set 
                            // doesnt work for previous correct saves
                            foreach (PRaceCardBase rcc in frm.SMMasterDetailGridRCSelection.GridData.UnchangedItems)
                            {
                                if (rc.AnimalId == rcc.AnimalId)
                                {
                                    Library.Utils.FlashMessage(rc.HorseName + " Barcode Commission ID: " + rc.AnimalId + " already used in current race ", "Enter unique Barcode ID");
                                    return;
                                }
                            }


                            //04/28/2021  
                            // add suffixes for specials

                            bool have_suffix = false;
                            string suffix = rc.Suffixes;

                            if (suffix != "")
                            {
                                have_suffix = true;

                            }



                            rc.Selected = true;
                            rc.JobName = m_JobName;

                            if (rc.PreRaceLasix.ToString().Contains("L"))
                            {
                                if (!rc.Suffixes.Contains("F"))
                                {
                                    if (have_suffix)
                                    { suffix += ","; }

                                    suffix += "F";
                                    have_suffix = true;
                                }
                            }
                            if (rc.Gender == "H")
                            {
                                if (!rc.Suffixes.Contains("IM"))
                                {
                                    if (have_suffix)
                                    { suffix += ","; }
                                    suffix += "IM";
                                    have_suffix = true;
                                }
                            }
                            else if (rc.Gender == "C")
                            {
                                if (!rc.Suffixes.Contains("IM"))
                                {
                                    if (have_suffix)
                                    { suffix += ","; }
                                    suffix += "IM";
                                    have_suffix = true;
                                }
                            }
                            else if (rc.Gender == "R")
                            {
                                if (!rc.Suffixes.Contains("IM"))
                                {
                                    if (have_suffix)
                                    { suffix += ","; }
                                    suffix += "IM";
                                    have_suffix = true;
                                }
                            }



                            if (rc.TestingReasons.ToString() == "C")
                            {
                                if (!rc.Suffixes.Contains("C"))
                                {
                                    if (have_suffix)
                                    { suffix += ","; }
                                    suffix += "C";
                                    rc.Claimed = true;
                                    have_suffix = true;

                                }
                            }

                            //04/23/2021  add CW
                            if (rc.TestingReasons.ToString() == "CW")
                            {
                                if (!rc.Suffixes.Contains("C"))
                                {
                                    if (have_suffix)
                                    { suffix += ","; }
                                    suffix += "C";
                                    rc.Claimed = true;
                                    have_suffix = true;
                                }
                            }
                            rc.Suffixes = suffix;
                            // rc.PostTime = m_PostTime; //  11/20/2020 usint post time from grid
                            EntityManager.Transaction.Add(rc);
                            EntityManager.Commit();

                            // end 04/28/2021

                            //specimen table - user sets specimen type , just add first specimen



                            IQuery qryPSB = EntityManager.CreateQuery(TableNames.PSpecimen);

                            //qryPSB.AddEquals("ANIMAL_ID", rc.AnimalId);  // 12/11/2021 
                            qryPSB.AddEquals("RACE_ID", rc.RaceId);
                            qryPSB.AddAnd();
                            qryPSB.AddEquals("RACE_CARD_ID", rc.Identity);


                            //  will these have ID ?
                            //  qryPSB.AddAnd();
                            //  qryPSB.AddEquals("SPECIMEN_TYPE", "B");
                            //  IEntityCollection specs = EntityManager.Select(TableNames.PSpecimen, qryPSB);
                            //if (specs.Count == 0)  // only add first one
                            //{
                            //    IEntity entitySB;
                            //    entitySB = EntityManager.CreateEntity(PSpecimenBase.EntityName);
                            //    entitySB.SetField("RACE_ID", (PackedDecimal)rc.RaceId.ToString());
                            //    entitySB.SetField("RACE_CARD_ID", (PackedDecimal)rc.Identity.ToString());
                            //    entitySB.SetField("IDENTITY", rc.Identity);
                            //    entitySB.SetField("SPECIMEN_TYPE", "B");
                            //    entitySB.SetField("ADD_SPECIMEN", true);
                            //    entitySB.SetField("JOB_NAME", m_JobName);
                            //    entitySB.SetField("CONTAINER", "NONE");
                            //    entitySB.SetField("SAMPLING_POINT", rc.SamplingPoint);
                            //    entitySB.SetField("RACE_DATE", rc.RaceDate);
                            //    entitySB.SetField("SUFFIX", rc.Suffixes);
                            //    entitySB.SetField("ANIMAL_ID", rc.AnimalId);


                            //    EntityManager.Transaction.Add(entitySB);
                            //    EntityManager.Commit();
                            //}
                            // 08/13/2021 - change add for specials
                            int sCount = rc.NumSpecimens;

                            IEntityCollection specs = EntityManager.Select(TableNames.PSpecimen, qryPSB);
                            // if (specs.Count == 0)  // only add first one with initial add
                            if (specs.Count < sCount)  // 08/11/2021 - follow setting from  race card
                            {
                                // 08/11/2021 - need phrase to add specimen type , show only not selected ones
                                string[] used = rc.SpecimenTypes2.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);

                                IQuery qSpecTypes = EntityManager.CreateQuery(TableNames.Phrase);
                                qSpecTypes.AddEquals("PHRASE", "SPECIMEN_S");
                                foreach (string s in used)
                                {
                                    qSpecTypes.AddAnd();
                                    qSpecTypes.AddNotEquals("PHRASE_ID", s);
                                }


                                IEntityCollection pSpecTypes = EntityManager.Select(TableNames.Phrase, qSpecTypes);


                                // IEntity phrase p = new IEntity();
                                IEntity p = EntityManager.CreateEntity(Phrase.EntityName);
                                Library.Utils.PromptForEntity("Select", "Specimen type", pSpecTypes, out p);

                                if (p == null)
                                {
                                    Library.Utils.FlashMessage("Must Select specimen type to add specimen", "Select Specimen Type at Prompt");
                                    return;
                                }

                                IEntity entitySB;
                                entitySB = EntityManager.CreateEntity(PSpecimenBase.EntityName);
                                entitySB.SetField("RACE_ID", (PackedDecimal)rc.RaceId.ToString());
                                entitySB.SetField("RACE_CARD_ID", (PackedDecimal)rc.Identity.ToString());
                                //  entitySB.SetField("IDENTITY", rc.Identity);
                                entitySB.SetField("SPECIMEN_TYPE", p.Name);
                                entitySB.SetField("ADD_SPECIMEN", true);
                                entitySB.SetField("JOB_NAME", m_JobName);
                                entitySB.SetField("CONTAINER", "NONE");
                                entitySB.SetField("SAMPLING_POINT", rc.SamplingPoint);
                                entitySB.SetField("RACE_DATE", rc.RaceDate);
                                //  entitySB.SetField("SUFFIX", rc.Suffixes);
                                entitySB.SetField("ANIMAL_ID", rc.AnimalId);


                                EntityManager.Transaction.Add(entitySB);
                                EntityManager.Commit();
                            }

                            EntityManager.Transaction.Add(rc);    // 08/11/2021
                            EntityManager.Commit();

                            frm.SMMasterDetailGridRaceCard.RefreshRow(rc);

                        }
                    }
                    frm.SMMasterDetailGridRaceCard.Refresh();

                    // populate selected grid - all races for race id
                    IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

                    qryRCS.AddEquals("RACE_ID", m_RaceID);
                    qryRCS.AddAnd();
                    qryRCS.AddEquals("SELECTED", true);

                    IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);
                    frm.SelectedCollection.Data.Clear();
                    frm.SelectedCollection.Data.RemoveAll();
                    //frm.SMMasterDetailGridRCSelection.GridData.Clear();



                    System.Threading.Thread.Sleep(1000);


                    foreach (PRaceCardExtended horse in RaceCardRCS)
                    {
                        foreach (PSpecimenBase spec in horse.SpecimensWithCompleteCollectionData)
                        {
                            spec.RefreshDetailContent();

                        }
                        horse.RefreshDetailContent();
                        horse.SpecimensWithCompleteCollectionData.Refresh();
                        horse.SpecimensNonVoided.Refresh();
                    }



                    frm.SMMasterDetailGridRCSelection.GridData = RaceCardRCS;
                    frm.SelectedCollection.Data.Refresh();
                    frm.SMMasterDetailGridRCSelection.Refresh();
                    frm.SMMasterDetailGridRCSelection.GridData.Reselect();
                    frm.SMMasterDetailGridRCSelection.GridData.Refresh(); //8/31/22 commented out due to inex error


                }
                catch (Exception ex)
                {
                    Library.Utils.FlashMessage("Contact Support RaceID:  " + m_RaceID + " Error: " + ex.Message, "Error from btnAddSelected ");
                }
            }
        }




        private void BtnExit_Click(object sender, EventArgs e)
        {
            frm.Close();
        }


        private void DateRaceDate_DateTimeChanged(object sender, DateTimeChangedEventArgs e)
        {
            m_RaceDate = (DateTime)frm.dateRaceDate.Date;


            //if (frm.cbxFindRace.Checked)   // problems in web clien
            //{
            //    bool exists = RaceExists(false);
            //}
            // TODO - should these be reset - should be happening either in the Import or the RaceExists
            //  m_RaceDate = (DateTime)frm.dateRaceDate.Date;
            //   m_Accession_type = frm.PromptPhraseAccess_Typ.Value.ToString();

        }



        private void CbxFindDH_CheckedChanged(object sender, CheckEventArgs e)
        {
            if (frm.cbxFindDH.Checked)
            {
                frm.SpinEditRaceDateNo.Enabled = true;
            }
            else
            {
                frm.SpinEditRaceDateNo.Enabled = false;
            }
        }



        private void SpinEditRaceDateNo_NumberChanged(object sender, NumberChangedEventArgs e)
        {

            //04/10/2021  - use browse
            //if (m_RaceDateNum != frm.SpinEditRaceDateNo.Number)
            //{

            //    if (frm.cbxFindDH.Checked)
            //    {
            //        m_RaceDateNum = frm.SpinEditRaceDateNo.Number;
            //        m_RaceDate = (DateTime)frm.dateRaceDate.Date;
            //        bool exists = RaceExists(false);
            //        if ( exists)
            //        {
            //            frm.cbxFindRace.Checked = true;

            //            // 03/22/2021 -  set form values if a special 
            //            if (m_Accession_type == "1" || m_Accession_type == "Race Day Samples" || m_Accession_type == "2")
            //            {

            //            }
            //            else  // a special , enable manual buttons and boxes
            //            {
            //                frm.cbxAddFair.Enabled = false;
            //                frm.cbxAddFair.Visible = false;
            //                frm.cbxAddFair.Checked = false;
            //                frm.cbxAddSpecial.Enabled = true;
            //                frm.cbxAddSpecial.Visible = true;
            //                frm.cbxAddSpecial.Checked = true;
            //                 frm.btnSaveManual.Visible = true;
            //                  frm.btnSaveManual.Enabled = true;

            //                  frm.btnImportRaceCard.Enabled = false;
            //                frm.btnAddSelected.Enabled = true;
            //            }

            //        }
            //    }
            //}
        }


        private void SpinEditRaceNum_NumberChanged(object sender, NumberChangedEventArgs e)
        {
            /*
            m_RaceNum = frm.SpinEditRaceNum.Number;
            

            if (frm.cbxFindRace.Checked)
            {
                m_RaceDate = (DateTime)frm.dateRaceDate.Date;
                bool exists = RaceExists(false);
            }
    */
            // 10/12/2020 - avoid reloading on file import

            if (m_RaceNum != frm.SpinEditRaceNum.Number)
            {
                m_RaceNum = frm.SpinEditRaceNum.Number;
                // 04/10/2021  - load new race from browse, use raceNum change to just reload selected grid
                //if (frm.cbxFindRace.Checked)
                //{
                m_RaceDate = (DateTime)frm.dateRaceDate.Date;

                // 04/10/2021  - load new race from browse, use raceNum change to just reload selected grid
                //bool exists = RaceExists(false);
                //if (exists)
                //{
                //    frm.cbxFindRace.Checked = true;

                //    // 03/22/2021 -  set form values if a special 
                //    if (m_Accession_type == "1" || m_Accession_type == "Race Day Samples" || m_Accession_type == "2")
                //    {

                //    }
                //    else  // a special , enable manual buttons and boxes
                //    {
                //        frm.cbxAddFair.Enabled = false;
                //        frm.cbxAddFair.Visible = false;
                //        frm.cbxAddFair.Checked = false;
                //        frm.cbxAddSpecial.Enabled = true;
                //        frm.cbxAddSpecial.Visible = true;
                //        frm.cbxAddSpecial.Checked = true;
                //        frm.btnSaveManual.Visible = true;
                //        frm.btnSaveManual.Enabled = true;

                //        frm.btnImportRaceCard.Enabled = false;
                //        frm.btnAddSelected.Enabled = true;
                //    }

                //}

                // 04/23/2021  - check race num



                if (m_RaceNum > m_NumberOfRaces)
                {
                    Library.Utils.FlashMessage(" check selection - only " + m_NumberOfRaces.ToString() + " races in this set", "Check Race # selection");
                    return;
                }

                // 04/10/2021  - load new race from browse, use raceNum change to just reload selected grid
                if (m_RaceID != "")   // find  matching race cards
                {

                    //exists = true;
                    //IQuery qryRCN = EntityManager.CreateQuery(TableNames.PRaceCard);
                    //qryRCN.AddEquals("SAMPLING_POINT", m_SamplePoint);
                    //qryRCN.AddEquals("RACE_ID", m_RaceID);
                    //qryRCN.AddAnd();
                    //qryRCN.AddEquals("RACE_DATE", m_RaceDate.Date);

                    //List<Object> races = EntityManager.SelectDistinct(qryRCN, "RACE_NO");
                    //int numRaces = races.Count;
                    //frm.txtNumberRaces.Value = numRaces.ToString();


                    IQuery qryRC = EntityManager.CreateQuery(TableNames.PRaceCard);
                    qryRC.AddEquals("SAMPLING_POINT", m_SamplePoint);
                    qryRC.AddEquals("RACE_ID", m_RaceID);
                    qryRC.AddAnd();
                    qryRC.AddEquals("RACE_NO", m_RaceNum);
                    qryRC.AddAnd();

                    qryRC.AddEquals("RACE_DATE", m_RaceDate.Date);



                    IEntityCollection RaceCardRC = EntityManager.Select(TableNames.PRaceCard, qryRC);

                    if (RaceCardRC.Count > 0)
                    {
                        frm.RaceCardCollection.Publish(RaceCardRC);


                    }
                    else  // add 12/06/2020  //   mod 04/09/2021 - may be race with no race card 
                    {
                        //         Library.Utils.FlashMessage("Race Date " + m_RaceDate.Date.ToString() + " Race Number " + m_RaceNum.ToString() + " Not found", "Race number not found");
                        Library.Utils.FlashMessage(" no horses for selected race #  ", "Select another race #");
                        //04/23/2021 - reload here with empty set seems to cause web client problems , so just return 
                        return;
                        //frm.RaceCardCollection.Publish(RaceCardRC);
                        //frm.SMMasterDetailGridRaceCard.Refresh();



                    }
                    //load selection grid , all races for race date - already selected

                    IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

                    qryRCS.AddEquals("RACE_ID", m_RaceID);
                    qryRCS.AddAnd();


                    qryRCS.AddEquals("RACE_DATE", m_RaceDate.Date);
                    qryRCS.AddAnd();
                    qryRCS.AddEquals("SELECTED", true);

                    frm.cbxFindDH.Enabled = false;
                    IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);

                    if (RaceCardRCS.Count > 0)
                    {
                        frm.SelectedCollection.Publish(RaceCardRCS);

                    }
                }


                //}




            }






        }

        private void BtnImportRaceCard_Click(object sender, EventArgs e)
        {


        }

        private void BtnImportRaceCard_ClickAndWait(object sender, EventArgs e)
        {

            frm.btnAddFair.Enabled = false;
            frm.btnAddSpecial.Enabled = false;
            // create race entity

            try
            {

                // 10/23/2020 - move RaceExists to after file is checked 
                //  bool exists = RaceExists(true);  // this creates job with wf login
                // 10/21/2020 - mod for 2 race card types TB or Harness - set on Sample point
                string raceFile = "";
                if (m_SamplePoint.RacetrackType.ToString() == "T")
                {
                    raceFile = Library.Utils.PromptForFile("RaceCard File", "Race Files (*.*) | *.*");
                }
                else if (m_SamplePoint.RacetrackType.ToString() == "H")
                {
                    raceFile = Library.Utils.PromptForFile("RaceCard File", "Race Files (*.txt) | *.txt");
                }
                else
                {
                    Library.Utils.FlashMessage(m_SamplePointName + " - RaceTrack Type not defined, file not imported, check with support", "No Racetrack Type");
                    frm.btnImportRaceCard.Enabled = true;
                    return;
                }
                // need to precheck file - before doing RaceExists
                string transferFile = "";
                if (!string.IsNullOrEmpty(raceFile))
                {
                    FileInfo fIn = new FileInfo(raceFile);

                    string fOut = m_SamplePoint.Identity + fIn.Name;

                    FolderList fl = Library.File.GetFolderList("smp$race_card_folder");

                    Library.File.TransferFromClient(raceFile, fl + "\\" + fOut);



                    //  string check = CheckParseFile(raceFile);

                    string check = CheckParseFile(fl + "\\" + fOut);
                    if (check == "Error")
                    {
                        frm.btnImportRaceCard.Enabled = true;
                        return;
                    }
                    else if (check == "Load new race")
                    {
                        //  increment race date  number done in CheckParseFile , proceed with load
                        m_RaceDateNum++;
                    }
                    frm.SpinEditRaceDateNo.Value = m_RaceDateNum;

                    transferFile = fl + "\\" + fOut;
                }

                // TODO - add message or send email  to cancel job ? 
                if (string.IsNullOrEmpty(raceFile))
                {
                    Library.Utils.FlashMessage("No Race Card selected", "No Race Card");
                    frm.btnImportRaceCard.Enabled = true;
                    return;
                }
                else
                {
                    bool exists = RaceExists(true);  // this creates job with wf login
                                                     // transfer done in check above   10/27/2020
                                                     /*
                                                     string fPid = Library.Environment.GetGlobalString("PROCESS_ID");
                                                     FileInfo fIn = new FileInfo(raceFile);

                                                     string fOut = m_SamplePoint.Identity + fIn.Name;

                                                     FolderList fl = Library.File.GetFolderList("smp$race_card_folder");

                                                     Library.File.TransferFromClient(raceFile, fl + "\\" + fOut);
                                                     */

                    string status = "";

                    // status = ParseFile(fl + "\\" + fOut);
                    status = ParseFile(transferFile);
                    if (status == "OK")
                    {
                        frm.btnImportRaceCard.Enabled = false;
                        frm.cbxFindRace.Checked = true;   // 07/02/2020  // 10/12/20 - disable 2nd check of RaceExists
                        frm.cbxFindDH.Checked = false;
                        frm.cbxFindDH.Enabled = false;

                        frm.dateRaceDate.Enabled = false;   // 04/02/2021 - set read only
                    }
                    else
                    {
                        Library.Utils.FlashMessage(status + " Error in file read , check file format, file load not complete - check Accession / Job " + m_JobName, "Error");
                        frm.btnImportRaceCard.Enabled = false;
                        return;
                    }

                }


                if (m_JobName != "")
                {
                    IQuery qJ = EntityManager.CreateQuery("JOB_HEADER");
                    qJ.AddEquals("JOB_NAME", m_JobName);
                    IEntityCollection recs = EntityManager.Select(TableNames.JobHeader, qJ);

                    foreach (JobHeader j in recs)
                    {
                        j.PAccessionNumber = j.JobName;
                        j.PSamplingPoint = m_SamplePoint;
                        j.PRaceDate = m_RaceDate;
                        //  j.PAccessionType.PhraseId = m_Accession_typeID;
                        // j.PAccessionType.PhraseId = PhraseAccessTyp.PhraseId1;
                        // j.PAccessionType = (PhraseBase)frm.PromptPhraseAccess_Typ.Phrase;

                        j.SetPAccessionType(m_Accession_type);
                        if (frm.cbxAddFair.Checked)
                        { j.SetPFair(m_Fair); }
                        //j.PFair = m_Fair;
                        j.PRaceId = m_Race;

                        if (m_SamplePoint.RacetrackType.PhraseId == PhraseRtType.PhraseIdH)
                        {

                            IQuery qp = EntityManager.CreateQuery("PROJECT_INFO");
                            qp.AddEquals("PROJECT_ID", "SBHORSE");
                            IEntityCollection ps = EntityManager.Select("PROJECT_INFO", qp);
                            if (ps.Count == 1)
                            {
                                j.PProject = (ProjectInfo)ps[0];
                            }

                        }
                        if (m_SamplePoint.RacetrackType.PhraseId == PhraseRtType.PhraseIdT)
                        {
                            IQuery qp = EntityManager.CreateQuery("PROJECT_INFO");
                            qp.AddEquals("PROJECT_ID", "TBHORSE");
                            IEntityCollection ps = EntityManager.Select("PROJECT_INFO", qp);
                            if (ps.Count == 1)
                            {
                                j.PProject = (ProjectInfo)ps[0];
                            }
                        }


                        EntityManager.Transaction.Add(j);
                        EntityManager.Commit();

                        foreach (Sample s in j.Samples)  // QC sample
                        {
                            s.SamplingPoint = m_SamplePoint;
                            EntityManager.Transaction.Add(s);
                            EntityManager.Commit();
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage("Contact Support:  " + ex.Message, "Error from btnImportRace Card ");
            }

            frm.cbxAddFair.Enabled = false;
            frm.cbxAddFair.Visible = false;
            frm.cbxAddFair.Checked = false;
            frm.cbxAddSpecial.Enabled = false;
            frm.cbxAddSpecial.Visible = false;
            frm.cbxAddSpecial.Checked = false;
            frm.btnSaveManual.Visible = false;
            frm.btnSaveManual.Enabled = false;


        }

        string CheckParseFile(string fileText)
        {
            string raceType = m_SamplePoint.RacetrackType.ToString();
            string date = "";
            string race = "";
            try
            {
                string line = "";

                StreamReader sr = new StreamReader(fileText);

                line = sr.ReadLine();
                string linetrim = line.Replace("\",\"", "|");
                linetrim = linetrim.Replace('"', ' ');
                char delim = '|';
                string[] outlParse = linetrim.Split(delim);

                m_FileLength = outlParse.Length;
                //  sr.Close();  //12/6/2020

                if (raceType == "T")
                {
                    if (!line.Contains("Race Number"))
                    {
                        sr.Close();
                        Library.Utils.FlashMessage(fileText + " - Check File ,does not match Thoroughbred microchip format , cannot load file.  "
                                + m_SamplePointName + " is track type " + raceType, "File not loaded");
                        return ("Error");


                    }

                }

                if (raceType == "H")
                {
                    if (line.Contains("Race Number"))
                    {
                        sr.Close();
                        Library.Utils.FlashMessage(fileText + " - Check File ,does not match Harness microchip format , cannot load file "
                             + m_SamplePointName + " is track type " + raceType, "File not loaded");
                        return ("Error");
                    }

                }

                if (outlParse.Length < 11)
                {
                    Library.Utils.FlashMessage(fileText + " - Check File ,does not match Harness or Thoroughbred  microchip format , cannot load file "
                     + m_SamplePointName + " is track type " + raceType, "File not loaded");
                    return ("Error");
                }

                if (outlParse.Length > 14)   // 10/07/2021 - change from 12 - 14 , to allow new TB Format
                {
                    Library.Utils.FlashMessage(fileText + " - Check File ,does not match Harness or Thoroughbred  microchip format , cannot load file "
                     + m_SamplePointName + " is track type " + raceType, "File not loaded");
                    return ("Error");
                }

                if (outlParse.Length == 11 && raceType != "T")  // Thoroughbred has 11 fields
                {
                    sr.Close();
                    Library.Utils.FlashMessage(fileText + " - Check File ,does not match Harness microchip format , cannot load file "
                        + m_SamplePointName + " is track type " + raceType, "File not loaded");
                    return ("Error");
                }
                //07/01/2021 - allow for extra microchip in TB file - on first row
                //10/07/2021 - comment out  lenght = 12 requriement , allow for new TB file
                /*
                if (outlParse.Length == 12 && raceType == "T")  // TB with extra micropchip will have 12
                {
                    sr.Close();
                    Library.Utils.FlashMessage(fileText + " - Check File ,does it have extra microchip in first row ?  or is it a harness file?  "
                        + m_SamplePointName + " is track type " + raceType, "File not loaded yet");
                    bool cont = Library.Utils.FlashMessageYesNo("If you are sure this is a TB  withfile a extra microchip , click yes to load , else click No", "Yes to load, no to abort");
                    cont = Library.Utils.FlashMessageYesNo("Are you sure this is a TB file ? if it is not a TB file, data will incorrectly loaded", "Yes to load, no to abort");
                    if (cont)
                    {
                        // continue
                    }
                    else
                    {
                        return ("Error");
                    }

                }
                */
                // end 10/07/2021 change
                // end 7/1/2021  change  , comment out next if 
                //if (outlParse.Length == 12 && raceType != "H")  // Harness has 12 fields
                //{
                //    sr.Close();
                //    Library.Utils.FlashMessage(fileText + " - Check File ,does not match Thoroughbred microchip format , cannot load file.  "
                //        + m_SamplePointName + " is track type " + raceType, "File not loaded");
                //    return ("Error");
                //}

                //  now check date , move one line for T
                if (raceType == "T")
                {
                    line = sr.ReadLine();  // 12/6/2020  read first data line for T file, get to data 

                }
                else
                {

                }

                linetrim = line.Replace("\",\"", "|");
                linetrim = linetrim.Replace('"', ' ');
                // char delim = '|';
                outlParse = linetrim.Split(delim);
                race = outlParse[0];
                date = outlParse[1];  // same for both types
                sr.Close();
                if (CheckRaceEntry(System.Convert.ToDateTime(date), m_SamplePoint.Identity, System.Convert.ToInt32(race), ""))
                {
                    bool loaded = false;
                    loaded = Library.Utils.FlashMessageYesNo("Appears file with this date has already been loaded , Click yes to Load as new race ( double header , fair or special)  , no to abort. If no , restart form and find race by date and race date number", "Load as Double Header?");
                    if (!loaded)  // answer was no
                    {
                        return ("Error");

                    }
                    else
                    {
                        // 03/08/2021  - if already loaded , get last race_date_no
                        IQuery qryR = EntityManager.CreateQuery("P_RACE");

                        qryR.AddEquals("SAMPLING_POINT", m_SamplePoint.Identity);
                        qryR.AddAnd();
                        qryR.AddEquals("RACE_NO", m_RaceNum);
                        qryR.AddAnd();
                        qryR.AddEquals("RACE_DATE", (System.Convert.ToDateTime(date)));
                        qryR.AddOrder("RACE_DATE_NO", true);

                        IEntityCollection recs = EntityManager.Select(TableNames.PRace, qryR);

                        foreach (PRaceBase r in recs)
                        {
                            m_RaceDateNum = r.RaceDateNo;
                        }

                        return ("Load new race");
                    }
                }

            }
            catch (Exception ex)
            {

                Library.Utils.FlashMessage(ex.ToString(), "Error - Check format of input file");
                return "Error";
            }



            return ("OK");
        }

        string ParseFile(string fileText)
        {
            string access_type = "";
            access_type = frm.PromptPhraseAccess_Typ.Value.ToString();

            string raceType = m_SamplePoint.RacetrackType.ToString();

            int numRaces = 0;
            string race = "";
            string date = "";
            string registration = "";
            string horseName = "";
            string color = "";
            string tatoo = "";
            string lasix = "";
            string owner = "";
            string trainer = "";
            string age = "";
            string gender = "";
            string microchip = "";
            string notes = "";
            m_RaceID = frm.txtRaceID.Value.ToString();

            int horseCnt = 0;
            try
            {
                string line = "";

                StreamReader sr = new StreamReader(fileText);

                line = sr.ReadLine();
                if (line.Contains("Race Number"))  // T file has header line
                {
                    line = sr.ReadLine();
                }

                while (line != null)
                {
                    string linetrim = line.Replace("\",\"", "|");
                    linetrim = linetrim.Replace('"', ' ');
                    char delim = '|';
                    string[] outlParse = linetrim.Split(delim);
                    if (outlParse.Length > 10)   // 10/21/2020 - current file has 11 fields , modify for microchip, original format no longer supported
                    {
                        // this is original format, no microchip
                        /*
                        race = outlParse[0];
                        date = outlParse[1];
                        registration = outlParse[2];  // registration is not used
                        horseName = outlParse[3];
                        color = outlParse[4];
                        tatoo = outlParse[5];
                        lasix = outlParse[6];
                        owner = outlParse[7];
                        trainer = outlParse[8];
                        age = outlParse[9];
                        gender = outlParse[10];
                        */
                        if (outlParse.Length == 11 && raceType == "T")  // Thoroughbred 
                        {
                            if (race != outlParse[0])
                            { numRaces++; }

                            race = outlParse[0];
                            date = outlParse[1];
                            registration = "";  // registration is not in TB file, 
                            horseName = outlParse[2];
                            color = outlParse[4];
                            tatoo = outlParse[3];
                            lasix = outlParse[7];
                            owner = outlParse[8];
                            trainer = outlParse[9];
                            age = outlParse[6];
                            gender = outlParse[5];
                            microchip = outlParse[10];
                        }
                        else if (outlParse.Length == 12 && raceType == "H")    //harness
                        {
                            if (race != outlParse[0])
                            { numRaces++; }
                            race = outlParse[0];
                            date = outlParse[1];
                            registration = outlParse[2]; //  Registration not used
                            horseName = outlParse[3];
                            color = outlParse[4];
                            tatoo = outlParse[5]; // - Horse_no
                            lasix = outlParse[7];
                            owner = outlParse[8];
                            trainer = outlParse[9];
                            age = outlParse[10];
                            gender = outlParse[11];
                            microchip = outlParse[6];
                        }
                        else if (outlParse.Length == 12 && raceType == "T")  // either TB with extra mcrochip or SB at TB track
                                                                             // hopefully SB case was caught in CheckParseFile
                        {
                            // the row 0 case of extra should have already been checked in CheckParseFIle
                            // so this is either first row or somewhere later
                            if (race != outlParse[0])
                            { numRaces++; }

                            race = outlParse[0];
                            date = outlParse[1];
                            registration = "";  // registration is not in TB file, 
                            horseName = outlParse[2];
                            color = outlParse[4];
                            tatoo = outlParse[3];
                            lasix = outlParse[7];
                            owner = outlParse[8];
                            trainer = outlParse[9];
                            age = outlParse[6];
                            gender = outlParse[5];
                            //microchip = outlParse[10];  //07/01/2021
                            microchip = outlParse[10] + " " + outlParse[11];
                        }
                        // addd 10/07/2021 
                        else if (outlParse.Length == 14 && raceType == "T")  // new Oct 2021 TB card, put both mcrochips in chip field
                                                                             // nothing done with extra fields at this point
                        {
                            // the row 0 case of extra should have already been checked in CheckParseFIle
                            // so this is either first row or somewhere later
                            if (race != outlParse[0])
                            { numRaces++; }

                            race = outlParse[0];
                            date = outlParse[1];
                            registration = "";  // registration is not in TB file, 
                            horseName = outlParse[2];
                            color = outlParse[4];
                            tatoo = outlParse[3];
                            lasix = outlParse[7];
                            owner = outlParse[8];
                            trainer = outlParse[9];
                            age = outlParse[6];
                            gender = outlParse[5];
                            //microchip = outlParse[10];  //07/01/2021
                            microchip = outlParse[10] + " " + outlParse[11];
                        }
                        else if (outlParse.Length == 13 && raceType == "T")  // new Oct 2021 TB card with error in header file, put both mcrochips in chip field

                        {
                            // the row 0 case of extra should have already been checked in CheckParseFIle
                            // so this is either first row or somewhere later
                            if (race != outlParse[0])
                            { numRaces++; }

                            race = outlParse[0];
                            date = outlParse[1];
                            registration = "";  // registration is not in TB file, 
                            horseName = outlParse[2];
                            color = outlParse[4];
                            tatoo = outlParse[3];
                            lasix = outlParse[7];
                            owner = outlParse[8];
                            trainer = outlParse[9];
                            age = outlParse[6];
                            gender = outlParse[5];
                            //microchip = outlParse[10];  //07/01/2021
                            microchip = outlParse[10] + " " + outlParse[11];
                        }
                        // end 10/07/2021
                        else
                        {
                            //04/22/2021 - Error at this point of load causes problems in job field assignment.  either stop loading or let user continue 

                            //Library.Utils.FlashMessage(fileText + " - Check File ,does not match microchip format , cannot load file. "
                            //                             + m_SamplePointName + " is track type " + raceType, "File not loaded");
                            //sr.Close();
                            //return ("Error");

                            // 05/01/2021 - this may be causing web client error ? send error to log
                            //bool cont = Library.Utils.FlashMessageYesNo("Expecting " + m_FileLength + " Fields in line -  error in input file format line:  " + line, "Continue loading?");
                            //if (!cont)
                            //{
                            //    sr.Close();
                            //    return ("OK");
                            //}

                            // 07/01/2021 - but load a row according to RT type, else we get a duplicate of previous row
                            // add a ? in notes field
                            // again hopefully row 0 error caught in CheckParseFile

                            if (raceType == "H" && outlParse.Length > 10)
                            {
                                if (race != outlParse[0])
                                { numRaces++; }
                                race = outlParse[0];
                                date = outlParse[1];
                                registration = outlParse[2]; //  Registration not used
                                horseName = outlParse[3];
                                color = outlParse[4];
                                tatoo = outlParse[5]; // - Horse_no
                                lasix = outlParse[7];
                                owner = outlParse[8];
                                trainer = outlParse[9];
                                age = outlParse[10];
                                gender = outlParse[11];
                                microchip = outlParse[6];
                                notes = "? error in race card?";
                            }
                            else if (raceType == "T" && outlParse.Length > 9)
                            {
                                if (race != outlParse[0])
                                { numRaces++; }

                                race = outlParse[0];
                                date = outlParse[1];
                                registration = "";  // registration is not in TB file, 
                                horseName = outlParse[2];
                                color = outlParse[4];
                                tatoo = outlParse[3];
                                lasix = outlParse[7];
                                owner = outlParse[8];
                                trainer = outlParse[9];
                                age = outlParse[6];
                                gender = outlParse[5];
                                microchip = outlParse[10];
                                notes = "? error in race card?";
                            }
                            else  //shouldnt happen , but load error row if does
                            {
                                if (race != outlParse[0])
                                { numRaces++; }

                                race = outlParse[0];//   should be same for tb or sb
                                date = outlParse[1];// shoudl be same for tb or sb
                                registration = "";  // registration is not in TB file, 
                                horseName = "error- check race file";
                                color = "E";
                                tatoo = "error";
                                lasix = "e";
                                owner = "error";
                                trainer = "error";
                                age = "0";
                                gender = "E";
                                //microchip = outlParse[10];  //07/01/2021
                                microchip = "error";
                                notes = "? error in race card?";
                            }

                            Logger.ErrorFormat("Error from InterfaceRaceCardTask  - in File Length Race ID " + m_RaceID + "Expecting " + m_FileLength + " Fields in line -  error in input file format line:  " + line, m_RaceID);
                            Logger.InfoFormat("Error from InterfaceRaceCardTask  - in File Length Race ID " + m_RaceID + "Expecting " + m_FileLength + " Fields in line -  error in input file format line:  " + line, m_RaceID);
                        }




                        //if (horseCnt ==0)  // check for earlier load   // out 12/06/2020   - done earlier 
                        //{
                        //    if (CheckRaceEntry(System.Convert.ToDateTime(date),m_SamplePoint.Identity,System.Convert.ToInt32(race),horseName))
                        //    {
                        //        bool loaded = false;
                        //        loaded = Library.Utils.FlashMessageYesNo("Appears this file has already been loaded , Click yes to Reload as new race , no to abort. If no , restart form and find race by date", "Reload?");
                        //        if ( ! loaded)  // 10/13/2020 was loaded
                        //        {
                        //            sr.Close();
                        //            Exit();
                        //        }
                        //    }
                        //}

                        PackedDecimal id = new PackedDecimal(Library.Increment.GetIncrement("RACE_CARD", "ID"));

                        IEntity entity;
                        entity = EntityManager.CreateEntity(PRaceCardBase.EntityName);


                        entity.SetField("IDENTITY", id);
                        entity.SetField("SAMPLING_POINT", m_SamplePoint);
                        entity.SetField("RACE_NO", Convert.ToInt16(race));
                        //  entity.SetField("RECORD_KEY0", sampId.ToString());  
                        entity.SetField("RACE_DATE", Convert.ToDateTime(date));
                        entity.SetField("REGISTRATION", registration);
                        entity.SetField("HORSE_NAME", horseName);
                        entity.SetField("COLOR", color);
                        entity.SetField("TATOO", tatoo);
                        entity.SetField("PRE_RACE_LASIX", lasix);
                        entity.SetField("OWNER", owner);
                        entity.SetField("TRAINER", trainer);
                        entity.SetField("AGE", Convert.ToInt16(age));
                        entity.SetField("GENDER", gender);
                        entity.SetField("RACE_ID", m_RaceID);
                        entity.SetField("MICROCHIP", microchip);
                        entity.SetField("NOTES", notes);
                        //   entity.SetField("ENTRY_NUM", horseEntry);

                        // set race_no and race_date , on first horse
                        if (horseCnt == 0)
                        {
                            // m_RaceNum = 1;
                            //  frm.SpinEditRaceNum.Number = m_RaceNum;

                            frm.SpinEditRaceNum.Number = Convert.ToInt16(race);
                            m_RaceNum = Convert.ToInt16(race); // for the form
                                                               //   currentRace = m_RaceNum;
                                                               //  lastRace = m_RaceNum;
                            frm.dateRaceDate.Date = Convert.ToDateTime(date);
                            m_RaceDate = Convert.ToDateTime(date);

                            // update race date in p_race from first date in file


                            IQuery qryR = EntityManager.CreateQuery(TableNames.PRace);
                            qryR.AddEquals("IDENTITY", m_RaceID);


                            IEntityCollection RaceRC = EntityManager.Select(TableNames.PRace, qryR);

                            if (RaceRC.Count > 0)
                            {
                                foreach (PRaceBase r in RaceRC)
                                {
                                    r.RaceDate = m_RaceDate;
                                    r.RaceNo = m_RaceNum;
                                    EntityManager.Transaction.Add(r);
                                    EntityManager.Commit();


                                }
                            }



                        }
                        else
                        {

                            /*
                            currentRace = Convert.ToInt16(race);
                            if ( currentRace != lastRace)
                            {

                            }
                            lastRace = Convert.ToInt16(race);
                            */
                        }



                        EntityManager.Transaction.Add(entity);
                        EntityManager.Commit();

                    }
                    else
                    {
                        //05/05/2021 - error in web client
                        //bool cont = Library.Utils.FlashMessageYesNo(" Skipping this line , error in input file format line: " + line, "Continue loading?");
                        //if (!cont)
                        //{
                        //    sr.Close();
                        //    return ("OK");
                        //}

                        Logger.ErrorFormat("Error from InterfaceRaceCardTask  - in File Length Race ID " + m_RaceID + " Skipping this line , error in input file format line: " + line, m_RaceID);
                        Logger.InfoFormat("Error from InterfaceRaceCardTask  - in File Length Race ID " + m_RaceID + " Skipping this line , error in input file format line: " + line, m_RaceID);

                    }

                    line = sr.ReadLine();

                    horseCnt++;
                }

                sr.Close();

                IQuery qryRC = EntityManager.CreateQuery(TableNames.PRaceCard);
                qryRC.AddEquals("SAMPLING_POINT", m_SamplePoint);
                qryRC.AddAnd();
                qryRC.AddEquals("RACE_ID", m_RaceID);
                qryRC.AddAnd();
                qryRC.AddEquals("RACE_NO", m_RaceNum);

                IEntityCollection RaceCardRC = EntityManager.Select(TableNames.PRaceCard, qryRC);

                if (RaceCardRC.Count > 0)
                {
                    frm.RaceCardCollection.Publish(RaceCardRC);
                    frm.SMMasterDetailGridRaceCard.Refresh();
                }
                frm.txtNumberRaces.Value = numRaces.ToString();
                m_NumberOfRaces = numRaces;
                return "OK";


            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage(ex.ToString(), "Error - Check format of input file");
                return "Error";
            }

        }


        /// <summary>
        /// check Race entry - if already loaded
        /// </summary>
        /// <param name="RaceDate"></param>
        /// <param name="SamplePoint"></param>
        /// <param name="RaceNumber"></param>
        /// <param name="HorseName"></param>
        /// <returns>true if loaded</returns>
        bool CheckRaceEntry(DateTime RaceDate, string SamplePoint, int RaceNumber, string HorseName)
        {
            IQuery qryRC = EntityManager.CreateQuery(TableNames.PRaceCard);

            qryRC.AddEquals("SAMPLING_POINT", SamplePoint);
            qryRC.AddAnd();
            qryRC.AddEquals("RACE_NO", m_RaceNum);
            qryRC.AddAnd();
            qryRC.AddEquals("RACE_DATE", RaceDate);


            IEntityCollection RaceCardRC = EntityManager.Select(TableNames.PRaceCard, qryRC);


            if (RaceCardRC.Count > 0)
            {
                return true;
            }

            return false;
        }


        /// <summary>
        /// exit
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        void ButtonExit_Click(object sender, EventArgs e)
        {
            frm.Close();
        }



        #endregion

        #region Methods


        bool RaceExists(bool Create)
        {
            bool exists = false;

            // first look using sp , race no, race type , acc type
            //       m_Fair = frm.PromptPhraseFair.Value.ToString();   // commenmt out 03/31/2021 
            //  m_Accession_type = frm.PromptPhraseAccess_Typ.Value.ToString();

            m_RaceNum = (int)frm.SpinEditRaceNum.Value;


            string raceID = frm.txtRaceID.Value.ToString();


            // look for matching race , not already crated with identity
            IQuery qryR = EntityManager.CreateQuery(TableNames.PRace);

            if (m_RaceFound)  // selection made from Browse

            {
                qryR.AddEquals("IDENTITY", raceID);
            }
            else
            {
                qryR.AddEquals("SAMPLING_POINT", m_SamplePoint);
                qryR.AddAnd();
                qryR.AddEquals("RACE_NO", m_RaceNum);
                qryR.AddAnd();

                qryR.AddEquals("RACE_DATE", m_RaceDate.Date);
                qryR.AddAnd();
                qryR.AddEquals("ACCESSION_TYPE", m_Accession_type);
                qryR.AddAnd();
                qryR.AddEquals("RACE_DATE_NO", m_RaceDateNum); //12/06/2020 - add 
            }
            // 03/26/2021 --  initial screen does not allow fair selection
            //if (m_Fair != "None")
            //{
            //    qryR.AddAnd();
            //    qryR.AddEquals("FAIR", m_Fair);
            //}


            IEntityCollection RaceRC = EntityManager.Select(TableNames.PRace, qryR);

            if (RaceRC.Count > 1)  //12/06/2020
            {
                Library.Utils.FlashMessage("More than one race entered for this date / race date Number", "Contact support");
                exists = true;
                return exists;
            }

            //if (RaceRC.Count > 0)  // 10/12/2020    // 03/26/2021 - problems in web client ?  
            //{
            //    frm.RaceDetailCollection.Publish(RaceRC);
            //    frm.SMMasterDetailGridRaceDetails.Refresh();
            //}


            if (RaceRC.Count > 0)
            {
                frm.btnImportRaceCard.Enabled = false;
                frm.btnAddFair.Enabled = false;
                frm.btnAddSpecial.Enabled = false;

                foreach (PRaceBase r in RaceRC)   // should only be 1
                {
                    // 04/09/2021 - if using browse to find race ,  must set controls: race date , accession type , manual, fair 

                    if (m_RaceFound)
                    {
                        frm.dateRaceDate.Date = r.RaceDate;
                        m_RaceDate = (DateTime)r.RaceDate;
                        //frm.PromptPhraseAccess_Typ.Value = r.AccessionType;
                        //frm.PromptPhraseAccess_Typ.Phrase = r.AccessionType.Phrase;
                        //frm.PromptPhraseAccess_Typ.Phrase.t
                        m_Accession_type = r.AccessionType.PhraseId;

                        // set phrase on browse
                        IQuery qryA = EntityManager.CreateQuery(TableNames.Phrase);
                        qryA.AddEquals("PHRASE_TYPE", "ACCESS_TYP");
                        qryA.AddAnd();
                        qryA.AddEquals("PHRASE_ID", m_Accession_type);
                        IEntityCollection a = EntityManager.Select(TableNames.Phrase, qryA);
                        if (a.Count == 1)
                        {
                            frm.PromptPhraseAccess_Typ.Phrase = a[0];
                        }
                        frm.PromptPhraseAccess_Typ.Enabled = false;

                        frm.cbxManualEntry.Checked = r.ManualEntry;
                        //                        if ( r.Fair.PhraseText == "None")
                        //                        {
                        //                            //if ( r.Fair.ToString() != "" || r.Fair.ToString() != "None" )
                        //                            //{
                        //;
                        //                            //}
                        //                        }
                        //                        else if ( r.Fair.PhraseText == "")
                        //                        {

                        //                        }
                        //                        else
                        //                        {
                        //                            string p = r.Fair.Phrase.ToString();
                        //                            //    frm.PromptPhraseFair.Value = r.Fair;
                        //                            //    frm.PromptPhraseFair.Phrase = r.Fair.Phrase
                        //                        }

                    }

                    m_RaceID = r.Identity;
                    frm.txtRaceID.Value = m_RaceID;
                    m_JobName = r.JobName;
                    frm.txtJobName.Value = r.JobName;
                    m_RaceNum = r.RaceNo;
                    //  frm.SpinEditRaceNum.Number = m_RaceNum;   // 12/06/2020 - always 1 ?
                    m_Race = r;
                    if (r.RaceSubmitted)
                    {
                        // Library.Utils.FlashMessage("This race already submitted ", "Read Only mode");  //03/26/2021 - web client freeze , use label
                        frm.lblRaceSubmitted.Visible = true;
                        // disable update buttons
                        frm.cbxAddFair.Enabled = false;
                        frm.cbxAddFair.Visible = false;
                        frm.cbxAddFair.Checked = false;
                        frm.cbxAddSpecial.Enabled = false;
                        frm.cbxAddSpecial.Visible = false;
                        frm.cbxAddSpecial.Checked = false;
                        frm.btnSaveManual.Visible = false;
                        frm.btnSaveManual.Enabled = false;
                        frm.btnSave.Enabled = false;
                        frm.btnAddSelected.Enabled = false;
                        frm.btnSaveSelected.Enabled = false;
                        // 03/26/21 - disable det and spec reports , enabling coudl trigger final save again
                        //      also disable find a new race , must exit to find a new one
                        frm.btnDetBarnReport.Enabled = false;
                        frm.btnSpecimenReport.Enabled = false;
                        frm.cbxFindRace.Checked = false;
                        frm.cbxFindRace.Enabled = false;
                        frm.cbxFindDH.Checked = false;
                        frm.cbxFindDH.Enabled = false;

                    }
                    else  // disable fair and specials, enable save
                    {
                        frm.cbxAddFair.Enabled = false;
                        frm.cbxAddFair.Visible = false;
                        frm.cbxAddFair.Checked = false;
                        frm.cbxAddSpecial.Enabled = false;
                        frm.cbxAddSpecial.Visible = false;
                        frm.cbxAddSpecial.Checked = false;
                        frm.btnSaveManual.Visible = false;
                        frm.btnSaveManual.Enabled = false;
                        frm.btnSave.Enabled = false;  // disable final save until d-barn report printed
                        frm.btnAddSelected.Enabled = true;
                        frm.btnSaveSelected.Enabled = true;

                        // 03/29/2021  - if special or fair in a found race , allow / check for manual 
                        if (m_Accession_type != "1")
                        {
                            if (r.ManualEntry)   // 03/29/2021
                            {
                                ResetReadOnlyGrid();
                                frm.btnImportRaceCard.Enabled = false;
                                frm.btnSaveManual.Visible = true;
                                frm.btnSaveManual.Enabled = true;
                                frm.btnSaveSelectedManual.Visible = true;
                                frm.btnSaveSelectedManual.Enabled = true;
                                frm.btnAddSelectedManual.Visible = true;
                                frm.btnAddSelectedManual.Enabled = true;
                                // turn off import save btns
                                frm.btnAddSelected.Enabled = false;
                                frm.btnAddSelected.Visible = false;
                                frm.btnSaveSelected.Visible = false;
                                frm.btnSaveSelected.Enabled = false;

                                frm.cbxManualEntry.Checked = true;
                                frm.cbxManualEntry.Visible = true;

                            }
                            // 03/.24/2021   set buttons 
                            frm.cbxAddFair.Enabled = false;
                            frm.cbxAddFair.Visible = false;
                            //frm.cbxAddFair.Checked = false;


                            frm.btnImportRaceCard.Enabled = false;
                            // frm.btnAddSelected.Enabled = true;  // 03/20/2021  horses added 
                            if (m_Accession_type == "2")  //fair
                            {
                                frm.cbxAddFair.Visible = true;
                                frm.cbxAddFair.Checked = true;
                                frm.PromptPhraseFair.Visible = true;
                                //  need to set fair phrase
                                IQuery qryF = EntityManager.CreateQuery(TableNames.Phrase);
                                qryF.AddEquals("PHRASE_TYPE", "FAIR");
                                qryF.AddAnd();
                                qryF.AddEquals("PHRASE_ID", r.Fair);
                                IEntityCollection f = EntityManager.Select(TableNames.Phrase, qryF);
                                if (f.Count == 1)
                                {
                                    frm.PromptPhraseFair.Phrase = f[0];
                                }


                                //frm.PromptPhraseFair.Value = 

                                //frm.PromptPhraseFair.Phrase = "";
                            }
                            else  // special
                            {
                                frm.cbxAddSpecial.Enabled = false;
                                frm.cbxAddSpecial.Visible = true;
                                frm.cbxAddSpecial.Checked = true;
                            }


                        }

                    }
                }


            }  // end    if (RaceRC.Count > 0)



            if (m_RaceID != "")   // find  matching race cards
            {
                //12/06/2020 - count of races
                exists = true;
                IQuery qryRCN = EntityManager.CreateQuery(TableNames.PRaceCard);
                qryRCN.AddEquals("SAMPLING_POINT", m_SamplePoint);
                qryRCN.AddEquals("RACE_ID", m_RaceID);
                qryRCN.AddAnd();
                qryRCN.AddEquals("RACE_DATE", m_RaceDate.Date);

                List<Object> races = EntityManager.SelectDistinct(qryRCN, "RACE_NO");
                int numRaces = races.Count;
                frm.txtNumberRaces.Value = numRaces.ToString();
                m_NumberOfRaces = numRaces;


                IQuery qryRC = EntityManager.CreateQuery(TableNames.PRaceCard);
                qryRC.AddEquals("SAMPLING_POINT", m_SamplePoint);
                qryRC.AddEquals("RACE_ID", m_RaceID);
                qryRC.AddAnd();
                qryRC.AddEquals("RACE_NO", m_RaceNum);
                qryRC.AddAnd();

                qryRC.AddEquals("RACE_DATE", m_RaceDate.Date);



                IEntityCollection RaceCardRC = EntityManager.Select(TableNames.PRaceCard, qryRC);

                if (RaceCardRC.Count > 0)  // 10/12/2020
                {
                    frm.RaceCardCollection.Publish(RaceCardRC);
                    //  frm.SMMasterDetailGridRaceCard.Refresh();    // 03/26/2021 - web client ?

                    frm.dateRaceDate.Enabled = false;   // 04/02/2021 - set read only

                }
                else  // add 12/06/2020  //   mod 04/09/2021 - may be found race with no race card 
                {
                    //         Library.Utils.FlashMessage("Race Date " + m_RaceDate.Date.ToString() + " Race Number " + m_RaceNum.ToString() + " Not found", "Race number not found");
                    Library.Utils.FlashMessage(" no horses for this race ", "Import race card or do manual entry");
                    frm.RaceCardCollection.Publish(RaceCardRC);
                    frm.SMMasterDetailGridRaceCard.Refresh();
                    if (!frm.cbxManualEntry.Checked)
                    { frm.btnImportRaceCard.Enabled = true; }
                    return (exists);
                }
                //load selection grid , all races for race date - already selected

                IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);
                //  qryRCS.AddEquals("SAMPLING_POINT", m_SamplePoint);
                qryRCS.AddEquals("RACE_ID", m_RaceID);
                qryRCS.AddAnd();
                //  qryRCS.AddEquals("RACE_NO", m_RaceNum);
                // qryRCS.AddAnd();

                qryRCS.AddEquals("RACE_DATE", m_RaceDate.Date);
                qryRCS.AddAnd();
                qryRCS.AddEquals("SELECTED", true);

                frm.cbxFindDH.Enabled = false;
                IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);

                if (RaceCardRCS.Count > 0)  // 10/12/2020
                {
                    frm.SelectedCollection.Publish(RaceCardRCS);
                    //frm.SMMasterDetailGridRCSelection.Refresh();    // 03/26/2021 - web client ?
                }
            }
            else  // create if find a matching race , not same identity
            {
                if (Create)
                {

                    try
                    {
                        if (frm.cbxAddFair.Checked)
                        { m_Fair = frm.PromptPhraseFair.Value.ToString(); }// add 03/31/2021
                        IEntity entity;
                        entity = EntityManager.CreateEntity(PRaceBase.EntityName);

                        PackedDecimal id = new PackedDecimal(Library.Increment.GetIncrement("RACE", "ID"));
                        frm.txtRaceID.Value = id.ToString();

                        //  04/01/2021  alternate intial wf login

                        if (m_Accession_type == "1" || m_Accession_type == "Race Day Samples" || m_Accession_type == "2")
                        {

                            LaunchWF(m_WorkFlowName);  // creates job
                        }
                        else
                        {
                            LaunchWF(m_WorkFlowNameNRT);
                        }


                        frm.txtJobName.Text = m_JobName;
                        entity.SetField("IDENTITY", id);
                        entity.SetField("SAMPLING_POINT", m_SamplePoint);
                        entity.SetField("RACE_NO", m_RaceNum);

                        entity.SetField("RACE_DATE", Convert.ToDateTime(m_RaceDate.Date));
                        entity.SetField("ACCESSION_TYPE", m_Accession_type);
                        if (frm.cbxAddFair.Checked)
                        { entity.SetField("FAIR", m_Fair); }
                        entity.SetField("JOB_NAME", m_JobName);
                        //  entity.SetField("POST_TIME", m_PostTime);
                        entity.SetField("CREATED_BY", (Personnel)Library.Environment.CurrentUser);  // 07/01 /2020 add fields
                        entity.SetField("CREATED_ON", System.DateTime.Now);

                        entity.SetField("RACE_DATE_NO", m_RaceDateNum);
                        if (frm.cbxManualEntry.Checked)
                        { entity.SetField("MANUAL_ENTRY", true); }


                        EntityManager.Transaction.Add(entity);
                        EntityManager.Commit();
                        frm.txtRaceID.Value = id.ToString();
                        m_RaceID = id.ToString();
                        m_Race = (PRaceBase)entity;
                        //   }



                        IQuery QRace2 = EntityManager.CreateQuery(TableNames.PRace);
                        QRace2.AddEquals("IDENTITY", m_RaceID);
                        IEntityCollection race2 = EntityManager.Select(TableNames.PRace, QRace2);
                        if (race2.Count > 0)   // 10/12/2020
                        {
                            frm.RaceDetailCollection.Publish(race2);
                            frm.SMMasterDetailGridRaceDetails.Refresh();
                        }
                        frm.cbxFindDH.Enabled = false;
                    }
                    catch (Exception ex)
                    {
                        Library.Utils.FlashMessage(ex.Message, "Error from RaceExists-Create");
                        Logger.Error("Error from RaceExists-Create" + ex.Message);
                    }
                }

                else  // see if a match based race id ?
                {
                }



            }

            return exists;
        }





        /// <summary>
        /// Find last dir name in path , no filename present
        /// </summary>
        /// <param name="FilePathIn"></param>
        /// <returns>filename</returns>
        string FindLastDirName(string DirPathIn)
        {
            string dirOut = "NotFound";

            char[] delimit = { '\\' };
            string[] fileParse = DirPathIn.Split(delimit);
            if (fileParse.Length > 0)
            {
                int i = fileParse.Length;
                dirOut = fileParse[i - 1];
            }

            return dirOut;
        }


        public void DirSearch(string sDir)
        {
            try
            {
                foreach (string d in Directory.GetDirectories(sDir))
                {
                    foreach (string f in Directory.GetFiles(d))
                    {
                        // bool CopyFile = false;
                        //  if (f.EndsWith(".spc"))
                        //  { CopyFile = CopyFileName(f,m_DirName, "1"); }
                        // {
                        //   CopyFile = CopyFileName(f, m_DirNameComp, "1", "");
                        // }   //4-21/2016
                    }
                    DirSearch(d);
                }
            }
            catch (System.Exception excpt)
            {
                Library.Utils.FlashMessage(excpt.Message, "Error from DirSearch");

            }
        }


        string TruncateFileName(string filename, int newLength)
        {
            if (filename.Length > newLength)
            {
                filename = filename.Substring(0, newLength);
            }
            return filename;
        }


        /// <summary>
        /// Copy file in FilePathIn to DirPath, if newFileName not empty , rename to newFileName
        /// </summary>
        /// <param name="FilePathIn">full path to file</param>
        /// <param name="dirPath">destination dir</param>
        /// <param name="version">not currently used</param>
        /// <param name="newFileName"> new name for copied File </param>
        /// <returns>true if success</returns>
        bool CopyFileName(string FilePathIn, string dirPath, string version, string newFileName)
        {
            bool success = false;
            FileInfo f = new FileInfo(FilePathIn);
            try
            {
                if (Directory.Exists(dirPath) != true)
                {
                    Directory.CreateDirectory(dirPath);
                }

                if (File.Exists(FilePathIn))
                {
                    if (newFileName != "")
                    {
                        f.CopyTo(dirPath + "\\" + newFileName, true);
                        success = true;
                    }
                    else
                    {
                        f.CopyTo(dirPath + "\\" + f.Name, true);
                        success = true;
                    }
                }
                else
                {
                    if (newFileName == "")  // don't warn , means the source file not found - new model
                    { Library.Utils.FlashMessage(FilePathIn + " Not Moved - Not Found ", "NOT FOUND"); }
                }
            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage(ex.Message, FilePathIn);
            }

            return success;
        }


        /// <summary>
        /// Delete File
        /// </summary>
        /// <param name="FilePathIn"></param>
        /// <returns>true if deleted</returns>
        bool DeleteFileName(string FilePathIn)
        {
            bool success = false;
            FileInfo f = new FileInfo(FilePathIn);
            try
            {

                if (File.Exists(FilePathIn))
                {
                    File.Delete(FilePathIn);
                    success = true;
                }
                else
                {
                    success = false;
                }
            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage(ex.Message, FilePathIn);
            }

            return success;
        }

        /// <summary>
        /// Trim illegal file name chars -
        /// </summary>
        /// <param name="FileIn"></param>
        /// <returns>Trimmed File name</returns>
        string TrimIllegals(string FileIn)
        {
            char[] trimC = { '\\', ' ', '*', '?', '"', '\'' };

            FileIn = Regex.Replace(FileIn, @"[^\w\.@-]", "");

            return FileIn;


        }


        /// <summary>
        /// parse cfl file , return list of spc file names 
        /// 
        /// </summary>
        /// <param name="path">FileIn</param>
        private List<object> CheckCfl(string FileIn)  // added 09/26/2016  for LastCalcheck
        {


            List<object> m_SpcList = new List<object>();

            string line = "";

            int lineCount = 0;


            StreamReader sr = new StreamReader(FileIn);

            line = sr.ReadLine();
            while (line != null)
            {
                if (line.StartsWith("GRAMS"))
                { lineCount++; }
                else if (line.StartsWith("FILE"))
                { lineCount++; }
                else
                {
                    string[] lineParse = line.Split(',');
                    if (lineParse.Length > 0)
                    {
                        m_SpcList.Add(lineParse[0]);
                    }
                    lineCount++;
                }

                line = sr.ReadLine();
            }
            sr.Close();


            return m_SpcList;

        }


        /// <summary>
        /// Translate illegal file name chars to new chars for mapping back  in a sample point or component name - not full file path
        /// </summary>
        /// <param name="StringIn"></param>
        /// <returns>Trimmed File name</returns>
        string TranslateFileIllegals(string StringIn)
        {
            //  char[] trimC = { '\\', ' ', '*', '?', '"', '\'' };

            //  FileIn = Regex.Replace(FileIn, @"[^\w\.@-]", "");

            StringIn = StringIn.Replace("/", "_");
            StringIn = StringIn.Replace("?", "_");
            StringIn = StringIn.Replace(" ", "");
            StringIn = StringIn.Replace(":", "");


            return StringIn;


        }

        /// <summary>
        /// clear input dir of files and directories 
        /// </summary>
        private void ClearDirectory(string dir)
        {
            try
            {
                // detlet files in input dir
                if (Directory.Exists(dir) == true)
                {
                    FolderList folder = new FolderList(dir);

                    IList<FileInfo> filesDelete = Library.File.GetFiles(folder, "*.*");

                    if (filesDelete.Count > 0)
                    {
                        // Logger.InfoFormat("Delete {0} files in {1}", filesDelete.Count, m_DirName);

                        foreach (FileInfo f in filesDelete)
                        {
                            try
                            {
                                using (Stream stream = new FileStream(f.FullName, FileMode.Open))
                                {
                                    stream.Close();
                                }
                            }
                            catch
                            {
                                Library.Utils.FlashMessage(f.FullName, "File Open or in use");
                            }
                            finally
                            { f.Delete(); }
                        }
                    }

                    foreach (string d in Directory.GetDirectories(dir))
                    {
                        if (Directory.Exists(d) == true)
                        {

                            Directory.Delete(d, true);
                        }
                    }

                }


            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage(ex.ToString(), "Error from ClearDirectory - File or Directory open - OK to continue");
            }


        }


        private string GetPhraseID(string PhraseType, string PhraseText)
        {
            string m_PhraseID = "NOTFOUND";

            IQuery qryP = EntityManager.CreateQuery(TableNames.Phrase);

            qryP.AddEquals("PHRASE_TYPE", PhraseType);
            qryP.AddAnd();
            qryP.AddEquals("PHRASE_TEXT", PhraseText);


            IEntityCollection Ph = EntityManager.Select(TableNames.Phrase, qryP);

            if (Ph.Count == 1)
            {
                foreach (Phrase p in Ph)
                {
                    m_PhraseID = p.PhraseId;

                }
            }



            return m_PhraseID;

        }

        /// <summary>
        ///  find nth file with extension in dir
        /// </summary>
        /// <param name="dir">directory</param>
        /// <param name="extension">file mask "*.spc"</param>
        /// <param name="n">nth file to return </param>
        private string FindFile(string dir, string mask, int n)
        {
            string returnFile = "";
            try
            {

                if (Directory.Exists(dir) == true)
                {
                    FolderList folder = new FolderList(dir);

                    IList<FileInfo> filesFound = Library.File.GetFiles(folder, mask);

                    if (filesFound.Count > 0)
                    {
                        // Logger.InfoFormat("Delete {0} files in {1}", filesDelete.Count, m_DirName);
                        int cnt = 0;
                        foreach (FileInfo f in filesFound)
                        {
                            if (cnt == n)
                            {
                                returnFile = f.FullName.ToString();
                                return returnFile;
                            }
                            cnt++;
                        }
                    }

                }


            }
            catch (Exception ex)
            {
                Library.Utils.FlashMessage(ex.ToString(), "Error from ClearDirectory");
                return returnFile;
            }

            return returnFile;

        }

        #endregion

        private void LaunchWF(string WorkflowName)
        {
            Workflow workflow = null;
            // string WorkflowName = "Race Track Bkg Accession";

            try
            {
                Guid workflowGuid;

                if (Guid.TryParse(WorkflowName, out workflowGuid))
                {
                    workflow = (Workflow)EntityManager.SelectLatestVersion(TableNames.Workflow, new Identity(WorkflowName));
                }
                else
                {
                    IQuery query = EntityManager.CreateQuery(TableNames.Workflow);

                    query.AddEquals(WorkflowPropertyNames.WorkflowName, WorkflowName);

                    IEntityCollection workflowCollection = EntityManager.Select(TableNames.Workflow, query);

                    if (workflowCollection.Count > 0)
                    {
                        workflow = (Workflow)workflowCollection[0];
                    }
                }

                if ((workflow != null) && (!workflow.IsNull()))
                {
                    Logger.InfoFormat("Running workflow {0}", WorkflowName);


                    IWorkflowPropertyBag bag = workflow.Perform();


                    //  bag.AddEntity(job);

                    if (bag.HasErrors)
                    {
                        Logger.Error("Failed in InterfaceRaceCardTask LaunchWF " + WorkflowName);

                        foreach (WorkflowError error in bag.Errors)
                        {
                            Logger.Error(error.Message);
                            Library.Utils.FlashMessage(error.Message, "Error from InterfaceRaceCardTask LaunchWF -  " + WorkflowName);
                        }
                    }
                    else
                    {
                        EntityManager.Commit();
                        m_JobName = "";
                        Logger.Info("Complete.");

                        foreach (var list in bag.Entities.Values)
                        {
                            foreach (var entity in list)
                            {
                                if (entity.EntityType == "JOB_HEADER")
                                {
                                    m_JobName = entity.Name;
                                }
                            }
                        }
                    }
                }
                else
                {
                    Logger.ErrorFormat("Unable to locate workflow {0} ", WorkflowName);
                }


            }
            catch (Exception e)
            {
                Logger.ErrorFormat("Error running the workflow {0} : {1}", WorkflowName, e.Message);
                Logger.Error(e.InnerException.Message);
            }
        }

        private void ResetReadOnlyGrid()
        {
            //IGrid grid  = frm.SMMasterDetailGridRaceCard.fi
            // IGridView grid = (IGridView)frm.SMMasterDetailGridRaceCard.Columns;

            ControlCollection<GridColumn> grid = frm.SMMasterDetailGridRaceCard.Columns;

            foreach (GridColumn gc in grid)
            {
                if (gc.Name == "RaceNo" || gc.Name == "Identity" || gc.Name == "RaceId")
                {
                    gc.ReadOnly = true;
                }
                else
                {
                    gc.ReadOnly = false;
                }
            }
        }

        private void SaveAnimalAndSpecimens()
        {
              foreach (PRaceCardBase rc in frm.SMMasterDetailGridRCSelection.GridData.ModifiedItems)   // 11/14/2020 change from  activeItems to modified
              {
                    if (!rc.Void)  // 6/30/2020  - exclude voided horses
                    {

                        string spec_types = "";
                        string spec_types2 = "";  // 03.03.2021
                        bool have_one = false;

                        // 04/30/2021 - check if numeric - TODO - maybe should not allow ?

                        try
                        {
                            int check = System.Convert.ToInt32(rc.AnimalId);
                        }
                        catch
                        {
                            Library.Utils.FlashMessage("Animal ID is not numeric , Animal ID: " + rc.AnimalId, "Check Horse: " + rc.HorseName);
                        }

                        //10/21/2021


                        bool have_suffix = false;

                        string suffix = rc.Suffixes;

                        if (suffix != "")
                        {
                            have_suffix = true;

                        }
                        // set suffixes

                        // for IM   From Deb email of 2/17/20:
                        //  Suffix = IM - Intact Male if gender = "H"(horse) or "C"(colt) , or "R"(ridgeling).But we need to add "m"(male) - done

                        if (rc.PreRaceLasix.ToString().Contains("L"))
                        {
                            if (!rc.Suffixes.Contains("F"))
                            {
                                if (have_suffix)
                                { suffix += ","; }

                                suffix += "F";
                                have_suffix = true;

                            }
                        }
                        if (rc.Gender == "H" || rc.Gender == "h")
                        {
                            if (!rc.Suffixes.Contains("IM"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "IM";
                                have_suffix = true;
                            }
                        }
                        else if (rc.Gender == "C" || rc.Gender == "c")
                        {
                            if (!rc.Suffixes.Contains("IM"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "IM";
                                have_suffix = true;
                            }
                        }
                        else if (rc.Gender == "R" || rc.Gender == "r")
                        {
                            if (!rc.Suffixes.Contains("IM"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "IM";
                                have_suffix = true;
                            }
                        }

                        if (rc.TestingReasons.ToString() == "C")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }

                        if (rc.TestingReasons.ToString() == "CW")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }

                        if (rc.TestingReasons.ToString() == "C2")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }

                        if (rc.TestingReasons.ToString() == "CSP")
                        {
                            if (!rc.Suffixes.Contains("C"))
                            {
                                if (have_suffix)
                                { suffix += ","; }
                                suffix += "C";
                                rc.Claimed = true;
                                have_suffix = true;
                            }
                        }
                        // 11/13/2021 - Check for updated testing reasons - case when changed from Previous C
                        if (!rc.TestingReasons.ToString().Contains("C"))
                        {
                            if (rc.Suffixes.Contains("C"))
                            {

                                suffix = suffix.Replace('C', ' ');
                                suffix = suffix.TrimEnd(' ');
                                suffix = suffix.TrimEnd(',');
                                suffix = suffix.TrimStart(',');

                                rc.Claimed = false;
                                //have_suffix = true;
                            }
                        }
                        // end 11/13/2021
                        rc.Suffixes = suffix;

                        EntityManager.Transaction.Add(rc);
                        EntityManager.Commit();

                        //end 10/21/2021



                        foreach (PSpecimenBase ps in rc.PSpecimens)
                        {
                            ps.AnimalId = rc.AnimalId;  // ToDO - check if this is correct
                            ps.Claimed = rc.Claimed;   // ToDO - check if this is correct
                            ps.Suffix = rc.Suffixes;    // ToDO - check if this is correct
                            ps.JobName = rc.JobName;

                            if (ps.SamplingPoint.IsNull())  //07/31/2021  0 check sampleing point
                            {
                                ps.SamplingPoint = m_SamplePoint;
                                ps.RaceDate = m_RaceDate;
                                ps.Container = "NONE";
                            }

                            //08/06/2021
                            if (ps.JobName == "")  // 08/06/2021 
                            { ps.JobName = m_JobName; }


                            if (ps.AddSpecimen)
                            {
                                if (have_one)
                                {
                                    spec_types += ",";
                                    spec_types2 += ",";
                                }
                                spec_types += ps.SpecimenType.PhraseText;
                                spec_types2 += ps.SpecimenType.PhraseId;  //
                                have_one = true;

                            }



                            EntityManager.Transaction.Add(ps);
                            EntityManager.Commit();



                        }

                        //08/01/2020
                        if (rc.SpecimenTypes != spec_types)
                        {

                            rc.SpecimenTypes = spec_types;
                            rc.SpecimenTypes2 = spec_types2;
                            EntityManager.Transaction.Add(rc);
                            EntityManager.Commit();
                        }

                        frm.SMMasterDetailGridRCSelection.RefreshRow(rc);
                    }
                    else  //  update for voided selection , so void is stored , also at specimen level 
                    {
                        EntityManager.Transaction.Add(rc);
                        EntityManager.Commit();
                        foreach (PSpecimenBase ps in rc.PSpecimens)  //11/20/2020  must set specimen void and add_specimen 
                        {
                            ps.Void = true;
                            ps.AddSpecimen = false;
                            EntityManager.Transaction.Add(ps);
                            EntityManager.Commit();
                        }


                    }

                    //11/14/2020 - check for dup in current set - query PRACECARD
                    IQuery qryPSR = EntityManager.CreateQuery(TableNames.PRaceCard);
                    qryPSR.AddEquals("ANIMAL_ID", rc.AnimalId);
                    qryPSR.AddAnd();
                    qryPSR.AddEquals("RACE_ID", m_RaceID);
                    qryPSR.AddAnd();
                    qryPSR.AddEquals("SELECTED", true);
                    //List<Object> specsR = EntityManager.SelectDistinct(qryPSR, "IDENTITY");

                    IEntityCollection specsR = EntityManager.Select(TableNames.PRaceCard, qryPSR);
                    if (specsR.Count > 1)
                    {
                        foreach (PRaceCardBase rcR in specsR)
                        {

                            Library.Utils.FlashMessage(rcR.HorseName + " Barcode Commission ID: " + rcR.AnimalId + "  used more than once in current race ", "Enter unique Barcode ID");
                            break;
                        }
                    }


                }
                                        
                IQuery qryRCS = EntityManager.CreateQuery(TableNames.PRaceCard);

                qryRCS.AddEquals("RACE_ID", m_RaceID);
                qryRCS.AddAnd();
                qryRCS.AddEquals("SELECTED", true);

                IEntityCollection RaceCardRCS = EntityManager.Select(TableNames.PRaceCard, qryRCS);
            
                foreach (PRaceCardBase prc in frm.SMMasterDetailGridRCSelection.GridData.ActiveItems)
                {
                    // 08/13/2021  - add check for specimen types on race card
                    string spec_types = "";
                    string spec_types2 = "";  // 03.03.2021
                    bool have_one = false;

                    foreach (PSpecimenBase ps in prc.PSpecimens)
                    {
                        bool update = false;

                        if (ps.AddSpecimen)
                        {
                            if (have_one)
                            {
                                spec_types += ",";
                                spec_types2 += ",";
                            }
                            spec_types += ps.SpecimenType.PhraseText;
                            spec_types2 += ps.SpecimenType.PhraseId;  //
                            have_one = true;

                        }


                        if (ps.SamplingPoint.IsNull())  //07/31/2021  0 check sampleing point
                        {
                            update = true;

                            ps.SamplingPoint = m_SamplePoint;

                        }
                        if (ps.RaceDate.IsNull)
                        {
                            update = true;

                            ps.RaceDate = prc.RaceDate;
                        }
                        if (update)
                        {
                            EntityManager.Transaction.Add(ps);
                            EntityManager.Commit();
                        }

                    }

                    if (prc.SpecimenTypes != spec_types)
                    {

                        prc.SpecimenTypes = spec_types;
                        prc.SpecimenTypes2 = spec_types2;
                        EntityManager.Transaction.Add(prc);
                        EntityManager.Commit();
                        frm.SMMasterDetailGridRCSelection.RefreshRow(prc);


                    }




                }

               System.Threading.Thread.Sleep(200);


                foreach (PRaceCardExtended horse in RaceCardRCS)
                {
                    foreach (PSpecimenBase spec in horse.SpecimensWithCompleteCollectionData)
                    {
                        spec.RefreshDetailContent();

                    }
                    horse.RefreshDetailContent();
                    horse.SpecimensWithCompleteCollectionData.Refresh();
                    horse.SpecimensNonVoided.Refresh();
                }

                IQuery qryRC = EntityManager.CreateQuery(TableNames.PRaceCard);
                qryRC.AddEquals("SAMPLING_POINT", m_SamplePoint);
                qryRC.AddAnd();
                qryRC.AddEquals("RACE_ID", m_RaceID);
                qryRC.AddAnd();
                qryRC.AddEquals("RACE_NO", m_RaceNum);

                IEntityCollection RaceCardRC = EntityManager.Select(TableNames.PRaceCard, qryRC);

                frm.SelectedCollection.Data.Clear();
                frm.SelectedCollection.Publish(RaceCardRCS);
                frm.SelectedCollection.Data.Refresh();
                frm.SMMasterDetailGridRaceCard.GridData = RaceCardRC;
                frm.SMMasterDetailGridRCSelection.GridData = RaceCardRCS;
                frm.SMMasterDetailGridRCSelection.Refresh();
                frm.SMMasterDetailGridRCSelection.GridData.Reselect();
                frm.SMMasterDetailGridRCSelection.GridData.Refresh();
              
                    
        }

    }

}



